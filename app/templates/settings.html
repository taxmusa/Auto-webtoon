<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¤ì • - Webtoon Auto-Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.25rem; font-weight: 700; background: linear-gradient(135deg, var(--primary), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        main { max-width: 800px; margin: 2rem auto; padding: 0 1rem 3rem; }
        h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
        .page-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem; }

        .section-title { font-size: 1.1rem; font-weight: 700; margin: 2rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }
        .section-title:first-of-type { margin-top: 0; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 0.75rem; }
        .card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .card-header-icon { font-size: 1.3rem; }
        .card-header-title { font-weight: 600; font-size: 0.95rem; flex: 1; }

        label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.35rem; font-weight: 500; }
        input, select { width: 100%; padding: 0.6rem 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.82rem; }
        input:focus { outline: none; border-color: var(--primary); }
        input[type="password"] { font-family: monospace; letter-spacing: 1px; }
        input:disabled { opacity: 0.6; }

        .field-row { display: flex; gap: 0.5rem; align-items: flex-end; margin-bottom: 0.6rem; }
        .field-row .field { flex: 1; }
        .field-row .field-sm { flex: 0 0 auto; }

        .btn { padding: 0.5rem 0.85rem; border-radius: 6px; font-weight: 500; font-size: 0.8rem; border: none; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-sm { padding: 0.4rem 0.65rem; font-size: 0.75rem; }
        .btn-secondary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .status { display: inline-flex; align-items: center; gap: 0.2rem; font-size: 0.72rem; padding: 0.2rem 0.5rem; border-radius: 4px; white-space: nowrap; font-weight: 500; }
        .status-ok { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .status-err { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .status-warn { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status-off { background: rgba(148, 163, 184, 0.15); color: var(--text-muted); }

        .help { font-size: 0.72rem; color: var(--text-muted); margin-top: 0.2rem; line-height: 1.4; }
        .help a { color: var(--primary); }
        .back-link { color: var(--text-muted); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
        .back-link:hover { color: var(--text); }

        .collapse { display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }
        .collapse.open { display: block; }

        .info-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg); border-radius: 8px; }
        .info-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-input); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .info-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 0.85rem 1.25rem; border-radius: 8px; font-size: 0.85rem; color: white; animation: slideIn 0.3s ease; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-warn { background: var(--warning); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }
    </style>
</head>

<body>
    <header>
        <a href="/" class="logo" style="text-decoration: none;">ğŸ¨ Webtoon Auto-Generator</a>
        <a href="/" class="back-link">â† ë©”ì¸ìœ¼ë¡œ</a>
    </header>

    <main>
        <h1>âš™ï¸ ì„¤ì •</h1>
        <p class="page-desc">API í‚¤ì™€ SNS ì—°ê²°ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ëª¨ë“  ì„¤ì •ì€ .env íŒŒì¼ì— ì €ì¥ë˜ë©° ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</p>

        <!-- ============================================ -->
        <!-- ì„¹ì…˜ 1: SNS ë°œí–‰ ì—°ê²° -->
        <!-- ============================================ -->
        <div class="section-title">ğŸ“± SNS ë°œí–‰ ì—°ê²°</div>

        <!-- Instagram -->
        <div class="card">
            <div class="card-header">
                <span class="card-header-icon">ğŸ“¸</span>
                <span class="card-header-title">Instagram</span>
                <span id="ig-badge" class="status status-off">í™•ì¸ ì¤‘</span>
            </div>

            <!-- ì—°ê²° ìƒíƒœ -->
            <div class="info-row" style="margin-bottom:0.6rem;">
                <div class="info-avatar" id="ig-avatar"><span style="font-size:1.2rem;">ğŸ“·</span></div>
                <div style="flex:1;">
                    <div id="ig-name" style="font-weight:600; font-size:0.88rem;">í™•ì¸ ì¤‘...</div>
                    <div id="ig-detail" style="font-size:0.75rem; color:var(--text-muted);">ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <!-- í˜„ì¬ ì„¤ì •ê°’ (ë§ˆìŠ¤í‚¹) -->
            <div id="ig-current-values" style="display:none; margin-bottom:0.6rem;">
                <div class="field-row">
                    <div class="field">
                        <label>Access Token</label>
                        <input type="text" id="ig-token-preview" disabled style="font-size:0.75rem;">
                    </div>
                    <div class="field" style="max-width:200px;">
                        <label>User ID</label>
                        <input type="text" id="ig-userid-preview" disabled style="font-size:0.75rem;">
                    </div>
                    <div class="field-sm" style="padding-bottom:1px;">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary btn-sm" onclick="toggleCollapse('ig-setup')">ìˆ˜ì •</button>
                    </div>
                </div>
            </div>

            <!-- ì„¤ì •/ìˆ˜ì • í¼ (ì ‘ê¸°) -->
            <div id="ig-setup" class="collapse">
                <div style="background:linear-gradient(135deg,rgba(99,102,241,0.04),rgba(99,102,241,0.1)); border-radius:8px; padding:1rem;">
                    <div style="font-weight:600; font-size:0.85rem; margin-bottom:0.75rem;">ğŸ”§ Instagram ì—°ê²° ì„¤ì •</div>

                    <!-- Step 1 -->
                    <div style="margin-bottom:0.75rem; padding:0.6rem; background:var(--bg-card); border-radius:6px; border-left:3px solid var(--primary);">
                        <div style="font-weight:600; font-size:0.8rem; margin-bottom:0.4rem;">1. Facebook App ì •ë³´</div>
                        <div class="help" style="margin-bottom:0.4rem;">
                            <a href="https://developers.facebook.com/apps/" target="_blank">Facebook Developers</a> â†’ ì•± â†’ ì„¤ì • â†’ ê¸°ë³¸
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.4rem; margin-bottom:0.4rem;">
                            <input type="text" id="fb-app-id" placeholder="App ID" style="font-size:0.78rem; padding:0.45rem;">
                            <input type="password" id="fb-app-secret" placeholder="App Secret" style="font-size:0.78rem; padding:0.45rem;">
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="saveFacebookApp()" style="width:100%;">ğŸ’¾ ì €ì¥</button>
                    </div>

                    <!-- Step 2 -->
                    <div style="margin-bottom:0.75rem; padding:0.6rem; background:var(--bg-card); border-radius:6px; border-left:3px solid var(--warning);">
                        <div style="font-weight:600; font-size:0.8rem; margin-bottom:0.4rem;">2. ë‹¨ê¸° í† í° ë°œê¸‰</div>
                        <div class="help">
                            <a href="https://developers.facebook.com/tools/explorer/" target="_blank">Graph API Explorer</a> â†’ ì•± ì„ íƒ â†’ ì‚¬ìš©ì í† í° â†’ ê¶Œí•œ ì¶”ê°€
                            (<code style="font-size:0.68rem;">pages_show_list, pages_read_engagement, instagram_basic, instagram_content_publish, business_management</code>)
                            â†’ Generate Access Token â†’ ë³µì‚¬
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div style="padding:0.6rem; background:var(--bg-card); border-radius:6px; border-left:3px solid var(--success);">
                        <div style="font-weight:600; font-size:0.8rem; margin-bottom:0.4rem;">3. í† í° ë¶™ì—¬ë„£ê¸° â†’ ì˜êµ¬ í† í° ìë™ ë°œê¸‰</div>
                        <div class="help" style="margin-bottom:0.4rem;">ë³µì‚¬í•œ í† í°ì„ ë¶™ì—¬ë„£ìœ¼ë©´ ë§Œë£Œë˜ì§€ ì•ŠëŠ” ì˜êµ¬ í† í°ìœ¼ë¡œ ìë™ êµí™˜í•©ë‹ˆë‹¤.</div>
                        <div style="display:flex; gap:0.4rem;">
                            <input type="text" id="fb-short-token" placeholder="EAA... (í† í° ë¶™ì—¬ë„£ê¸°)" style="flex:1; font-size:0.78rem; padding:0.45rem;">
                            <button class="btn btn-success btn-sm" onclick="exchangeToken()" id="btn-exchange">ğŸ”„ ì˜êµ¬ í† í° ë°œê¸‰</button>
                        </div>
                        <div id="exchange-progress" style="display:none; margin-top:0.4rem; font-size:0.78rem; color:var(--text-muted);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloudinary -->
        <div class="card">
            <div class="card-header">
                <span class="card-header-icon">â˜ï¸</span>
                <span class="card-header-title">Cloudinary (ì´ë¯¸ì§€ í˜¸ìŠ¤íŒ…)</span>
                <span id="cloud-badge" class="status status-off">í™•ì¸ ì¤‘</span>
            </div>

            <div id="cloud-current" style="margin-bottom:0.6rem;">
                <div class="field-row">
                    <div class="field">
                        <label>Cloud Name</label>
                        <input type="text" id="cloud-name" placeholder="ë¯¸ì„¤ì •" style="font-size:0.78rem;">
                    </div>
                    <div class="field">
                        <label>API Key</label>
                        <input type="text" id="cloud-key" placeholder="ë¯¸ì„¤ì •" style="font-size:0.78rem;">
                    </div>
                    <div class="field">
                        <label>API Secret</label>
                        <input type="password" id="cloud-secret" placeholder="ë¯¸ì„¤ì •" style="font-size:0.78rem;">
                    </div>
                </div>
                <div style="display:flex; gap:0.4rem; margin-top:0.4rem;">
                    <button class="btn btn-primary btn-sm" onclick="saveCloudinary()" style="flex:1;">ğŸ’¾ ì €ì¥</button>
                    <button class="btn btn-secondary btn-sm" onclick="verifyCloudinary()">ğŸ” ì—°ê²° í™•ì¸</button>
                </div>
            </div>

            <div class="help">ë°œí–‰ ì‹œ ë¡œì»¬ ì´ë¯¸ì§€ë¥¼ ê³µê°œ URLë¡œ ë³€í™˜í•©ë‹ˆë‹¤. Instagram ë°œí–‰ì— í•„ìˆ˜. Â· <a href="https://cloudinary.com/console" target="_blank">Cloudinary Dashboard</a></div>
        </div>

        <!-- ============================================ -->
        <!-- ì„¹ì…˜ 2: AI API í‚¤ -->
        <!-- ============================================ -->
        <div class="section-title">ğŸ¤– AI API í‚¤</div>

        <!-- Gemini -->
        <div class="card">
            <div class="card-header">
                <span class="card-header-icon">ğŸ¤–</span>
                <span class="card-header-title">Google Gemini</span>
                <span id="gemini-badge" class="status status-off">í™•ì¸ ì¤‘</span>
            </div>
            <div class="field-row">
                <div class="field">
                    <label>API Key</label>
                    <input type="password" id="gemini-key" placeholder="AIza...">
                </div>
                <div class="field-sm" style="padding-bottom:1px;">
                    <label>&nbsp;</label>
                    <div style="display:flex; gap:0.3rem;">
                        <button class="btn btn-secondary btn-sm" onclick="togglePw('gemini-key')">ğŸ‘</button>
                        <button class="btn btn-primary btn-sm" onclick="saveApiKey('GEMINI_API_KEY','gemini-key','gemini-badge')">ì €ì¥</button>
                    </div>
                </div>
            </div>
            <div class="help">ìŠ¤í† ë¦¬Â·ìº¡ì…˜ ìƒì„± + ì´ë¯¸ì§€ ìƒì„±(Nano Banana)ì˜ í•µì‹¬ API Â· <a href="https://aistudio.google.com/apikey" target="_blank">ë°œê¸‰ ë§í¬</a></div>
        </div>
    </main>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // ============================================
        // ìœ í‹¸
        // ============================================
        function togglePw(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        function toggleCollapse(id) {
            document.getElementById(id).classList.toggle('open');
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => {
                t.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }

        function setBadge(id, type, text) {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = 'status status-' + type;
            el.innerText = text;
        }

        // ì…ë ¥ ê²€ì¦ ìœ í‹¸
        function validateInput(value, rules) {
            if (rules.required && !value) return rules.requiredMsg || 'í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.';
            if (rules.minLength && value.length < rules.minLength) return `ìµœì†Œ ${rules.minLength}ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
            if (rules.pattern && !rules.pattern.test(value)) return rules.patternMsg || 'í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            return null;
        }

        // ì—ëŸ¬ ì§„ë‹¨ í† ìŠ¤íŠ¸ (ì—ëŸ¬ ë°œìƒ ì‹œ ì›ì¸+í•´ê²° ë°©ë²• í‘œì‹œ)
        function showDiagnosticToast(diagnosis) {
            if (!diagnosis) return;
            const icons = {
                auth_expired: 'ğŸ”‘', auth_invalid: 'ğŸš«', credits: 'ğŸ’°',
                rate_limit: 'â±ï¸', network: 'ğŸŒ', server: 'âš™ï¸',
                not_configured: 'ğŸ“‹', unknown: 'â“'
            };
            const colors = {
                auth_expired: '#e74c3c', auth_invalid: '#e74c3c',
                credits: '#e67e22', rate_limit: '#f39c12',
                network: '#95a5a6', server: '#95a5a6',
                not_configured: '#3498db', unknown: '#7f8c8d'
            };
            const icon = icons[diagnosis.type] || 'â“';
            const color = colors[diagnosis.type] || '#7f8c8d';
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed; top:80px; right:24px; z-index:99999; max-width:420px; animation:slideIn 0.3s ease;`;
            toast.innerHTML = `
                <div style="background:${color}; color:#fff; padding:16px 20px; border-radius:12px;
                            box-shadow:0 8px 32px rgba(0,0,0,0.3); font-size:0.88rem;">
                    <div style="font-weight:700; font-size:1rem; margin-bottom:8px;">${icon} ${diagnosis.message}</div>
                    <div style="opacity:0.9; margin-bottom:12px; line-height:1.5;">${diagnosis.action}</div>
                    ${diagnosis.detail ? `<details style="opacity:0.7; font-size:0.78rem;"><summary style="cursor:pointer;">ê¸°ìˆ ì  ìƒì„¸</summary><div style="margin-top:4px;">${diagnosis.detail}</div></details>` : ''}
                    <div style="margin-top:8px;"><button onclick="this.closest('div').parentElement.remove()" style="background:rgba(255,255,255,0.15); color:#fff; border:none; padding:6px 16px; border-radius:6px; cursor:pointer;">ë‹«ê¸°</button></div>
                </div>`;
            document.body.appendChild(toast);
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 15000);
        }

        // ============================================
        // ì´ˆê¸° ë¡œë“œ
        // ============================================
        async function initPage() {
            // ë¡œë”© ì¤‘ ëª¨ë“  ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
            const btns = document.querySelectorAll('.btn');
            btns.forEach(b => b.disabled = true);
            try {
                await Promise.all([loadInstagram(), loadCloudinary(), loadGemini()]);
            } finally {
                btns.forEach(b => b.disabled = false);
            }
        }

        // ============================================
        // Instagram
        // ============================================
        async function loadInstagram() {
            try {
                // ìƒíƒœ ì¡°íšŒ
                const [statusRes, verifyRes] = await Promise.all([
                    fetch('/api/sns/status'),
                    fetch('/api/sns/instagram/verify')
                ]);
                const status = await statusRes.json();
                const verify = await verifyRes.json();

                // Facebook App ID ë¯¸ë¦¬ ì±„ìš°ê¸°
                if (status.facebook_app?.app_id) {
                    document.getElementById('fb-app-id').value = status.facebook_app.app_id;
                }

                // í˜„ì¬ ê°’ í‘œì‹œ
                const valuesArea = document.getElementById('ig-current-values');
                if (status.instagram?.configured) {
                    valuesArea.style.display = 'block';
                    document.getElementById('ig-token-preview').value = status.instagram.token_preview || '***';
                    document.getElementById('ig-userid-preview').value = status.instagram.user_id || '';
                }

                if (verify.ok) {
                    const username = verify.username || '';
                    document.getElementById('ig-name').innerText = username ? `@${username}` : 'ì—°ê²°ë¨';

                    let detail = verify.permanent ? 'ğŸ”’ ì˜êµ¬ í† í°' : 'â±ï¸ ì¥ê¸° í† í°';
                    if (verify.token_type) detail += ` (${verify.token_type})`;
                    if (!verify.permanent && verify.expires_at > 0) {
                        detail += ` Â· ë§Œë£Œ: ${new Date(verify.expires_at * 1000).toLocaleDateString('ko-KR')}`;
                    }
                    document.getElementById('ig-detail').innerText = detail;
                    setBadge('ig-badge', 'ok', 'âœ“ ì—°ê²°ë¨');

                    if (verify.profile_picture) {
                        document.getElementById('ig-avatar').innerHTML =
                            `<img src="${verify.profile_picture}">`;
                    }

                } else {
                    document.getElementById('ig-name').innerText = 'ë¯¸ì—°ê²°';
                    document.getElementById('ig-detail').innerText = verify.error || 'ì•„ë˜ ì„¤ì •ì—ì„œ ì—°ê²°í•´ì£¼ì„¸ìš”';
                    setBadge('ig-badge', 'err', 'âœ— ë¯¸ì—°ê²°');
                    // ë¯¸ì—°ê²°ì´ë©´ ì„¤ì • í¼ ìë™ ì—´ê¸°
                    document.getElementById('ig-setup').classList.add('open');
                }
            } catch(e) {
                document.getElementById('ig-name').innerText = 'í™•ì¸ ì‹¤íŒ¨';
                document.getElementById('ig-detail').innerText = e.message;
                setBadge('ig-badge', 'err', 'ì˜¤ë¥˜');
            }
        }

        async function saveFacebookApp() {
            const appId = document.getElementById('fb-app-id').value.trim();
            const appSecret = document.getElementById('fb-app-secret').value.trim();
            if (!appId || !appSecret) { showToast('App IDì™€ App Secretì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            const idErr = validateInput(appId, { pattern: /^\d+$/, patternMsg: 'App IDëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.' });
            if (idErr) { showToast(idErr, 'error'); return; }
            const secretErr = validateInput(appSecret, { minLength: 10 });
            if (secretErr) { showToast('App Secret: ' + secretErr, 'error'); return; }
            const btn = event?.target;
            if (btn) { btn.disabled = true; btn.innerText = 'â³ ì €ì¥ ì¤‘...'; }
            try {
                const res = await fetch('/api/sns/facebook/save-app', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({app_id: appId, app_secret: appSecret})
                });
                if (!res.ok) { showToast(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`, 'error'); return; }
                const data = await res.json();
                if (data.ok) showToast('âœ“ Facebook App ì •ë³´ ì €ì¥ ì™„ë£Œ');
                else showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
            } catch(e) { showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error'); }
            finally { if (btn) { btn.disabled = false; btn.innerText = 'ğŸ’¾ ì €ì¥'; } }
        }

        async function exchangeToken() {
            const token = document.getElementById('fb-short-token').value.trim();
            if (!token) { showToast('í† í°ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.', 'warn'); return; }
            const tokenErr = validateInput(token, { minLength: 20 });
            if (tokenErr) { showToast('í† í°ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í† í°ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.', 'error'); return; }

            const appId = document.getElementById('fb-app-id').value.trim();
            const appSecret = document.getElementById('fb-app-secret').value.trim();
            if (appId && appSecret) {
                try {
                    const saveRes = await fetch('/api/sns/facebook/save-app', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({app_id: appId, app_secret: appSecret})
                    });
                    if (!saveRes.ok) { showToast('App ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜', 'warn'); }
                } catch(e) { /* ê³„ì† ì§„í–‰ */ }
            }

            const btn = document.getElementById('btn-exchange');
            const progress = document.getElementById('exchange-progress');
            btn.disabled = true;
            btn.innerText = 'â³ êµí™˜ ì¤‘...';
            progress.style.display = 'block';
            progress.innerHTML = 'ì¥ê¸° í† í°ìœ¼ë¡œ êµí™˜ ì¤‘...';

            try {
                const res = await fetch('/api/sns/facebook/exchange-token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({short_token: token})
                });
                if (!res.ok) {
                    progress.innerHTML = `<span style="color:var(--danger);">ì„œë²„ ì˜¤ë¥˜ (${res.status})</span>`;
                    return;
                }
                const data = await res.json();
                if (data.ok) {
                    let msg = `<span style="color:var(--success); font-weight:600;">âœ“ ${data.message}</span>`;
                    if (data.instagram_username) msg += `<br>Instagram: <b>@${data.instagram_username}</b>`;
                    if (data.permanent) msg += `<br><span style="color:var(--success);">ğŸ”’ ë§Œë£Œë˜ì§€ ì•ŠëŠ” ì˜êµ¬ í† í°!</span>`;
                    if (data.page_name) msg += `<br>í˜ì´ì§€: ${data.page_name}`;
                    progress.innerHTML = msg;
                    setTimeout(() => loadInstagram(), 1500);
                } else {
                    progress.innerHTML = `<span style="color:var(--danger);">âœ— ${data.error}</span>`;
                    if (data.step === 0) progress.innerHTML += '<br>â†’ ìœ„ì—ì„œ App ID/Secretì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.';
                }
            } catch(e) {
                progress.innerHTML = `<span style="color:var(--danger);">ì˜¤ë¥˜: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerText = 'ğŸ”„ ì˜êµ¬ í† í° ë°œê¸‰';
            }
        }

        // ============================================
        // Cloudinary
        // ============================================
        async function loadCloudinary() {
            try {
                const res = await fetch('/api/sns/status');
                const status = await res.json();
                if (status.cloudinary?.configured) {
                    document.getElementById('cloud-name').value = status.cloudinary.cloud_name || '';
                    // ë§ˆìŠ¤í‚¹ëœ í‚¤ ê°’ì„ placeholderì— í‘œì‹œ
                    const keyPreview = status.cloudinary.api_key_preview || 'ì„¤ì •ë¨';
                    const secretPreview = status.cloudinary.api_secret_preview || 'ì„¤ì •ë¨';
                    document.getElementById('cloud-key').placeholder = `í˜„ì¬: ${keyPreview} (ë³€ê²½í•˜ë ¤ë©´ ìƒˆ ê°’ ì…ë ¥)`;
                    document.getElementById('cloud-secret').placeholder = `í˜„ì¬: ${secretPreview} (ë³€ê²½í•˜ë ¤ë©´ ìƒˆ ê°’ ì…ë ¥)`;
                    verifyCloudinary();
                } else {
                    setBadge('cloud-badge', 'err', 'âœ— ë¯¸ì„¤ì •');
                }
            } catch(e) {
                setBadge('cloud-badge', 'err', 'ì˜¤ë¥˜');
            }
        }

        async function verifyCloudinary() {
            setBadge('cloud-badge', 'off', 'í™•ì¸ ì¤‘...');
            try {
                const res = await fetch('/api/sns/cloudinary/verify');
                const data = await res.json();
                if (data.ok) {
                    setBadge('cloud-badge', 'ok', 'âœ“ ì—°ê²°ë¨');
                } else {
                    setBadge('cloud-badge', 'err', 'âœ— ' + (data.error || 'ì¸ì¦ ì‹¤íŒ¨'));
                }
            } catch(e) {
                setBadge('cloud-badge', 'err', 'âœ— ì˜¤ë¥˜');
            }
        }

        async function saveCloudinary() {
            const name = document.getElementById('cloud-name').value.trim();
            const key = document.getElementById('cloud-key').value.trim();
            const secret = document.getElementById('cloud-secret').value.trim();
            if (!name) { showToast('Cloud Nameì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            const body = { cloud_name: name };
            if (key) body.api_key = key;
            if (secret) body.api_secret = secret;
            if (!key && !secret) {
                body.api_key = '';
                body.api_secret = '';
            }
            const btn = event?.target;
            if (btn) { btn.disabled = true; btn.innerText = 'â³ ì €ì¥ ì¤‘...'; }
            try {
                const res = await fetch('/api/sns/cloudinary/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (!res.ok) { showToast(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`, 'error'); return; }
                const data = await res.json();
                if (data.ok) {
                    showToast('âœ“ Cloudinary ì„¤ì • ì €ì¥ ì™„ë£Œ');
                    verifyCloudinary();
                } else { showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error'); }
            } catch(e) { showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error'); }
            finally { if (btn) { btn.disabled = false; btn.innerText = 'ğŸ’¾ ì €ì¥'; } }
        }

        // ============================================
        // Gemini API Key
        // ============================================
        async function loadGemini() {
            try {
                const res = await fetch('/api/sns/apikey/status');
                const data = await res.json();
                if (data.gemini?.configured) {
                    document.getElementById('gemini-key').placeholder = data.gemini.preview + ' (ì„¤ì •ë¨)';
                    setBadge('gemini-badge', 'ok', 'âœ“ ì„¤ì •ë¨');
                } else {
                    setBadge('gemini-badge', 'err', 'âœ— ë¯¸ì„¤ì •');
                }
            } catch(e) {
                setBadge('gemini-badge', 'err', 'ì˜¤ë¥˜');
            }
        }

        async function saveApiKey(envKey, inputId, badgeId) {
            const val = document.getElementById(inputId).value.trim();
            if (!val) { showToast('í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warn'); return; }
            // Gemini í‚¤ í˜•ì‹ ê²€ì¦
            if (envKey === 'GEMINI_API_KEY') {
                if (!val.startsWith('AIza')) { showToast('Gemini API í‚¤ëŠ” "AIza"ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. ì˜¬ë°”ë¥¸ í‚¤ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warn'); return; }
                if (val.length < 30) { showToast('Gemini API í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.', 'error'); return; }
            }
            const btn = event?.target;
            if (btn) { btn.disabled = true; btn.innerText = 'â³'; }
            try {
                const res = await fetch('/api/sns/apikey/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({key: envKey, value: val})
                });
                if (!res.ok) { showToast(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`, 'error'); return; }
                const data = await res.json();
                if (data.ok) {
                    document.getElementById(inputId).value = '';
                    showToast('âœ“ API í‚¤ ì €ì¥ ì™„ë£Œ');
                    loadGemini();
                } else { showToast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error'); }
            } catch(e) { showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error'); }
            finally { if (btn) { btn.disabled = false; btn.innerText = 'ì €ì¥'; } }
        }

        // ============================================
        // í˜ì´ì§€ ë¡œë“œ
        // ============================================
        initPage();
    </script>
</body>
</html>
