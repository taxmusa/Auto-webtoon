<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Progress Steps */
        .progress-bar {
            background: var(--bg-card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step:hover {
            color: var(--primary);
        }

        .step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step.done {
            color: var(--success);
        }

        .step.done:hover {
            color: var(--primary);
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step.active .step-num {
            background: var(--primary);
            color: white;
        }

        .step.done .step-num {
            background: var(--success);
            color: white;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 0.5rem;
        }

        .step.done+.step-line {
            background: var(--success);
        }

        /* Main Content */
        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Step Content - Page View Behavior */
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .card-desc {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Outline Button (ë‹¤í¬ í…Œë§ˆ í†µì¼) */
        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-outline:hover {
            background: var(--bg-input);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Small Button */
        .btn-sm {
            padding: 0.4rem 0.85rem;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        /* File Input ë‹¤í¬ í…Œë§ˆ */
        input[type="file"] {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            padding: 0.5rem;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.4rem 0.85rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 0.75rem;
            transition: all 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background: var(--bg-input);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ëª¨ë‹¬ ë‚´ë¶€ ë‹¤í¬ í…ìŠ¤íŠ¸ í†µì¼ */
        .modal-content-dark h3,
        .modal-content-dark h4,
        .modal-content-dark h5,
        .modal-content-dark label,
        .modal-content-dark p {
            color: var(--text);
        }


        /* Mode Selection */
        .mode-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .mode-card {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--primary);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .mode-card.selected {
            background: rgba(99, 102, 241, 0.1);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .mode-title {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .mode-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Scene Cards */
        .scene-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .scene-num {
            font-weight: 700;
            color: var(--primary);
        }

        .scene-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--warning);
            color: black;
        }

        /* Character Card */
        .char-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .char-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .char-avatar {
            width: 60px;
            height: 60px;
            background: var(--bg-input);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .char-info {
            flex: 1;
        }

        .char-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .char-role {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Rule Warning */
        .rule-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 3px solid var(--warning);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #ff9800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-container {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* --- Style System 2.0 UI Improvements --- */
        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .style-select-card {
            background: var(--bg-card);
            /* Keep card bg */
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
        }

        .style-select-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .style-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .style-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .selected-style-display {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            font-weight: 600;
            color: var(--primary);
            /* Highlight color */
            text-align: center;
            transition: all 0.2s;
        }

        .selected-style-display:hover {
            background: var(--bg);
        }

        /* Modal Dark Theme */
        .modal-content-dark {
            background: var(--bg-card) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
        }

        .modal-header-dark {
            border-bottom: 1px solid var(--border) !important;
        }

        .style-list-dark {
            border-right: 1px solid var(--border) !important;
        }

        .style-item-dark {
            border-bottom: 1px solid var(--border) !important;
            color: var(--text) !important;
            transition: background 0.1s;
        }

        .style-item-dark:hover {
            background: var(--bg-input) !important;
        }

        .preview-box {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .preview-box:hover {
            border-color: var(--text-muted);
        }

        .tab.active {
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
    </style>
</head>

<body>
    <header>
        <a href="/" class="logo" style="text-decoration: none;">ğŸ¨ Tax Webtoon Auto-Generator Pro</a>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span id="login-status" style="font-size: 0.875rem; color: var(--text-muted);">Guest User</span>
            <a href="/settings" style="color: var(--text-muted); text-decoration: none;">âš™ï¸ ì„¤ì •</a>
        </div>
    </header>

    <div class="progress-bar">
        <div class="steps">
            <div class="step active" data-step="1" onclick="navigateToStep(1)"><span class="step-num">1</span> ì‹œì‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="2" onclick="navigateToStep(2)"><span class="step-num">2</span> ìë£Œìˆ˜ì§‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="3" onclick="navigateToStep(3)"><span class="step-num">3</span> ìŠ¤í† ë¦¬</div>
            <div class="step-line"></div>
            <div class="step" data-step="4" onclick="navigateToStep(4)"><span class="step-num">4</span> ì´ë¯¸ì§€</div>
            <div class="step-line"></div>
            <div class="step" data-step="5" onclick="navigateToStep(5)"><span class="step-num">5</span> í¸ì§‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="6" onclick="navigateToStep(6)"><span class="step-num">6</span> ìº¡ì…˜</div>
            <div class="step-line"></div>
            <div class="step" data-step="7" onclick="navigateToStep(7)"><span class="step-num">7</span> ë°œí–‰</div>
        </div>
    </div>

    <main>
        <div class="step-content active" id="step-1">
            <div class="card">
                <h2 class="card-title">ğŸš€ ì›Œí¬í”Œë¡œìš° ì‹œì‘</h2>
                <!-- Mode Cards Hidden (Optional: Can keep them if needed, but user didn't ask to remove) -->
                <div class="mode-cards" style="margin-bottom: 2rem;">
                    <div class="mode-card selected" data-mode="auto" onclick="selectMode('auto')">
                        <div class="mode-icon">ğŸ¤–</div>
                        <div class="mode-title">ìë™ ëª¨ë“œ</div>
                        <div class="mode-desc">í‚¤ì›Œë“œë§Œ ì…ë ¥í•˜ë©´ AIê°€ ìë£Œ ìˆ˜ì§‘ë¶€í„°ìŠ¤í† ë¦¬ê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="mode-card" data-mode="manual" onclick="selectMode('manual')">
                        <div class="mode-icon">âœï¸</div>
                        <div class="mode-title">ìˆ˜ë™ ëª¨ë“œ</div>
                        <div class="mode-desc">ì§ì ‘ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</div>
                    </div>
                </div>

                <div id="keyword-input-area">
                    <div class="form-group">
                        <label for="keyword">ë¬´ì—‡ì— ëŒ€í•´ ì„¤ëª…í•˜ëŠ” ì›¹íˆ°ì„ ë§Œë“¤ê¹Œìš”?</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="keyword" placeholder="ì˜ˆ: ì¦ì—¬ì„¸ ì—†ì´ ì¦ì—¬í•˜ëŠ” ë²•, ìœ¡ì•„íœ´ì§ ì‹ ì²­"
                                onkeyup="if(event.key==='Enter') startWorkflow()">
                        </div>

                        <!-- AI Model Selection -->
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                            <span>ì‚¬ìš©í•  AI ëª¨ë¸:</span>
                            <select id="ai-model-select"
                                style="padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                                <option value="gemini-3-pro-preview">Gemini 3.0 Pro (Preview/ìµœê³ ì„±ëŠ¥)</option>
                                <option value="gemini-3-flash-preview" selected>Gemini 3.0 Flash (Preview/ë¹ ë¦„)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Stable/ê³ ì„±ëŠ¥)</option>
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash (Stable/ê· í˜•)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="manual-input-area" style="display : none;">
                    <div class="form-group">
                        <label for="manual-script">ì‹œë‚˜ë¦¬ì˜¤ ë˜ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥</label>
                        <textarea id="manual-script" rows="5" placeholder="ì§ì ‘ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ë‚˜ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>

                <!-- Smart Analysis Result Removed -->
            </div>

            <div class="actions">
                <div></div>
                <!-- Initial Start Button Hidden when Analysis Shown -->
                <button class="btn btn-primary" id="btn-start-next" onclick="startWorkflow()"
                    style="display: block; width: 100%;">
                    ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€
                </button>
            </div>
        </div>

        <!-- Step 2: ìë£Œ ìˆ˜ì§‘ ë° ì¶”ì²œ -->
        <div class="step-content" id="step-2">
            <div class="loading" id="loading-data">
                <div class="spinner"></div>
                <div>AIê°€ ê´€ë ¨ ë²•ë ¹ê³¼ ìƒì„¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div id="data-review-area" style="display: none;">
                <div class="card">
                    <h2 class="card-title">ğŸ“š ìˆ˜ì§‘ëœ ìƒì„¸ ì •ë³´</h2>
                    <p class="card-desc">AIê°€ í‚¤ì›Œë“œì— ë§ì¶° ìˆ˜ì§‘í•œ ë‚´ìš©ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ë³¸ë¬¸ì„ ìˆ˜ì •í•˜ê±°ë‚˜ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    <div id="data-container"></div>
                    <button class="btn btn-secondary" style="margin-top: 1rem; width: 100%;"
                        onclick="openAddDataModal()">+ ì •ë³´ í•­ëª© ì¶”ê°€</button>
                </div>

                <!-- AI ë¶„í•  ì¶”ì²œ -->
                <div class="card"
                    style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(74, 144, 226, 0.15)); border: 1px solid var(--primary);">
                    <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">ğŸª„ AI ì‹œí€€ìŠ¤ ì¶”ì²œ
                    </h3>
                    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">ìˆ˜ì§‘ëœ ì •ë³´ì˜ ì–‘ì„ ë¶„ì„í–ˆì„ ë•Œ,
                        ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì„±ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <label style="font-weight: 600;">ì´ ì œì‘ ì”¬(Scene) ê°œìˆ˜</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <input type="number" id="total-scene-count" value="8"
                                    style="width: 80px; text-align: center; font-size: 1.25rem;">
                                <span style="font-size: 0.875rem; color: var(--text-muted);">ì¶”ì²œ: <b
                                        id="ai-rec-scenes">8</b>ê°œ</span>
                            </div>
                        </div>
                        <div>
                            <label style="font-weight: 600;">ì‹œë¦¬ì¦ˆ ë¶„í•  (ì¸ìŠ¤íƒ€ ìºëŸ¬ì…€ìš©)</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <input type="text" id="series-split" value="8" placeholder="ì˜ˆ: 8,7 (8ì¥+7ì¥)"
                                    style="width: 120px; text-align: center;">
                                <span style="font-size: 0.875rem; color: var(--text-muted);">ì¶”ì²œ: <b
                                        id="ai-rec-split">ë‹¨ì¼</b></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions" id="data-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(1)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="confirmData()">ìŠ¤í† ë¦¬ êµ¬ì„± í™•ì¸ â†’</button>
            </div>
        </div>

        <!-- Step 3: ìŠ¤í† ë¦¬ ë° ìºë¦­í„° ê´€ë¦¬ -->
        <div class="step-content" id="step-3">
            <div class="loading" id="loading-story">
                <div class="spinner"></div>
                <div>ë§ì¶¤í˜• ìŠ¤í† ë¦¬ë¥¼ êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>

            <div id="story-review-area" style="display: none;">
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="btn btn-secondary btn-sm" onclick="openStoryHistoryModal()">ğŸ“‚ ì´ì „ ìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
                        (History)</button>
                </div>
                <!-- ìºë¦­í„° í”„ë¡œí•„ ì„¹ì…˜ -->
                <div class="card">
                    <h2 class="card-title">ğŸ‘¥ ë“±ì¥ì¸ë¬¼ í”„ë¡œí•„</h2>
                    <div id="character-profiles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <!-- Character Profile Cards will be injected here -->
                    </div>
                </div>

                <!-- ìŠ¤í† ë¦¬ ì”¬ ì„¹ì…˜ -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="card-title" style="margin-bottom: 0;">ğŸ“– ì”¬ ê²€í†  ë° ê·œì¹™ í™•ì¸</h2>
                        <div style="font-size: 0.75rem; color: var(--text-muted);" id="rule-status">ëŒ€ì‚¬ 20ì / ë§í’ì„  2ê°œ ì¤€ìˆ˜ ì¤‘
                        </div>
                    </div>
                    <div id="scenes-container"></div>
                </div>
            </div>

            <div class="actions" id="story-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(2)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="approveScenes()">ì‚¬ìš©ì ì •ì˜ ë ˆì´ì•„ì›ƒ/ìŠ¤íƒ€ì¼ ì„¤ì • â†’</button>
            </div>
        </div>

        <!-- Step 4: ìƒì„¸ ì„¤ì • (Font, Style, Layout, Ratio, Model) -->
        <div class="step-content" id="step-4">
            <div class="card">
                <h2 class="card-title">âš™ï¸ ê³ ë„í™”ëœ ì œì‘ ì„¤ì •</h2>

                <div class="tab-container">
                    <div class="tab active" onclick="switchSettingTab('image')">ê·¸ë¦¼ ìŠ¤íƒ€ì¼</div>
                    <div class="tab" onclick="switchSettingTab('text')">í…ìŠ¤íŠ¸ & í°íŠ¸</div>
                    <div class="tab" onclick="switchSettingTab('layout')">ì¥ë©´ & ë¹„ìœ¨</div>
                </div>

                <!-- Image Settings Tab (Style System 2.0) -->
                <div id="setting-tab-image" class="tab-content active">
                    <!-- 1. Style Selection Grid -->
                    <div class="style-grid">
                        <!-- Character Style -->
                        <div class="style-select-card">
                            <div class="style-header">
                                <span class="style-title">ğŸ§‘ ì¸ë¬¼ ìŠ¤íƒ€ì¼</span>
                                <button class="btn btn-sm btn-outline"
                                    onclick="openStyleManager('character')">ì„¤ì •</button>
                            </div>
                            <div id="selected-char-style" class="selected-style-display">
                                ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Webtoon)
                            </div>
                        </div>

                        <!-- Background Style -->
                        <div class="style-select-card">
                            <div class="style-header">
                                <span class="style-title">ğŸ™ï¸ ë°°ê²½ ìŠ¤íƒ€ì¼</span>
                                <button class="btn btn-sm btn-outline"
                                    onclick="openStyleManager('background')">ì„¤ì •</button>
                            </div>
                            <div id="selected-bg-style" class="selected-style-display">
                                ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Modern Office)
                            </div>
                        </div>
                    </div>

                    <!-- 2. Model Selection -->
                    <div class="form-group">
                        <label style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem;">ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸</label>
                        <select id="image-model" style="padding: 1rem;">
                            <optgroup label="OpenAI">
                                <option value="gpt-image-1-mini" selected>GPT Image 1 Mini (ê°€ì„±ë¹„)</option>
                                <option value="gpt-image-1">GPT Image 1 (ê· í˜•)</option>
                                <option value="gpt-image-1.5">GPT Image 1.5 (ê³ í’ˆì§ˆ)</option>
                                <option value="dall-e-3">DALL-E 3</option>
                            </optgroup>
                            <optgroup label="Google">
                                <option value="nano-banana">Nano Banana (Flash)</option>
                                <option value="nano-banana-pro">Nano Banana Pro</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- 3. Preview Area -->
                    <div class="preview-section"
                        style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                        <h4
                            style="margin-bottom: 1rem; font-size: 1.1rem; display:flex; align-items:center; gap:0.5rem;">
                            ğŸ” ìŠ¤íƒ€ì¼ ë¯¸ë¦¬ë³´ê¸° <span
                                style="font-size:0.8rem; color:var(--text-muted); font-weight:normal;">(Low
                                Quality)</span>
                        </h4>
                        <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                            <div id="preview-image-container" class="preview-box" style="width: 240px; height: 240px;">
                                <div style="text-align:center;">
                                    <div style="font-size: 2.5rem; margin-bottom:0.5rem;">ğŸ–¼ï¸</div>
                                    <div style="font-size: 0.9rem;">ì´ë¯¸ì§€ ì—†ìŒ</div>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <p
                                    style="font-size: 0.95rem; color: var(--text-muted); margin-top: 0; line-height: 1.6;">
                                    í˜„ì¬ ì„ íƒëœ ìŠ¤íƒ€ì¼ ì¡°í•©ìœ¼ë¡œ ìƒ˜í”Œ ì´ë¯¸ì§€ë¥¼ 1ì¥ ìƒì„±í•©ë‹ˆë‹¤.<br>
                                    <span style="font-size: 0.85rem; opacity: 0.8;">* ì‹¤ì œ ìƒì„± ê²°ê³¼ë¬¼ë³´ë‹¤ í’ˆì§ˆì´ ë‚®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                                </p>
                                <button class="btn btn-secondary" onclick="generatePreview()" id="btn-generate-preview"
                                    style="margin-top: 1rem;">
                                    ìƒ˜í”Œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Manual Prompt Edit -->
                    <div class="manual-edit-section" style="margin-top: 2rem;">
                        <details
                            style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--text); padding: 0.5rem;">âœï¸
                                í”„ë¡¬í”„íŠ¸ ìˆ˜ë™ í¸ì§‘ (ê³ ê¸‰)</summary>
                            <div style="padding: 1rem; border-top: 1px solid var(--border); margin-top: 0.5rem;">
                                <div class="form-group">
                                    <label>ì¸ë¬¼ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸</label>
                                    <textarea id="manual-char-prompt" rows="3" placeholder="ìë™ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”..."
                                        style="font-family: monospace; font-size: 0.9rem;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>ë°°ê²½ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸</label>
                                    <textarea id="manual-bg-prompt" rows="3" placeholder="ìë™ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”..."
                                        style="font-family: monospace; font-size: 0.9rem;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>ì¶”ê°€ ì§€ì‹œì‚¬í•­ (Negative Prompt ë“±)</label>
                                    <input type="text" id="manual-additional"
                                        placeholder="ì˜ˆ: text, watermark, ugly, deformed">
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn btn-sm btn-outline" onclick="applyManualOverrides()">ì ìš©í•˜ì—¬ ë‹¤ì‹œ
                                        ë¯¸ë¦¬ë³´ê¸°</button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Text Settings Tab -->
                <div id="setting-tab-text" class="tab-content" style="display: none;">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>í°íŠ¸ ì„ íƒ</label>
                            <select id="font-family">
                                <option value="NanumGothic">ë‚˜ëˆ”ê³ ë”• (ê¸°ë³¸)</option>
                                <option value="Bamin">ë°°ë¯¼ì²´ (ìš°ì•„í•œí˜•ì œë“¤)</option>
                                <option value="Malgun">ë§‘ì€ê³ ë”•</option>
                                <option value="Cafe24">Cafe24</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ëŒ€ì‚¬ ê°€ë…ì„± ì˜µì…˜</label>
                            <select id="dialogue-placement">
                                <option value="bubble">ë§í’ì„  (ì¹œê·¼í•¨)</option>
                                <option value="subtitle">í•˜ë‹¨ ìë§‰ (ê°€ë…ì„± ìš°ìˆ˜)</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ëŒ€ì‚¬ í¬ê¸°</label>
                            <input type="range" id="font-size-dialogue" min="18" max="36" value="24"
                                oninput="document.getElementById('fs-d-val').innerText=this.value+'px'">
                            <span id="fs-d-val">24px</span>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ë ˆì´ì…˜ í¬ê¸°</label>
                            <input type="range" id="font-size-narration" min="16" max="30" value="20"
                                oninput="document.getElementById('fs-n-val').innerText=this.value+'px'">
                            <span id="fs-n-val">20px</span>
                        </div>
                    </div>
                </div>

                <!-- Layout Settings Tab -->
                <div id="setting-tab-layout" class="tab-content" style="display: none;">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ì´ë¯¸ì§€ ë¹„ìœ¨</label>
                            <select id="aspect-ratio">
                                <option value="4:5" selected>1080x1350 (ì¸ìŠ¤íƒ€ ì„¸ë¡œ ê¶Œì¥)</option>
                                <option value="1:1">1080x1080 (ì •ì‚¬ê°í˜•)</option>
                                <option value="9:16">1080x1920 (ë¦´ìŠ¤/ìŠ¤í† ë¦¬ìš©)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ì§€ ë²ˆí˜¸ ìœ„ì¹˜</label>
                            <select id="page-number-position">
                                <option value="bottom_right">ìš°ì¸¡ í•˜ë‹¨ (ê¸°ë³¸)</option>
                                <option value="bottom_center">ì¤‘ì•™ í•˜ë‹¨</option>
                                <option value="hide">í‘œì‹œ ì•ˆ í•¨</option>
                            </select>
                        </div>
                    </div>
                </div>


            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="goToStep(3)">â† ì´ì „</button>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ <b
                            id="image-est-time">2</b>ë¶„</span>
                    <button class="btn btn-primary" onclick="startImageGeneration()">ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ğŸš€</button>
                </div>
            </div>
        </div>

        <!-- Step 5: ì´ë¯¸ì§€ í¸ì§‘ ë‹¨ê³„ (NEW) -->
        <div class="step-content" id="step-5">
            <div class="card">
                <h2 class="card-title">âœï¸ ì´ë¯¸ì§€ í¸ì§‘</h2>
                <p class="card-desc">ìƒì„±ëœ ì´ë¯¸ì§€ì˜ í†¤ì„ ì¡°ì ˆí•˜ê³ , ê° ì”¬ì„ í™•ì •í•œ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.</p>

                <!-- í†¤ ì¡°ì ˆ íŒ¨ë„ -->
                <div
                    style="background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ¨ ì „ì²´ í†¤ ì¡°ì ˆ</h3>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <input type="text" id="tone-command" placeholder="ì˜ˆ: ì „ì²´ì ìœ¼ë¡œ ë°ê²Œ, ì±„ë„ ë†’ì—¬, ë”°ëœ»í•˜ê²Œ" style="flex: 1;">
                        <button class="btn btn-primary" onclick="analyzeToneCommand()"
                            style="white-space: nowrap;">ë¶„ì„</button>
                    </div>
                    <div id="tone-analysis-result"
                        style="display: none; background: var(--bg-card); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="quickTone('brightness', 1.2)"
                            style="font-size: 0.8rem; padding: 6px 12px;">â˜€ï¸ ë°ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('brightness', 0.8)"
                            style="font-size: 0.8rem; padding: 6px 12px;">ğŸŒ™ ì–´ë‘¡ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('saturation', 1.3)"
                            style="font-size: 0.8rem; padding: 6px 12px;">ğŸŒˆ ì±„ë„â†‘</button>
                        <button class="btn btn-secondary" onclick="quickTone('saturation', 0.7)"
                            style="font-size: 0.8rem; padding: 6px 12px;">ğŸ”² ì±„ë„â†“</button>
                        <button class="btn btn-secondary" onclick="quickTone('warm_filter', 1.15)"
                            style="font-size: 0.8rem; padding: 6px 12px;">ğŸ”¥ ë”°ëœ»í•˜ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('cool_filter', 1.15)"
                            style="font-size: 0.8rem; padding: 6px 12px;">â„ï¸ ì°¨ê°‘ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('contrast', 1.3)"
                            style="font-size: 0.8rem; padding: 6px 12px;">ğŸ”³ ëŒ€ë¹„â†‘</button>
                    </div>
                </div>

                <!-- ì§„í–‰ ìƒíƒœ ë°” -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">í™•ì •ëœ ì”¬: <b
                            id="edit-confirmed-count">0</b> / <b id="edit-total-count">0</b></span>
                    <button class="btn btn-secondary" onclick="confirmAllScenes()"
                        style="font-size: 0.8rem; padding: 6px 12px;">âœ… ì „ì²´ í™•ì •</button>
                </div>
                <div
                    style="background: var(--bg-input); border-radius: 10px; height: 8px; overflow: hidden; margin-bottom: 1.5rem;">
                    <div id="edit-progress-bar"
                        style="background: var(--success); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>

                <!-- ì”¬ë³„ ì´ë¯¸ì§€ ì¹´ë“œ -->
                <div id="edit-scenes-container" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- JSë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>

            <div class="actions" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="goToStep(4)">â† ì´ì „</button>
                <button class="btn btn-primary" id="edit-next-btn" onclick="proceedFromEditStage()" disabled>ë‹¤ìŒ ë‹¨ê³„ (ìº¡ì…˜
                    ìƒì„±) â†’</button>
            </div>
        </div>

        <!-- Step 6: ì´ë¯¸ì§€ ìƒì„± ë° ê²€í†  (ê¸°ì¡´ Step 5) -->
        <div class="step-content" id="step-6">
            <div class="loading" id="loading-images">
                <div class="spinner"></div>
                <div id="image-progress-text">ì´ë¯¸ì§€ ë Œë”ë§ ì¤‘...</div>
                <div style="margin-top: 1rem; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div
                        style="background: var(--bg-input); border-radius: 10px; height: 12px; overflow: hidden; border: 1px solid var(--border);">
                        <div id="image-progress-bar"
                            style="background: var(--primary); height: 100%; width: 0%; transition: width 0.5s;"></div>
                    </div>
                    <div id="image-progress-detail"
                        style="text-align: right; font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">0 /
                        0</div>
                </div>
            </div>

            <div id="images-review-area" style="display: none;">
                <div class="card">
                    <h2 class="card-title">ğŸï¸ ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼</h2>
                    <div id="images-container"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Generated images will be injected here -->
                    </div>
                </div>
            </div>

            <div class="actions" id="image-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(5)">â† ì´ì „</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="goToEditStage()">ì´ë¯¸ì§€ í¸ì§‘ â†’</button>
                </div>
            </div>

            <div class="loading" id="loading-caption" style="display: none;">
                <div class="spinner"></div>
                <div>AIê°€ ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ì¶¤í˜• ìº¡ì…˜ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        </div>

        <!-- Step 7: ìµœì¢… ë°œí–‰ & Instagram Preview (ê¸°ì¡´ Step 6) -->
        <div class="step-content" id="step-7">
            <div style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem;">
                <!-- Left: Instagram Mockup -->
                <div class="card"
                    style="padding: 0; overflow: hidden; background: #fff; color: #000; border-radius: 12px; border: 1px solid #dbdbdb;">
                    <div
                        style="padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #efefef;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); padding: 2px;">
                            <div
                                style="width: 100%; height: 100%; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">
                                TAX</div>
                        </div>
                        <span style="font-weight: 600; font-size: 14px;">tax_webtoon_pro</span>
                    </div>

                    <div id="insta-preview-carousel"
                        style="aspect-ratio: 1/1; background: #fafafa; position: relative;">
                        <!-- Preview Image will be here -->
                        <img id="insta-preview-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 12px;"
                            id="insta-carousel-index">1 / 8</div>
                    </div>

                    <div style="padding: 12px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                            <span>â¤ï¸</span> <span>ğŸ’¬</span> <span>âœˆï¸</span> <span style="margin-left: auto;">ğŸ”–</span>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">ì¢‹ì•„ìš” 1,234ê°œ</div>
                        <div style="font-size: 14px; line-height: 1.4;">
                            <span style="font-weight: 600; margin-right: 5px;">tax_webtoon_pro</span>
                            <span id="insta-preview-caption-text">AIê°€ ìƒì„±í•œ ìº¡ì…˜ì´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                        </div>
                        <div style="color: #0095f6; font-size: 14px; margin-top: 5px;" id="insta-preview-hashtags">#í•´ì‹œíƒœê·¸
                            #ì›¹íˆ°</div>
                    </div>
                </div>

                <!-- Right: Content Review & Actions -->
                <div>
                    <div class="card" style="padding: 1.5rem;">
                        <h2 class="card-title" style="font-size: 1.25rem;">ğŸ“ ìº¡ì…˜ ë° íƒœê·¸ ìˆ˜ì •</h2>
                        <div class="form-group">
                            <label>ğŸ”¥ í›… ë¬¸ì¥</label>
                            <input type="text" id="final-hook" oninput="updateInstaPreview()">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ ë³¸ë¬¸ ìº¡ì…˜</label>
                            <textarea id="final-body" rows="6" oninput="updateInstaPreview()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ğŸ’¡ ì „ë¬¸ê°€ Tip</label>
                            <input type="text" id="final-tip" oninput="updateInstaPreview()">
                        </div>
                        <div class="form-group">
                            <label>#ï¸âƒ£ í•´ì‹œíƒœê·¸</label>
                            <textarea id="final-hashtags" rows="2" oninput="updateInstaPreview()"></textarea>
                        </div>
                    </div>

                    <div class="card" style="padding: 1.5rem; background: var(--bg-input);">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem;">ğŸš€ ë°œí–‰ ì˜µì…˜</h3>
                        <button class="btn btn-primary" onclick="publishToInstagram()"
                            style="width: 100%; margin-bottom: 0.5rem;">ì¸ìŠ¤íƒ€ê·¸ë¨ ì¦‰ì‹œ ë°œí–‰</button>
                        <button class="btn btn-secondary" onclick="downloadImages()" style="width: 100%;">ì´ë¯¸ì§€ ZIP
                            ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="goToStep(6)">â† ì´ì „ ë‹¨ê³„</button>
            </div>
        </div>
    </main>

    <script>
        let currentStep = 1;
        let sessionId = null;
        let storyData = null;
        let collectedData = [];
        let characters = [];
        let selectedMode = 'auto'; // 'auto' or 'manual'

        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => {
                c.classList.toggle('selected', c.dataset.mode === mode);
            });

            if (mode === 'auto') {
                document.getElementById('keyword-input-area').style.display = 'block';
                document.getElementById('manual-input-area').style.display = 'none';
                document.getElementById('btn-start-next').innerText = 'ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€';
            } else {
                document.getElementById('keyword-input-area').style.display = 'none';
                document.getElementById('manual-input-area').style.display = 'block';
                document.getElementById('btn-start-next').innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
            }
        }

        // --- Step 1: ë¶„ì•¼ ê°ì§€ (Intelligent Start) ---
        async function detectField() {
            const keyword = document.getElementById('keyword').value.trim();
            const model = document.getElementById('ai-model-select').value;

            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.querySelector('#step-1 .btn-secondary');
            const originalText = btn.innerText;
            btn.innerText = 'AI ë¶„ì„ ì¤‘...';
            btn.disabled = true;

            try {
                // 1. ì„¸ì…˜ ì‹œì‘ ë° í•„ë“œ ê°ì§€
                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'auto', keyword, model })
                });
                const data = await res.json();
                sessionId = data.session_id;
                localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥

                // 2. ì„¸ì…˜ ì •ë³´ ì¡°íšŒ (ê°ì§€ëœ ê²°ê³¼ í™•ì¸)
                const sessionRes = await fetch(`/api/workflow/session/${sessionId}`);
                const session = await sessionRes.json();
                const info = session.field_info;

                // 3. Step 1 ê²°ê³¼ UI í‘œì‹œ
                document.getElementById('smart-analysis-result').style.display = 'block';
                // ê¸°ì¡´ ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€
                document.getElementById('btn-start-next').style.display = 'none';

                // ê°’ ë°”ì¸ë”©
                document.getElementById('confirmed-field').value = info.field_code || 'GENERAL';
                document.getElementById('confirmed-year').innerText = info.target_year || new Date().getFullYear();
                document.getElementById('hidden-target-year').value = info.target_year || new Date().getFullYear();

                if (info.requires_legal_verification) {
                    document.getElementById('verification-needed-badge').style.display = 'flex';
                } else {
                    document.getElementById('verification-needed-badge').style.display = 'none';
                }

                btn.innerText = 'ë‹¤ì‹œ ê°ì§€';
                btn.disabled = false;

            } catch (e) {
                console.error("Detect Field Error:", e);
                alert('ë¶„ì•¼ ê°ì§€ ì˜¤ë¥˜: ' + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function confirmAndStart() {
            // ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ê°’ (í˜¹ì€ AI ê°’)ìœ¼ë¡œ í™•ì •
            const finalField = document.getElementById('confirmed-field').value;
            const finalYear = document.getElementById('hidden-target-year').value;

            // Step 1 -> Step 2
            navigateToStep(2);
            startDataCollection();
        }

        async function startWorkflow() {
            if (selectedMode === 'manual') {
                // ìˆ˜ë™ ëª¨ë“œ: ì‚¬ìš©ìê°€ ì…ë ¥í•œ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±
                const manualContent = document.getElementById('manual-script').value.trim();
                if (!manualContent) {
                    alert('ì‹œë‚˜ë¦¬ì˜¤ ë˜ëŠ” í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const btn = document.getElementById('btn-start-next');
                btn.innerText = 'ì…ë ¥ ë‚´ìš© ì •ë¦¬ ì¤‘...';
                btn.disabled = true;

                try {
                    // ì„¸ì…˜ ìƒì„± (ìˆ˜ë™ ëª¨ë“œ)
                    const startRes = await fetch('/api/workflow/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'manual' })
                    });
                    const startData = await startRes.json();
                    sessionId = startData.session_id;
                    localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥

                    // Step 2ë¡œ ì´ë™
                    goToStep(2);

                    // ìˆ˜ë™ ëª¨ë“œ ì „ìš© ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ í˜¸ì¶œ
                    await collectManualData(manualContent);

                    btn.innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
                    btn.disabled = false;
                } catch (e) {
                    console.error(e);
                    alert('ìˆ˜ë™ ëª¨ë“œ ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                    btn.innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
                    btn.disabled = false;
                }
                return;
            }

            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // [ë³€ê²½] ê°ì§€ ë‹¨ê³„ ì—†ì´ ë°”ë¡œ ì‹œì‘
            // ë¨¼ì € ì„¸ì…˜ì„ ìƒì„±í•˜ê³ 
            const model = document.getElementById('ai-model-select').value;
            try {
                const btn = document.getElementById('btn-start-next');
                btn.innerText = 'AIê°€ ë¶„ì„ ë° ì‹œì‘ ì¤‘...';
                btn.disabled = true;

                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'auto', keyword, model })
                });
                const data = await res.json();
                sessionId = data.session_id;
                localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥

                btn.innerText = 'ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€';
                btn.disabled = false;

                // ë°”ë¡œ ìë£Œ ìˆ˜ì§‘ ë‹¨ê³„ë¡œ ì´ë™
                goToStep(2);
                collectData();

            } catch (e) {
                console.error(e);
                alert('ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                document.getElementById('btn-start-next').disabled = false;
            }
        }

        // --- Step 2: ìˆ˜ë™ ëª¨ë“œ ìë£Œ íŒŒì‹± ---
        async function collectManualData(content) {
            const loadingEl = document.getElementById('loading-data');
            const reviewArea = document.getElementById('data-review-area');
            const actionsEl = document.getElementById('data-actions');

            // ë¡œë”© ë©”ì‹œì§€ ë³€ê²½ (ìˆ˜ë™ ëª¨ë“œìš©)
            loadingEl.querySelector('div:last-child').innerText = 'ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            try {
                const res = await fetch('/api/workflow/parse-manual-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        content: content
                    })
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'íŒŒì‹± ì˜¤ë¥˜');
                }

                collectedData = data.items || [];

                renderDataItems();
                saveDataToStorage(); // localStorageì— ì €ì¥

                // ì”¬ ìˆ˜ ì¶”ì²œ (ìˆ˜ë™ ëª¨ë“œ)
                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ë‚´ìš© íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        // --- Step 2: ìë£Œ ìˆ˜ì§‘ ---
        async function collectData() {
            const loadingEl = document.getElementById('loading-data');
            const reviewArea = document.getElementById('data-review-area');
            const actionsEl = document.getElementById('data-actions');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            try {
                const keyword = document.getElementById('keyword').value;
                const model = document.getElementById('ai-model-select').value;

                const res = await fetch('/api/workflow/collect-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, keyword, model })
                });
                const data = await res.json();
                collectedData = data.items || [];

                renderDataItems();
                saveDataToStorage(); // localStorageì— ì €ì¥

                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ìë£Œ ìˆ˜ì§‘ ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function renderDataItems() {
            const container = document.getElementById('data-container');
            container.innerHTML = collectedData.map((item, idx) => `
                <div class="char-card data-item" 
                     draggable="true"
                     ondragstart="handleDragStart(event, ${idx})"
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event, ${idx})"
                     ondrop="handleDrop(event, ${idx})"
                     style="cursor: grab; margin-bottom: 0.5rem; align-items: flex-start; flex-direction: column; transition: all 0.2s;">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <span style="font-weight: 600;" onclick="toggleDataBody(${idx})">
                            <span style="cursor: grab; margin-right: 0.5rem;">â‹®â‹®</span>
                            ğŸ“„ ${item.title}
                        </span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); editData(${idx})">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteData(${idx})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div id="data-body-${idx}" onclick="event.stopPropagation();" style="display: block; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; border-top: 1px solid var(--border); padding-top: 0.5rem; width: 100%;">
                        ${item.content}
                    </div>
                </div>
            `).join('');
        }

        function toggleDataBody(idx) {
            const el = document.getElementById(`data-body-${idx}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // === localStorage ë°ì´í„° ì €ì¥/ë³µì› ===
        function saveDataToStorage() {
            if (sessionId && collectedData.length > 0) {
                localStorage.setItem(`webtoon_data_${sessionId}`, JSON.stringify(collectedData));
                console.log('[Storage] ë°ì´í„° ì €ì¥ë¨:', collectedData.length, 'ê°œ í•­ëª©');
            }
        }

        function loadDataFromStorage() {
            if (sessionId) {
                const saved = localStorage.getItem(`webtoon_data_${sessionId}`);
                if (saved) {
                    collectedData = JSON.parse(saved);
                    console.log('[Storage] ë°ì´í„° ë³µì›ë¨:', collectedData.length, 'ê°œ í•­ëª©');
                    return true;
                }
            }
            return false;
        }

        function clearDataFromStorage() {
            if (sessionId) {
                localStorage.removeItem(`webtoon_data_${sessionId}`);
            }
        }

        // === ì •ë³´ í•­ëª© ìˆ˜ì • ===
        function editData(idx) {
            const item = collectedData[idx];
            const newTitle = prompt('ì œëª©ì„ ìˆ˜ì •í•˜ì„¸ìš”:', item.title);
            if (newTitle === null) return;

            const newContent = prompt('ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”:', item.content);
            if (newContent === null) return;

            collectedData[idx] = { title: newTitle, content: newContent };
            renderDataItems();
            saveDataToStorage();
        }

        // === ì •ë³´ í•­ëª© ì‚­ì œ ===
        function deleteData(idx) {
            if (confirm(`"${collectedData[idx].title}" í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                collectedData.splice(idx, 1);
                renderDataItems();
                saveDataToStorage();

                // ì”¬ ìˆ˜ ì¬ê³„ì‚°
                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;
            }
        }

        // === ì •ë³´ í•­ëª© ì¶”ê°€ ëª¨ë‹¬ ===
        function openAddDataModal() {
            const title = prompt('ìƒˆ í•­ëª©ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!title) return;

            const content = prompt('ìƒˆ í•­ëª©ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!content) return;

            collectedData.push({ title, content });
            renderDataItems();
            saveDataToStorage();

            // ì”¬ ìˆ˜ ì¬ê³„ì‚°
            const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
            document.getElementById('total-scene-count').value = recScenes;
            document.getElementById('ai-rec-scenes').innerText = recScenes;
        }

        // === ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì •ë ¬ ===
        let draggedIdx = null;

        function handleDragStart(e, idx) {
            draggedIdx = idx;
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedIdx = null;
            // ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
            document.querySelectorAll('.data-item').forEach(el => {
                el.style.borderTop = '';
                el.style.borderBottom = '';
            });
        }

        function handleDragOver(e, idx) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // ë“œë¡­ ìœ„ì¹˜ í‘œì‹œ
            const items = document.querySelectorAll('.data-item');
            items.forEach((el, i) => {
                el.style.borderTop = '';
                el.style.borderBottom = '';
                if (i === idx) {
                    if (draggedIdx < idx) {
                        el.style.borderBottom = '3px solid var(--primary)';
                    } else if (draggedIdx > idx) {
                        el.style.borderTop = '3px solid var(--primary)';
                    }
                }
            });
        }

        function handleDrop(e, targetIdx) {
            e.preventDefault();
            if (draggedIdx === null || draggedIdx === targetIdx) return;

            // ë°°ì—´ ìˆœì„œ ë³€ê²½
            const [removed] = collectedData.splice(draggedIdx, 1);
            collectedData.splice(targetIdx, 0, removed);

            renderDataItems();
            saveDataToStorage();
            console.log('[Drag] ìˆœì„œ ë³€ê²½ ì™„ë£Œ');
        }

        async function confirmData() {
            goToStep(3);
            generateStory();
        }

        // --- Step 3: ìŠ¤í† ë¦¬ ìƒì„± ---
        async function generateStory() {
            const loadingEl = document.getElementById('loading-story');
            const reviewArea = document.getElementById('story-review-area');
            const actionsEl = document.getElementById('story-actions');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            const sceneCount = parseInt(document.getElementById('total-scene-count').value);

            try {
                const res = await fetch('/api/workflow/generate-story', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        scene_count: sceneCount,
                        questioner_type: 'ì¼ë°˜ì¸',
                        expert_type: 'ì„¸ë¬´ì‚¬'
                    })
                });
                const data = await res.json();

                // API ì—ëŸ¬ ì²´í¬
                if (!res.ok) {
                    throw new Error(data.detail || 'ìŠ¤í† ë¦¬ ìƒì„± ì‹¤íŒ¨');
                }

                if (data.session_id) {
                    sessionId = data.session_id;
                    localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥ (ì•ˆì „ì¥ì¹˜)
                }

                storyData = data.story;

                // storyDataê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
                if (!storyData) {
                    throw new Error('ìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }

                characters = storyData.characters || [];

                renderCharacters();
                renderScenes(storyData.scenes || []);

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                console.error('ìŠ¤í† ë¦¬ ìƒì„± ì˜¤ë¥˜:', e);
                alert('ìŠ¤í† ë¦¬ ìƒì„± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function renderCharacters() {
            const container = document.getElementById('character-profiles');
            container.innerHTML = characters.map((c, idx) => `
                <div class="char-card" style="position: relative;">
                    <div class="char-avatar">ğŸ‘¤</div>
                    <div class="char-info">
                        <div class="char-name">${c.name} <span class="char-role">${c.role}</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${c.appearance}</div>
                    </div>
                    <button class="btn btn-secondary" style="position: absolute; top: 0.5rem; right: 0.5rem; padding: 2px 8px; font-size: 0.7rem;" onclick="editCharacter(${idx})">ìˆ˜ì •</button>
                </div>
            `).join('');
        }

        function editCharacter(idx) {
            const char = characters[idx];
            const newName = prompt('ìºë¦­í„° ì´ë¦„:', char.name);
            if (newName === null) return;

            const newRole = prompt('ì—­í•  (ì „ë¬¸ê°€/ì§ˆë¬¸ì/ì¡°ë ¥ì):', char.role);
            if (newRole === null) return;

            const newAppearance = prompt('ì™¸ëª¨ ë¬˜ì‚¬:', char.appearance);
            if (newAppearance === null) return;

            characters[idx] = {
                ...char,
                name: newName || char.name,
                role: newRole || char.role,
                appearance: newAppearance || char.appearance
            };

            // storyDataë„ ì—…ë°ì´íŠ¸
            if (storyData && storyData.characters) {
                storyData.characters[idx] = characters[idx];
            }

            renderCharacters();
        }

        function renderScenes(scenes) {
            const container = document.getElementById('scenes-container');
            container.innerHTML = scenes.map((s, idx) => {
                const densityWarnings = validateSceneRules(s);
                return `
                <div class="card" style="margin-bottom: 1rem; border: 1px solid ${densityWarnings.length > 0 ? 'var(--warning)' : 'var(--border)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600;">ì”¬ ${s.scene_number}</span>
                        <div style="display: flex; gap: 0.5rem;">
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="editScene(${idx})">ìˆ˜ì •</button>
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="regenerateScene(${idx})">ì¬ìƒì„±</button>
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem; background-color: #fee2e2; color: #dc2626; border: 1px solid #fecaca;" onclick="deleteScene(${idx})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">ğŸ¬ ${s.scene_description}</div>
                    ${s.dialogues.map((d, dIdx) => `
                        <div style="background: var(--bg-input); padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; font-size: 0.875rem; cursor: pointer;" onclick="editDialogue(${idx}, ${dIdx})">
                            <span style="font-weight: 600; color: var(--primary);">${d.character}:</span> ${d.text}
                            <span style="float: right; font-size: 0.7rem; color: var(--text-muted);">[${d.emotion}]</span>
                        </div>
                    `).join('')}
                    ${s.narration ? `<div style="font-style: italic; color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem; cursor: pointer;" onclick="editNarration(${idx})">ğŸ’¬ ${s.narration}</div>` : ''}
                    
                    ${densityWarnings.map(w => `
                        <div class="rule-warning">âš ï¸ ${w}</div>
                    `).join('')}
                    
                    ${densityWarnings.length > 0 ? `
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.75rem; background: rgba(255, 152, 0, 0.1);">ìë™ ì”¬ ë¶„í• </button>
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        // ì”¬ ìˆ˜ì • í•¨ìˆ˜
        function editScene(idx) {
            const scene = storyData.scenes[idx];
            const newDesc = prompt('ì”¬ ì„¤ëª…:', scene.scene_description);
            if (newDesc !== null && newDesc.trim()) {
                storyData.scenes[idx].scene_description = newDesc;
                renderScenes(storyData.scenes);
            }
        }

        // ëŒ€ì‚¬ ìˆ˜ì • í•¨ìˆ˜
        function editDialogue(sceneIdx, dialogueIdx) {
            const dialogue = storyData.scenes[sceneIdx].dialogues[dialogueIdx];
            const newText = prompt(`${dialogue.character}ì˜ ëŒ€ì‚¬:`, dialogue.text);
            if (newText !== null && newText.trim()) {
                storyData.scenes[sceneIdx].dialogues[dialogueIdx].text = newText;
                renderScenes(storyData.scenes);
            }
        }

        // ë‚˜ë ˆì´ì…˜ ìˆ˜ì • í•¨ìˆ˜
        function editNarration(sceneIdx) {
            const scene = storyData.scenes[sceneIdx];
            const newNarration = prompt('ë‚˜ë ˆì´ì…˜:', scene.narration || '');
            if (newNarration !== null) {
                storyData.scenes[sceneIdx].narration = newNarration;
                renderScenes(storyData.scenes);
            }
        }

        // ì”¬ ì¬ìƒì„± í•¨ìˆ˜
        async function regenerateScene(idx) {
            if (!confirm(`ì”¬ ${idx + 1}ì„ AIë¡œ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const scene = storyData.scenes[idx];
            alert('ì”¬ ì¬ìƒì„± ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ìˆ˜ì • ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        }

        // ì”¬ ì‚­ì œ í•¨ìˆ˜
        function deleteScene(idx) {
            if (!confirm(`ì”¬ ${idx + 1}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // ì”¬ ì‚­ì œ
            storyData.scenes.splice(idx, 1);

            // ì”¬ ë²ˆí˜¸ ì¬ì •ë ¬
            storyData.scenes.forEach((scene, index) => {
                scene.scene_number = index + 1;
            });

            renderScenes(storyData.scenes);
        }

        // ì´ˆê¸°í™” ì‹œ ìë™ ë³µì› ë° ê¸°ë³¸ ëª¨ë¸ ì„¤ì •
        window.addEventListener('DOMContentLoaded', async () => {
            // 1. ê¸°ë³¸ ëª¨ë¸ ì„¤ì •
            const modelSelect = document.getElementById('ai-model-select');
            if (modelSelect) {
                const selectedOption = modelSelect.querySelector('option[selected]');
                if (selectedOption) {
                    modelSelect.value = selectedOption.value;
                } else {
                    modelSelect.value = "gemini-3-flash-preview";
                }
            }

            // 2. ìë™ ì„¸ì…˜ ë³µì› (ê°œë°œ íš¨ìœ¨ì„±)
            const savedSessionId = localStorage.getItem('lastSessionId');
            if (savedSessionId) {
                console.log('Found saved session:', savedSessionId);
                try {
                    // ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ ë° ë°ì´í„° ë¡œë“œ
                    const res = await fetch(`/api/workflow/session/${savedSessionId}`);
                    if (res.ok) {
                        const session = await res.json();
                        sessionId = session.session_id;

                        // ë°ì´í„° ë³µì›
                        if (session.story) {
                            storyData = session.story;
                            characters = storyData.characters || [];
                            collectedData = session.collected_data || [];

                            // UI ë Œë”ë§
                            renderCharacters();
                            renderScenes(storyData.scenes || []);

                            // 3ë‹¨ê³„(ìŠ¤í† ë¦¬ í¸ì§‘)ë¡œ ì´ë™
                            // ë§Œì•½ ì´ë¯¸ì§€ê°€ ìƒì„±ëœ ìƒíƒœë¼ë©´ 4ë‹¨ê³„ë‚˜ 5ë‹¨ê³„ë¡œ ê°ˆ ìˆ˜ë„ ìˆê² ì§€ë§Œ, 
                            // ì¼ë‹¨ ì‚¬ìš©ìê°€ ìš”ì²­í•œ "3ë²ˆ íƒ­ë¶€í„° ì‹œì‘"ì„ ìœ„í•´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ 3ë‹¨ê³„ë¡œ ì´ë™

                            document.getElementById('loading-story').style.display = 'none';
                            document.getElementById('story-review-area').style.display = 'block';
                            document.getElementById('story-actions').style.display = 'flex';

                            goToStep(3);

                            // ë§Œì•½ ì´ë¯¸ì§€ ìƒì„± ë‹¨ê³„ê¹Œì§€ ê°”ë˜ ì„¸ì…˜ì´ë¼ë©´?
                            if (session.images && session.images.length > 0) {
                                // ì„ íƒì ìœ¼ë¡œ 5ë‹¨ê³„ ë“±ìœ¼ë¡œ ì´ë™ ê°€ëŠ¥. ì¼ë‹¨ì€ 3ë‹¨ê³„ ìœ ì§€í•˜ê±°ë‚˜ ì•Œë¦¼.
                                console.log('This session has generated images.');
                            }

                            console.log('Session restored functionality enabled.');
                        } else if (session.collected_data && session.collected_data.length > 0) {
                            // ë°ì´í„°ìˆ˜ì§‘ì€ í–ˆì§€ë§Œ ìŠ¤í† ë¦¬ëŠ” ì—†ëŠ” ê²½ìš° -> 2ë‹¨ê³„
                            collectedData = session.collected_data;
                            renderDataItems();
                            goToStep(2);
                        }
                    } else {
                        console.log('Saved session is invalid or expired.');
                        localStorage.removeItem('lastSessionId');
                    }
                } catch (e) {
                    console.error('Auto-restore failed:', e);
                }
            }
        });

        function validateSceneRules(scene) {
            const warnings = [];
            scene.dialogues.forEach(d => {
                if (d.text.length > 50) warnings.push(`${d.character} ëŒ€ì‚¬ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${d.text.length}ì > 50ì)`);
            });
            if (scene.dialogues.length > 3) warnings.push(`ë§í’ì„ ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤ (${scene.dialogues.length}ê°œ > 3ê°œ)`);
            if (scene.narration && scene.narration.length > 60) warnings.push(`ë‚˜ë ˆì´ì…˜ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${scene.narration.length}ì > 60ì)`);
            return warnings;
        }

        function approveScenes() {
            goToStep(4);
            document.getElementById('image-scene-count').innerText = storyData.scenes.length;
            document.getElementById('image-est-time').innerText = Math.ceil(storyData.scenes.length * 0.25);
        }

        // --- Step 4: ì„¤ì • íƒ­ ê´€ë¦¬ ---
        function switchSettingTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`setting-tab-${tab}`).style.display = 'block';
        }

        // --- Step 5: ì´ë¯¸ì§€ ìƒì„± ---
        async function startImageGeneration() {
            goToStep(6);
            const loadingEl = document.getElementById('loading-images');
            const reviewArea = document.getElementById('images-review-area');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';

            const sceneCount = storyData.scenes.length;

            // Style System 2.0 Inputs
            const charStyleId = selectedStyles.character ? selectedStyles.character.id : null;
            const bgStyleId = selectedStyles.background ? selectedStyles.background.id : null;
            const model = document.getElementById('image-model').value;

            const overrides = {
                character_style_prompt: document.getElementById('manual-char-prompt').value,
                background_style_prompt: document.getElementById('manual-bg-prompt').value,
                additional_instructions: document.getElementById('manual-additional').value
            };

            const ratio = document.getElementById('aspect-ratio').value;

            try {
                await fetch('/api/workflow/generate-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        character_style_id: charStyleId,
                        background_style_id: bgStyleId,
                        manual_overrides: overrides,
                        model: model,
                        aspect_ratio: ratio
                    })
                });

                checkImageProgress(sceneCount);
            } catch (e) {
                alert('ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function checkImageProgress(total) {
            let current = 0;
            const progressBar = document.getElementById('image-progress-bar');
            const progressDetail = document.getElementById('image-progress-detail');
            const loadingEl = document.getElementById('loading-images');
            const reviewArea = document.getElementById('images-review-area');
            const actionsEl = document.getElementById('image-actions');

            const interval = setInterval(async () => {
                const res = await fetch(`/api/workflow/session/${sessionId}`);
                const session = await res.json();
                current = session.images ? session.images.filter(img => img.status === 'generated').length : 0;

                const progress = (current / total) * 100;
                progressBar.style.width = `${progress}%`;
                progressDetail.innerText = `${current} / ${total}`;

                if (current >= total) {
                    clearInterval(interval);
                    renderFinalImages(session.images);
                    loadingEl.style.display = 'none';
                    reviewArea.style.display = 'block';
                    actionsEl.style.display = 'flex';
                }
            }, 2000);
        }

        function renderFinalImages(images) {
            const container = document.getElementById('images-container');
            container.innerHTML = images.map(img => `
                <div class="card" style="padding: 0.5rem;">
                    <img src="${img.local_path}" style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="font-size: 0.75rem; font-weight: 600;">ì”¬ ${img.scene_number}</div>
                    <button class="btn btn-secondary" style="width: 100%; padding: 4px; font-size: 0.75rem; margin-top: 0.5rem;">ê°œë³„ ì¬ìƒì„±</button>
                </div>
            `).join('');
        }

        // --- Step 5: ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ í›„ ìº¡ì…˜ ìƒì„± ì‹œì‘ ---
        async function generateCaption() {
            const loadingEl = document.getElementById('loading-caption');
            loadingEl.style.display = 'block';

            try {
                const res = await fetch('/api/workflow/generate-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await res.json();
                const caption = data.caption;

                // Step 6 ì…ë ¥ í•„ë“œ ì„¸íŒ…
                document.getElementById('final-hook').value = caption.hook;
                document.getElementById('final-body').value = caption.body;
                document.getElementById('final-tip').value = caption.tip;
                document.getElementById('final-hashtags').value = caption.hashtags.join(' ');

                loadingEl.style.display = 'none';
                goToStep(7);
                updateInstaPreview();
            } catch (e) {
                alert('ìº¡ì…˜ ìƒì„± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function updateInstaPreview() {
            const hook = document.getElementById('final-hook').value;
            const body = document.getElementById('final-body').value;
            const tip = document.getElementById('final-tip').value;
            const hashtags = document.getElementById('final-hashtags').value;

            const fullText = `${hook}\n\n${body}\n\nğŸ’¡ Tip: ${tip}`;
            document.getElementById('insta-preview-caption-text').innerText = fullText;
            document.getElementById('insta-preview-hashtags').innerText = hashtags;

            // ì´ë¯¸ì§€ í”„ë¦¬ì…‹ (ì²« ë²ˆì§¸ ì´ë¯¸ì§€ í‘œì‹œ)
            const firstImg = document.querySelector('#images-container img');
            if (firstImg) {
                document.getElementById('insta-preview-img').src = firstImg.src;
            }

            const totalImages = document.querySelectorAll('#images-container img').length;
            document.getElementById('insta-carousel-index').innerText = `1 / ${totalImages}`;
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            document.querySelectorAll('.step').forEach(s => {
                const sNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'done');
                if (sNum < step) s.classList.add('done');
                if (sNum === step) s.classList.add('active');
            });

            // --- VIEW STATE MANAGEMENT (ì‚¬ìš©ì ê²½í—˜ ê°œì„ ) ---
            // íƒ­ ì´ë™ ì‹œ 'ë¡œë”© ì¤‘' í™”ë©´ì´ ì•„ë‹ˆë¼ 'ê²°ê³¼/ì‘ì—…' í™”ë©´ì„ ìš°ì„  í‘œì‹œí•˜ë„ë¡ ê°•ì œ

            // Step 2: ìë£Œ ìˆ˜ì§‘
            if (step === 2) {
                document.getElementById('loading-data').style.display = 'none';
                document.getElementById('data-review-area').style.display = 'block';
                document.getElementById('data-actions').style.display = 'flex';

                if (collectedData.length === 0) {
                    loadDataFromStorage();
                }
                renderDataItems();
            }

            // Step 3: ìŠ¤í† ë¦¬
            if (step === 3) {
                document.getElementById('loading-story').style.display = 'none';
                document.getElementById('story-review-area').style.display = 'block';
                document.getElementById('story-actions').style.display = 'flex';

                if (storyData && storyData.scenes) {
                    renderCharacters();
                    renderScenes(storyData.scenes);
                }
            }

            // Step 5: ì´ë¯¸ì§€ í¸ì§‘
            if (step === 5) {
                loadEditStageStatus();
            }

            // Step 6: ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼ (ê¸°ì¡´ Step 5)
            if (step === 6) {
                document.getElementById('loading-images').style.display = 'none';
                document.getElementById('images-review-area').style.display = 'block';
                document.getElementById('image-actions').style.display = 'flex';
            }

            // Step 7: ë°œí–‰ (ê¸°ì¡´ Step 6)
            if (step === 7) {
                updateInstaPreview();
            }
        }

        function navigateToStep(step) {
            // ì‚¬ìš©ì ìš”ì²­: ììœ ë¡œìš´ íƒ­ ì´ë™ í—ˆìš© (ë‹¨, ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŒì„ ê°ì•ˆ)
            goToStep(step);
        }

        // ============================================
        // Step 5: ì´ë¯¸ì§€ í¸ì§‘ ë‹¨ê³„ (Edit Stage) JS
        // ============================================

        function goToEditStage() {
            goToStep(5);
        }

        async function loadEditStageStatus() {
            if (!sessionId) return;
            try {
                const res = await fetch(`/api/edit-stage/${sessionId}/status`);
                if (!res.ok) return;
                const data = await res.json();
                document.getElementById('edit-confirmed-count').innerText = data.confirmed_count;
                document.getElementById('edit-total-count').innerText = data.total_scenes;
                const pct = data.total_scenes > 0 ? (data.confirmed_count / data.total_scenes) * 100 : 0;
                document.getElementById('edit-progress-bar').style.width = `${pct}%`;
                renderEditScenes(data.scenes);
                updateEditNextButton(data.all_confirmed);
            } catch (e) {
                console.error('í¸ì§‘ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        function renderEditScenes(scenes) {
            const container = document.getElementById('edit-scenes-container');
            container.innerHTML = scenes.map(s => {
                const isConfirmed = s.edit_status === 'confirmed';
                const borderColor = isConfirmed ? 'var(--success)' : 'var(--border)';
                const statusBadge = isConfirmed
                    ? '<span style="color: var(--success); font-weight: 600;">âœ… í™•ì •ë¨</span>'
                    : '<span style="color: var(--warning); font-weight: 600;">â³ ë¯¸í™•ì •</span>';

                return `
                <div style="display: flex; gap: 1rem; background: var(--bg); border: 2px solid ${borderColor}; border-radius: 12px; padding: 1rem; transition: border-color 0.3s;">
                    <div style="flex-shrink: 0; width: 180px;">
                        <img src="${s.local_path || s.image_url || ''}" style="width: 100%; border-radius: 8px; background: var(--bg-input);" onerror="this.style.display='none'">
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 700;">ì”¬ ${s.scene_number}</span>
                            ${statusBadge}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); max-height: 60px; overflow-y: auto;">
                            ${(s.prompt_used || '').substring(0, 150)}...
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: auto;">
                            ${isConfirmed
                        ? `<button class="btn btn-secondary" onclick="toggleConfirmScene(${s.scene_number}, false)" style="font-size: 0.75rem; padding: 4px 10px;">í™•ì • í•´ì œ</button>`
                        : `<button class="btn btn-primary" onclick="toggleConfirmScene(${s.scene_number}, true)" style="font-size: 0.75rem; padding: 4px 10px;">âœ… í™•ì •</button>`
                    }
                            <button class="btn btn-secondary" onclick="undoScene(${s.scene_number})" style="font-size: 0.75rem; padding: 4px 10px;" ${!s.has_history ? 'disabled' : ''}>â†© ë˜ëŒë¦¬ê¸°</button>
                            <button class="btn btn-secondary" onclick="openPromptModal(${s.scene_number})" style="font-size: 0.75rem; padding: 4px 10px;">âœï¸ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateEditNextButton(allConfirmed) {
            const btn = document.getElementById('edit-next-btn');
            btn.disabled = !allConfirmed;
            if (allConfirmed) {
                btn.style.opacity = '1';
                btn.title = '';
            } else {
                btn.style.opacity = '0.5';
                btn.title = 'ëª¨ë“  ì”¬ì„ í™•ì •í•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            }
        }

        async function analyzeToneCommand() {
            const command = document.getElementById('tone-command').value.trim();
            if (!command) return;
            const resultEl = document.getElementById('tone-analysis-result');
            resultEl.style.display = 'block';
            resultEl.innerHTML = 'ë¶„ì„ ì¤‘...';

            try {
                const res = await fetch(`/api/edit-stage/${sessionId}/tone-analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                const data = await res.json();
                if (data.type === 'pillow') {
                    resultEl.innerHTML = `
                        <div style="color: var(--success);">${data.message}</div>
                        <button class="btn btn-primary" onclick="applyToneEffects(${JSON.stringify(data.effects).replace(/"/g, '&quot;')})" style="margin-top: 0.5rem; font-size: 0.8rem;">ì „ì²´ ì ìš©</button>
                    `;
                } else if (data.type === 'ai_required') {
                    resultEl.innerHTML = `<div style="color: var(--warning);">${data.message}</div>`;
                } else {
                    resultEl.innerHTML = `<div style="color: var(--text-muted);">${data.message}</div>`;
                }
            } catch (e) {
                resultEl.innerHTML = `<div style="color: var(--danger);">ì˜¤ë¥˜: ${e.message}</div>`;
            }
        }

        async function quickTone(effect, value) {
            await applyToneEffects([{ effect, value }]);
        }

        async function applyToneEffects(effects) {
            try {
                const res = await fetch(`/api/edit-stage/${sessionId}/tone-apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ effects, scene_numbers: null })
                });
                const data = await res.json();
                if (data.success) {
                    loadEditStageStatus(); // UI ìƒˆë¡œê³ ì¹¨
                }
            } catch (e) {
                alert('í†¤ ì¡°ì ˆ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function toggleConfirmScene(sceneNum, confirm) {
            const endpoint = confirm ? 'confirm' : 'unconfirm';
            try {
                await fetch(`/api/edit-stage/${sessionId}/scene/${sceneNum}/${endpoint}`, { method: 'POST' });
                loadEditStageStatus();
            } catch (e) {
                alert('í™•ì • ë³€ê²½ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function confirmAllScenes() {
            try {
                await fetch(`/api/edit-stage/${sessionId}/confirm-all`, { method: 'POST' });
                loadEditStageStatus();
            } catch (e) {
                alert('ì „ì²´ í™•ì • ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function undoScene(sceneNum) {
            try {
                await fetch(`/api/edit-stage/${sessionId}/scene/${sceneNum}/undo`, { method: 'POST' });
                loadEditStageStatus();
            } catch (e) {
                alert('ë˜ëŒë¦¬ê¸° ì‹¤íŒ¨: ' + e.message);
            }
        }

        function openPromptModal(sceneNum) {
            const newPrompt = prompt(`ì”¬ ${sceneNum}ì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš” (ë¹ˆì¹¸ì´ë©´ ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ ìœ ì§€):`);
            if (newPrompt !== null) {
                regenerateScene(sceneNum, newPrompt || null);
            }
        }

        async function regenerateScene(sceneNum, newPrompt) {
            try {
                const res = await fetch(`/api/edit-stage/${sessionId}/scene/${sceneNum}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scene_number: sceneNum, new_prompt: newPrompt })
                });
                const data = await res.json();
                if (data.success) {
                    loadEditStageStatus();
                }
            } catch (e) {
                alert('ì¬ìƒì„± ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function proceedFromEditStage() {
            // ìº¡ì…˜ ìƒì„± ì‹œì‘
            generateCaption();
        }
    </script>
    <!-- Story History Modal -->
    <div id="history-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content"
            style="background: #1e1e1e; color: #ffffff; padding: 20px; border-radius: 8px; width: 500px; max-width: 90%; border: 1px solid #444;">
            <h3 style="margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">ì´ì „ ìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (ìµœê·¼ 5ê°œ)</h3>
            <div id="history-list" style="margin: 15px 0; max-height: 300px; overflow-y: auto;">
                Loading...
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('history-modal').style.display='none'">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        async function openStoryHistoryModal() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            modal.style.display = 'flex';
            list.innerHTML = '<div>Loading...</div>';

            try {
                const res = await fetch('/api/workflow/history/stories');
                const files = await res.json();

                if (files.length === 0) {
                    list.innerHTML = '<div style="color: #aaa;">ì €ì¥ëœ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                list.innerHTML = files.map(f => `
                <div style="background: #2d2d2d; border: 1px solid #444; padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; color: #eee;" 
                     onclick="loadStory('${f.filename}')" 
                     onmouseover="this.style.background='#3d3d3d'" 
                     onmouseout="this.style.background='#2d2d2d'">
                    <div style="font-weight: bold;">${f.keyword}</div>
                    <div style="font-size: 0.8em; color: #666;">
                        ${new Date(f.timestamp).toLocaleString()} | ${f.title} (${f.scene_count} scenes)
                    </div>
                </div>
            `).join('');
            } catch (e) {
                list.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }

        async function loadStory(filename) {
            if (!confirm('í˜„ì¬ ì‘ì—… ë‚´ìš©ì„ ë®ì–´ì“°ê³  ìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const res = await fetch('/api/workflow/history/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, filename: filename })
                });
                const data = await res.json();

                if (data.session_id) {
                    sessionId = data.session_id;
                    localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥
                }

                if (data.success) {
                    storyData = data.story;
                    collectedData = data.collected_data || [];
                    characters = storyData.characters || [];

                    // Update UI
                    document.getElementById('history-modal').style.display = 'none';

                    renderCharacters();
                    renderScenes(storyData.scenes);

                    // Show Step 3 areas
                    document.getElementById('loading-story').style.display = 'none';
                    document.getElementById('story-review-area').style.display = 'block';
                    document.getElementById('story-actions').style.display = 'flex';

                    // Go to step 3 if not already
                    goToStep(3);

                    alert('ìŠ¤í† ë¦¬ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                alert('Failed to load: ' + e.message);
            }
        }

        // --- Style System 2.0 Logic ---
        let currentStyleType = 'character';
        let stylesData = { character: [], background: [] };
        let selectedStyles = { character: null, background: null };
        let manualOverrides = { charPrompt: '', bgPrompt: '', additional: '' };

        function openStyleManager(type) {
            currentStyleType = type;
            document.getElementById('style-manager-modal').style.display = 'flex';
            document.getElementById('style-modal-title').innerText = type === 'character' ? 'ì¸ë¬¼ ìŠ¤íƒ€ì¼ ê´€ë¦¬' : 'ë°°ê²½ ìŠ¤íƒ€ì¼ ê´€ë¦¬';

            // Reset Form View
            document.getElementById('style-detail-view').style.display = 'none';
            document.getElementById('style-form-view').style.display = 'none';

            loadStyles(type);
        }

        function closeStyleManager() {
            document.getElementById('style-manager-modal').style.display = 'none';
        }

        async function loadStyles(type) {
            const listEl = document.getElementById('style-list');
            listEl.innerHTML = '<div style="padding:1rem;">Loading...</div>';

            try {
                const res = await fetch(`/api/styles/${type}`);
                stylesData[type] = await res.json();
                renderStyleList(stylesData[type]);
            } catch (e) {
                listEl.innerHTML = `<div style="color:red; padding:1rem;">Error: ${e.message}</div>`;
            }
        }

        function renderStyleList(styles) {
            const listEl = document.getElementById('style-list');
            if (styles.length === 0) {
                listEl.innerHTML = '<div style="padding:1rem; color:var(--text-muted);">ì €ì¥ëœ ìŠ¤íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            listEl.innerHTML = styles.map(s => `
                <div class="style-item-dark" onclick="viewStyleDetail('${s.id}')" style="padding: 1rem; cursor: pointer;">
                    <div style="font-weight: bold; margin-bottom: 0.25rem;">${s.name}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${s.description || s.prompt_block}
                    </div>
                </div>
            `).join('');
        }

        function viewStyleDetail(id) {
            const style = stylesData[currentStyleType].find(s => s.id === id);
            if (!style) return;

            window.activeStyleDetail = style;

            document.getElementById('style-form-view').style.display = 'none';
            document.getElementById('style-detail-view').style.display = 'block';

            document.getElementById('detail-name').innerText = style.name;
            document.getElementById('detail-prompt').innerText = style.prompt_block;

            const previewEl = document.getElementById('detail-preview');

            // ìš°ì„ ìˆœìœ„: 1. preview_image (ìƒì„±ëœ ëŒ€í‘œ ì´ë¯¸ì§€) 2. reference_images (ì‚¬ìš©ì ì—…ë¡œë“œ)
            if (style.preview_image) {
                previewEl.innerHTML = `<img src="${style.preview_image}" style="max-width:100%; max-height:100%; border-radius:4px;">`;
            } else if (style.reference_images && style.reference_images.length > 0) {
                previewEl.innerHTML = `<img src="${style.reference_images[0]}" style="max-width:100%; max-height:100%; border-radius:4px;">`;
            } else {
                previewEl.innerHTML = 'No Image';
            }
        }

        function selectCurrentStyle() {
            if (!window.activeStyleDetail) return;
            selectedStyles[currentStyleType] = window.activeStyleDetail;

            // Update UI card
            const uiId = currentStyleType === 'character' ? 'selected-char-style' : 'selected-bg-style';
            document.getElementById(uiId).innerHTML = `
                <div style="font-weight:bold; color: #333;">${window.activeStyleDetail.name}</div>
            `;

            // Pre-fill manual prompt
            if (currentStyleType === 'character') {
                document.getElementById('manual-char-prompt').value = window.activeStyleDetail.prompt_block;
            } else {
                document.getElementById('manual-bg-prompt').value = window.activeStyleDetail.prompt_block;
            }



            // --- Creation Form ---
            function showCreateStyleForm() {
                document.getElementById('style-detail-view').style.display = 'none';
                document.getElementById('style-form-view').style.display = 'block';

                // Initialize form
                document.getElementById('style-form-name').value = '';
                document.getElementById('style-form-prompt').value = '';
                document.getElementById('style-form-image').value = '';
                document.getElementById('style-form-locked-attrs').value = '[]';
                document.getElementById('style-form-visual-attrs').value = '{}';
            }

            function cancelCreateStyle() {
                document.getElementById('style-form-view').style.display = 'none';
            }

            async function extractStyleFromImage() {
                const fileInput = document.getElementById('extract-upload');
                if (!fileInput.files[0]) {
                    alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const formData = new FormData();
                formData.append('image', fileInput.files[0]);

                document.getElementById('extract-loading').style.display = 'inline';

                try {
                    const res = await fetch('/api/styles/extract', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (data.success && data.result) {
                        const result = data.result;
                        // Auto-fill based on current type
                        if (currentStyleType === 'character' && result.character_style) {
                            document.getElementById('style-form-prompt').value = result.character_style.prompt_block;
                            document.getElementById('style-form-locked-attrs').value = JSON.stringify(result.character_style.locked_attributes || []);
                            document.getElementById('style-form-visual-attrs').value = JSON.stringify(result.character_style.visual_attributes || {});

                            if (!document.getElementById('style-form-name').value) {
                                document.getElementById('style-form-name').value = "Extracted Character Style";
                            }
                        } else if (currentStyleType === 'background' && result.background_style) {
                            document.getElementById('style-form-prompt').value = result.background_style.prompt_block;
                            document.getElementById('style-form-locked-attrs').value = JSON.stringify(result.background_style.locked_attributes || []);
                            document.getElementById('style-form-visual-attrs').value = JSON.stringify(result.background_style.visual_attributes || {});

                            if (!document.getElementById('style-form-name').value) {
                                document.getElementById('style-form-name').value = "Extracted Background Style";
                            }
                        }
                    }
                } catch (e) {
                    alert('Extraction failed: ' + e.message);
                } finally {
                    document.getElementById('extract-loading').style.display = 'none';
                }
            }

            async function submitStyleForm() {
                const name = document.getElementById('style-form-name').value;
                const prompt = document.getElementById('style-form-prompt').value;
                const locked = document.getElementById('style-form-locked-attrs').value;
                const visual = document.getElementById('style-form-visual-attrs').value;
                const imageFile = document.getElementById('style-form-image').files[0];

                if (!name || !prompt) {
                    alert('ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                    return;
                }

                const formData = new FormData();
                formData.append('name', name);
                formData.append('type', currentStyleType);
                formData.append('prompt_block', prompt);
                formData.append('locked_attributes', locked);
                formData.append('visual_attributes', visual);
                if (imageFile) {
                    formData.append('reference_images', imageFile);
                }

                try {
                    const res = await fetch('/api/styles/save', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadStyles(currentStyleType);
                        document.getElementById('style-form-view').style.display = 'none';
                    }
                } catch (e) {
                    alert('Save failed: ' + e.message);
                }
            }

            closeStyleManager();
        }

        // --- Preview & Generation ---

        async function generatePreview() {
            const btn = document.getElementById('btn-generate-preview');
            const previewContainer = document.getElementById('preview-image-container');

            btn.innerText = 'Creating Preview...';
            btn.disabled = true;
            previewContainer.innerHTML = '<div style="font-size:2rem;">â³</div>';

            // Build overrides
            const overrides = {
                character_style_prompt: document.getElementById('manual-char-prompt').value,
                background_style_prompt: document.getElementById('manual-bg-prompt').value,
                additional_instructions: document.getElementById('manual-additional').value
            };

            try {
                const res = await fetch('/api/workflow/generate-preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        character_style_id: selectedStyles.character ? selectedStyles.character.id : null,
                        background_style_id: selectedStyles.background ? selectedStyles.background.id : null,
                        manual_overrides: overrides,
                        model: document.getElementById('image-model').value
                    })
                });

                if (res.status === 200) {
                    const data = await res.json();
                    if (data.success) {
                        let imgSrc = '';
                        if (data.image_b64) {
                            imgSrc = `data:image/png;base64,${data.image_b64}`;
                        } else if (data.image_url) {
                            imgSrc = data.image_url;
                        }
                        previewContainer.innerHTML = `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:contain; border-radius:8px;">`;
                        console.log("Preview generated with prompt:", data.prompt_used);
                    } else {
                        alert('Preview generation failed: ' + (data.error || 'Unknown error'));
                        previewContainer.innerHTML = '<div style="color:red; padding:1rem;">Error</div>';
                    }
                } else {
                    const err = await res.json();
                    alert('Preview error: ' + err.detail);
                    previewContainer.innerHTML = '<div style="color:red; padding:1rem;">Error</div>';
                }
            } catch (e) {
                alert('Preview failed: ' + e.message);
                previewContainer.innerHTML = '<span style="color:red">Error</span>';
            } finally {
                btn.innerText = 'ìƒ˜í”Œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±';
                btn.disabled = false;
            }
        }

        function applyManualOverrides() {
            generatePreview();
        }
    </script>

    <!-- Style Manager Modal -->
    <div id="style-manager-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content modal-content-dark"
            style="padding: 0; border-radius: 8px; width: 800px; max-width: 95%; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header modal-header-dark"
                style="padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;" id="style-modal-title">ìŠ¤íƒ€ì¼ ê´€ë¦¬</h3>
                <button class="btn btn-sm btn-secondary" onclick="closeStyleManager()">ë‹«ê¸°</button>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex;">
                <!-- Left: List -->
                <div class="style-list-dark"
                    style="width: 300px; padding-right: 1rem; display: flex; flex-direction: column;">
                    <button class="btn btn-primary" style="margin-bottom: 1rem;" onclick="showCreateStyleForm()">+ ìƒˆ ìŠ¤íƒ€ì¼
                        ì¶”ê°€</button>
                    <div id="style-list" style="flex: 1; overflow-y: auto;">
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">Loading...</div>
                    </div>
                </div>

                <!-- Right: Details / Form -->
                <div style="flex: 1; padding-left: 1rem;">
                    <!-- View Details Mode -->
                    <div id="style-detail-view" style="display: none;">
                        <h4 id="detail-name" style="margin-top: 0;">Style Name</h4>
                        <div id="detail-preview"
                            style="width: 100%; height: 200px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                            No Image
                        </div>
                        <p id="detail-prompt"
                            style="background: var(--bg-input); color: var(--text); padding: 1rem; border-radius: 4px; font-size: 0.9rem; max-height: 150px; overflow-y: auto; border: 1px solid var(--border);">
                        </p>
                        <div style="margin-top: 2rem; text-align: right;">
                            <button class="btn btn-primary" onclick="selectCurrentStyle()">ì´ ìŠ¤íƒ€ì¼ ì„ íƒ</button>
                        </div>
                    </div>

                    <!-- Create/Edit Form Mode -->
                    <div id="style-form-view" style="display: none;">
                        <h4 style="margin-top: 0;">ìƒˆ ìŠ¤íƒ€ì¼ ë§Œë“¤ê¸°</h4>

                        <!-- Extraction Option -->
                        <div
                            style="background: var(--bg-input); border: 1px solid var(--border); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h5 style="margin: 0 0 0.5rem 0;">ğŸ“¸ ì´ë¯¸ì§€ì—ì„œ ìŠ¤íƒ€ì¼ ì¶”ì¶œ (Vision AI)</h5>
                            <input type="file" id="extract-upload" accept="image/*" style="margin-bottom: 0.5rem;">
                            <button class="btn btn-sm btn-outline" onclick="extractStyleFromImage()">ë¶„ì„ ë° ìë™ ì…ë ¥</button>
                            <span id="extract-loading"
                                style="display: none; margin-left: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">ë¶„ì„
                                ì¤‘...</span>
                        </div>

                        <div class="form-group">
                            <label>ìŠ¤íƒ€ì¼ ì´ë¦„</label>
                            <input type="text" id="style-form-name" placeholder="ì˜ˆ: ë”°ëœ»í•œ ê°ì„± ì›¹íˆ°">
                        </div>
                        <div class="form-group">
                            <label>í”„ë¡¬í”„íŠ¸ (Prompt Block)</label>
                            <textarea id="style-form-prompt" rows="5" placeholder="ìŠ¤íƒ€ì¼ì„ ë¬˜ì‚¬í•˜ëŠ” í”„ë¡¬í”„íŠ¸..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>ëŒ€í‘œ ì´ë¯¸ì§€ ë“±ë¡ (ì„ íƒ)</label>
                            <input type="file" id="style-form-image" accept="image/*">
                        </div>

                        <!-- Hidden Fields for JSON data -->
                        <input type="hidden" id="style-form-locked-attrs" value="[]">
                        <input type="hidden" id="style-form-visual-attrs" value="{}">

                        <div style="text-align: right; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="cancelCreateStyle()">ì·¨ì†Œ</button>
                            <button class="btn btn-primary" onclick="submitStyleForm()">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>