<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Progress Steps */
        .progress-bar {
            background: var(--bg-card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step:hover {
            color: var(--primary);
        }

        .step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step.done {
            color: var(--success);
        }

        .step.done:hover {
            color: var(--primary);
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step.active .step-num {
            background: var(--primary);
            color: white;
        }

        .step.done .step-num {
            background: var(--success);
            color: white;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 0.5rem;
        }

        .step.done+.step-line {
            background: var(--success);
        }

        /* Main Content */
        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Step Content - Page View Behavior */
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .card-desc {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mode Selection */
        .mode-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .mode-card {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--primary);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .mode-card.selected {
            background: rgba(99, 102, 241, 0.1);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .mode-title {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .mode-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Scene Cards */
        .scene-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .scene-num {
            font-weight: 700;
            color: var(--primary);
        }

        .scene-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--warning);
            color: black;
        }

        /* Character Card */
        .char-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .char-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .char-avatar {
            width: 60px;
            height: 60px;
            background: var(--bg-input);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .char-info {
            flex: 1;
        }

        .char-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .char-role {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Rule Warning */
        .rule-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 3px solid var(--warning);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #ff9800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-container {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
        }

        .tab.active {
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
    </style>
</head>

<body>
    <header>
        <a href="/" class="logo" style="text-decoration: none;">ğŸ¨ Tax Webtoon Auto-Generator Pro</a>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span id="login-status" style="font-size: 0.875rem; color: var(--text-muted);">Guest User</span>
            <a href="/settings" style="color: var(--text-muted); text-decoration: none;">âš™ï¸ ì„¤ì •</a>
        </div>
    </header>

    <div class="progress-bar">
        <div class="steps">
            <div class="step active" data-step="1" onclick="navigateToStep(1)"><span class="step-num">1</span> ì‹œì‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="2" onclick="navigateToStep(2)"><span class="step-num">2</span> ìë£Œìˆ˜ì§‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="3" onclick="navigateToStep(3)"><span class="step-num">3</span> ìŠ¤í† ë¦¬</div>
            <div class="step-line"></div>
            <div class="step" data-step="4" onclick="navigateToStep(4)"><span class="step-num">4</span> ì´ë¯¸ì§€</div>
            <div class="step-line"></div>
            <div class="step" data-step="5" onclick="navigateToStep(5)"><span class="step-num">5</span> ìº¡ì…˜</div>
            <div class="step-line"></div>
            <div class="step" data-step="6" onclick="navigateToStep(6)"><span class="step-num">6</span> ë°œí–‰</div>
        </div>
    </div>

    <main>
        <div class="step-content active" id="step-1">
            <div class="card">
                <h2 class="card-title">ğŸš€ ì›Œí¬í”Œë¡œìš° ì‹œì‘</h2>
                <!-- Mode Cards Hidden (Optional: Can keep them if needed, but user didn't ask to remove) -->
                <div class="mode-cards" style="margin-bottom: 2rem;">
                    <div class="mode-card selected" data-mode="auto" onclick="selectMode('auto')">
                        <div class="mode-icon">ğŸ¤–</div>
                        <div class="mode-title">ìë™ ëª¨ë“œ</div>
                        <div class="mode-desc">í‚¤ì›Œë“œë§Œ ì…ë ¥í•˜ë©´ AIê°€ ìë£Œ ìˆ˜ì§‘ë¶€í„°ìŠ¤í† ë¦¬ê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="mode-card" data-mode="manual" onclick="selectMode('manual')">
                        <div class="mode-icon">âœï¸</div>
                        <div class="mode-title">ìˆ˜ë™ ëª¨ë“œ</div>
                        <div class="mode-desc">ì§ì ‘ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</div>
                    </div>
                </div>

                <div id="keyword-input-area">
                    <div class="form-group">
                        <label for="keyword">ë¬´ì—‡ì— ëŒ€í•´ ì„¤ëª…í•˜ëŠ” ì›¹íˆ°ì„ ë§Œë“¤ê¹Œìš”?</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="keyword" placeholder="ì˜ˆ: ì¦ì—¬ì„¸ ì—†ì´ ì¦ì—¬í•˜ëŠ” ë²•, ìœ¡ì•„íœ´ì§ ì‹ ì²­"
                                onkeyup="if(event.key==='Enter') startWorkflow()">
                        </div>

                        <!-- AI Model Selection -->
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                            <span>ì‚¬ìš©í•  AI ëª¨ë¸:</span>
                            <select id="ai-model-select"
                                style="padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                                <option value="gemini-3-pro-preview">Gemini 3.0 Pro (Preview/ìµœê³ ì„±ëŠ¥)</option>
                                <option value="gemini-3-flash-preview">Gemini 3.0 Flash (Preview/ë¹ ë¦„)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Stable/ê³ ì„±ëŠ¥)</option>
                                <option value="gemini-2.0-flash" selected>Gemini 2.0 Flash (Stable/ê· í˜•)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="manual-input-area" style="display : none;">
                    <div class="form-group">
                        <label for="manual-script">ì‹œë‚˜ë¦¬ì˜¤ ë˜ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥</label>
                        <textarea id="manual-script" rows="5" placeholder="ì§ì ‘ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ë‚˜ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>

                <!-- Smart Analysis Result Removed -->
            </div>

            <div class="actions">
                <div></div>
                <!-- Initial Start Button Hidden when Analysis Shown -->
                <button class="btn btn-primary" id="btn-start-next" onclick="startWorkflow()"
                    style="display: block; width: 100%;">
                    ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€
                </button>
            </div>
        </div>

        <!-- Step 2: ìë£Œ ìˆ˜ì§‘ ë° ì¶”ì²œ -->
        <div class="step-content" id="step-2">
            <div class="loading" id="loading-data">
                <div class="spinner"></div>
                <div>AIê°€ ê´€ë ¨ ë²•ë ¹ê³¼ ìƒì„¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div id="data-review-area" style="display: none;">
                <div class="card">
                    <h2 class="card-title">ğŸ“š ìˆ˜ì§‘ëœ ìƒì„¸ ì •ë³´</h2>
                    <p class="card-desc">AIê°€ í‚¤ì›Œë“œì— ë§ì¶° ìˆ˜ì§‘í•œ ë‚´ìš©ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ë³¸ë¬¸ì„ ìˆ˜ì •í•˜ê±°ë‚˜ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    <div id="data-container"></div>
                    <button class="btn btn-secondary" style="margin-top: 1rem; width: 100%;"
                        onclick="openAddDataModal()">+ ì •ë³´ í•­ëª© ì¶”ê°€</button>
                </div>

                <!-- AI ë¶„í•  ì¶”ì²œ -->
                <div class="card"
                    style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(74, 144, 226, 0.15)); border: 1px solid var(--primary);">
                    <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">ğŸª„ AI ì‹œí€€ìŠ¤ ì¶”ì²œ
                    </h3>
                    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">ìˆ˜ì§‘ëœ ì •ë³´ì˜ ì–‘ì„ ë¶„ì„í–ˆì„ ë•Œ,
                        ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì„±ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <label style="font-weight: 600;">ì´ ì œì‘ ì”¬(Scene) ê°œìˆ˜</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <input type="number" id="total-scene-count" value="8"
                                    style="width: 80px; text-align: center; font-size: 1.25rem;">
                                <span style="font-size: 0.875rem; color: var(--text-muted);">ì¶”ì²œ: <b
                                        id="ai-rec-scenes">8</b>ê°œ</span>
                            </div>
                        </div>
                        <div>
                            <label style="font-weight: 600;">ì‹œë¦¬ì¦ˆ ë¶„í•  (ì¸ìŠ¤íƒ€ ìºëŸ¬ì…€ìš©)</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <input type="text" id="series-split" value="8" placeholder="ì˜ˆ: 8,7 (8ì¥+7ì¥)"
                                    style="width: 120px; text-align: center;">
                                <span style="font-size: 0.875rem; color: var(--text-muted);">ì¶”ì²œ: <b
                                        id="ai-rec-split">ë‹¨ì¼</b></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions" id="data-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(1)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="confirmData()">ìŠ¤í† ë¦¬ êµ¬ì„± í™•ì¸ â†’</button>
            </div>
        </div>

        <!-- Step 3: ìŠ¤í† ë¦¬ ë° ìºë¦­í„° ê´€ë¦¬ -->
        <div class="step-content" id="step-3">
            <div class="loading" id="loading-story">
                <div class="spinner"></div>
                <div>ë§ì¶¤í˜• ìŠ¤í† ë¦¬ë¥¼ êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>

            <div id="story-review-area" style="display: none;">
                <!-- ìºë¦­í„° í”„ë¡œí•„ ì„¹ì…˜ -->
                <div class="card">
                    <h2 class="card-title">ğŸ‘¥ ë“±ì¥ì¸ë¬¼ í”„ë¡œí•„</h2>
                    <div id="character-profiles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <!-- Character Profile Cards will be injected here -->
                    </div>
                </div>

                <!-- ìŠ¤í† ë¦¬ ì”¬ ì„¹ì…˜ -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="card-title" style="margin-bottom: 0;">ğŸ“– ì”¬ ê²€í†  ë° ê·œì¹™ í™•ì¸</h2>
                        <div style="font-size: 0.75rem; color: var(--text-muted);" id="rule-status">ëŒ€ì‚¬ 20ì / ë§í’ì„  2ê°œ ì¤€ìˆ˜ ì¤‘
                        </div>
                    </div>
                    <div id="scenes-container"></div>
                </div>
            </div>

            <div class="actions" id="story-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(2)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="approveScenes()">ì‚¬ìš©ì ì •ì˜ ë ˆì´ì•„ì›ƒ/ìŠ¤íƒ€ì¼ ì„¤ì • â†’</button>
            </div>
        </div>

        <!-- Step 4: ìƒì„¸ ì„¤ì • (Font, Style, Layout, Ratio, Model) -->
        <div class="step-content" id="step-4">
            <div class="card">
                <h2 class="card-title">âš™ï¸ ê³ ë„í™”ëœ ì œì‘ ì„¤ì •</h2>

                <div class="tab-container">
                    <div class="tab active" onclick="switchSettingTab('image')">ê·¸ë¦¼ ìŠ¤íƒ€ì¼</div>
                    <div class="tab" onclick="switchSettingTab('text')">í…ìŠ¤íŠ¸ & í°íŠ¸</div>
                    <div class="tab" onclick="switchSettingTab('layout')">ì¥ë©´ & ë¹„ìœ¨</div>
                </div>

                <!-- Image Settings Tab -->
                <div id="setting-tab-image" class="tab-content active">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ë©”ì¸ ìŠ¤íƒ€ì¼</label>
                            <select id="image-style" onchange="updateSubStyles()">
                                <option value="webtoon">ì›¹íˆ° (ìŠ¤í† ë¦¬í…”ë§ ì¤‘ì‹¬)</option>
                                <option value="card_news">ì¹´ë“œë‰´ìŠ¤ (ì •ë³´ì „ë‹¬ ì¤‘ì‹¬)</option>
                                <option value="simple">ë‹¨ìˆœ ìºëŸ¬ì…€ (ê¹”ë”í•œ ë°°ê²½)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì„¸ë¶€ í™”í’</label>
                            <select id="image-sub-style">
                                <option value="normal">ì¼ë°˜</option>
                                <option value="ghibli">ì§€ë¸Œë¦¬ ìŠ¤íƒ€ì¼</option>
                                <option value="romance">ë¡œë§¨í‹± ì½”ë¯¸ë””</option>
                                <option value="business">ê¹”ë”í•œ ë¹„ì¦ˆë‹ˆìŠ¤</option>
                                <option value="comic">ì½”ë¯¹ ìŠ¤íƒ€ì¼</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸</label>
                        <select id="image-model">
                            <option value="dall-e-3">DALL-E 3 (ê³ í’ˆì§ˆ ê¸°ë³¸)</option>
                            <option value="dall-e-2">DALL-E 2 (ë¹ ë¥¸ ìƒì„±)</option>
                        </select>
                    </div>
                </div>

                <!-- Text Settings Tab -->
                <div id="setting-tab-text" class="tab-content" style="display: none;">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>í°íŠ¸ ì„ íƒ</label>
                            <select id="font-family">
                                <option value="NanumGothic">ë‚˜ëˆ”ê³ ë”• (ê¸°ë³¸)</option>
                                <option value="Bamin">ë°°ë¯¼ì²´ (ìš°ì•„í•œí˜•ì œë“¤)</option>
                                <option value="Malgun">ë§‘ì€ê³ ë”•</option>
                                <option value="Cafe24">Cafe24</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ëŒ€ì‚¬ ê°€ë…ì„± ì˜µì…˜</label>
                            <select id="dialogue-placement">
                                <option value="bubble">ë§í’ì„  (ì¹œê·¼í•¨)</option>
                                <option value="subtitle">í•˜ë‹¨ ìë§‰ (ê°€ë…ì„± ìš°ìˆ˜)</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ëŒ€ì‚¬ í¬ê¸°</label>
                            <input type="range" id="font-size-dialogue" min="18" max="36" value="24"
                                oninput="document.getElementById('fs-d-val').innerText=this.value+'px'">
                            <span id="fs-d-val">24px</span>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ë ˆì´ì…˜ í¬ê¸°</label>
                            <input type="range" id="font-size-narration" min="16" max="30" value="20"
                                oninput="document.getElementById('fs-n-val').innerText=this.value+'px'">
                            <span id="fs-n-val">20px</span>
                        </div>
                    </div>
                </div>

                <!-- Layout Settings Tab -->
                <div id="setting-tab-layout" class="tab-content" style="display: none;">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ì´ë¯¸ì§€ ë¹„ìœ¨</label>
                            <select id="aspect-ratio">
                                <option value="4:5" selected>1080x1350 (ì¸ìŠ¤íƒ€ ì„¸ë¡œ ê¶Œì¥)</option>
                                <option value="1:1">1080x1080 (ì •ì‚¬ê°í˜•)</option>
                                <option value="9:16">1080x1920 (ë¦´ìŠ¤/ìŠ¤í† ë¦¬ìš©)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ì§€ ë²ˆí˜¸ ìœ„ì¹˜</label>
                            <select id="page-number-position">
                                <option value="bottom_right">ìš°ì¸¡ í•˜ë‹¨ (ê¸°ë³¸)</option>
                                <option value="bottom_center">ì¤‘ì•™ í•˜ë‹¨</option>
                                <option value="hide">í‘œì‹œ ì•ˆ í•¨</option>
                            </select>
                        </div>
                    </div>
                </div>


            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="goToStep(3)">â† ì´ì „</button>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ <b
                            id="image-est-time">2</b>ë¶„</span>
                    <button class="btn btn-primary" onclick="startImageGeneration()">ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ğŸš€</button>
                </div>
            </div>
        </div>

        <!-- Step 5: ì´ë¯¸ì§€ ìƒì„± ë° ê²€í†  -->
        <div class="step-content" id="step-5">
            <div class="loading" id="loading-images">
                <div class="spinner"></div>
                <div id="image-progress-text">ì´ë¯¸ì§€ ë Œë”ë§ ì¤‘...</div>
                <div style="margin-top: 1rem; width: 100%; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div
                        style="background: var(--bg-input); border-radius: 10px; height: 12px; overflow: hidden; border: 1px solid var(--border);">
                        <div id="image-progress-bar"
                            style="background: var(--primary); height: 100%; width: 0%; transition: width 0.5s;"></div>
                    </div>
                    <div id="image-progress-detail"
                        style="text-align: right; font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">0 /
                        0</div>
                </div>
            </div>

            <div id="images-review-area" style="display: none;">
                <div class="card">
                    <h2 class="card-title">ğŸï¸ ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼</h2>
                    <div id="images-container"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Generated images will be injected here -->
                    </div>
                </div>
            </div>

            <div class="actions" id="image-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(4)">â† ì´ì „</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="generateCaption()">ìº¡ì…˜ ìƒì„± ë° ë°œí–‰ ì¤€ë¹„ â†’</button>
                </div>
            </div>

            <div class="loading" id="loading-caption" style="display: none;">
                <div class="spinner"></div>
                <div>AIê°€ ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ì¶¤í˜• ìº¡ì…˜ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        </div>

        <!-- Step 6: ìµœì¢… ë°œí–‰ & Instagram Preview -->
        <div class="step-content" id="step-6">
            <div style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem;">
                <!-- Left: Instagram Mockup -->
                <div class="card"
                    style="padding: 0; overflow: hidden; background: #fff; color: #000; border-radius: 12px; border: 1px solid #dbdbdb;">
                    <div
                        style="padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #efefef;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); padding: 2px;">
                            <div
                                style="width: 100%; height: 100%; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">
                                TAX</div>
                        </div>
                        <span style="font-weight: 600; font-size: 14px;">tax_webtoon_pro</span>
                    </div>

                    <div id="insta-preview-carousel"
                        style="aspect-ratio: 1/1; background: #fafafa; position: relative;">
                        <!-- Preview Image will be here -->
                        <img id="insta-preview-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 12px;"
                            id="insta-carousel-index">1 / 8</div>
                    </div>

                    <div style="padding: 12px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                            <span>â¤ï¸</span> <span>ğŸ’¬</span> <span>âœˆï¸</span> <span style="margin-left: auto;">ğŸ”–</span>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">ì¢‹ì•„ìš” 1,234ê°œ</div>
                        <div style="font-size: 14px; line-height: 1.4;">
                            <span style="font-weight: 600; margin-right: 5px;">tax_webtoon_pro</span>
                            <span id="insta-preview-caption-text">AIê°€ ìƒì„±í•œ ìº¡ì…˜ì´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                        </div>
                        <div style="color: #0095f6; font-size: 14px; margin-top: 5px;" id="insta-preview-hashtags">#í•´ì‹œíƒœê·¸
                            #ì›¹íˆ°</div>
                    </div>
                </div>

                <!-- Right: Content Review & Actions -->
                <div>
                    <div class="card" style="padding: 1.5rem;">
                        <h2 class="card-title" style="font-size: 1.25rem;">ğŸ“ ìº¡ì…˜ ë° íƒœê·¸ ìˆ˜ì •</h2>
                        <div class="form-group">
                            <label>ğŸ”¥ í›… ë¬¸ì¥</label>
                            <input type="text" id="final-hook" oninput="updateInstaPreview()">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ ë³¸ë¬¸ ìº¡ì…˜</label>
                            <textarea id="final-body" rows="6" oninput="updateInstaPreview()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ğŸ’¡ ì „ë¬¸ê°€ Tip</label>
                            <input type="text" id="final-tip" oninput="updateInstaPreview()">
                        </div>
                        <div class="form-group">
                            <label>#ï¸âƒ£ í•´ì‹œíƒœê·¸</label>
                            <textarea id="final-hashtags" rows="2" oninput="updateInstaPreview()"></textarea>
                        </div>
                    </div>

                    <div class="card" style="padding: 1.5rem; background: var(--bg-input);">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem;">ğŸš€ ë°œí–‰ ì˜µì…˜</h3>
                        <button class="btn btn-primary" onclick="publishToInstagram()"
                            style="width: 100%; margin-bottom: 0.5rem;">ì¸ìŠ¤íƒ€ê·¸ë¨ ì¦‰ì‹œ ë°œí–‰</button>
                        <button class="btn btn-secondary" onclick="downloadImages()" style="width: 100%;">ì´ë¯¸ì§€ ZIP
                            ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="goToStep(5)">â† ì´ì „ ë‹¨ê³„</button>
            </div>
        </div>
    </main>

    <script>
        let currentStep = 1;
        let sessionId = null;
        let storyData = null;
        let collectedData = [];
        let characters = [];
        let selectedMode = 'auto'; // 'auto' or 'manual'

        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => {
                c.classList.toggle('selected', c.dataset.mode === mode);
            });

            if (mode === 'auto') {
                document.getElementById('keyword-input-area').style.display = 'block';
                document.getElementById('manual-input-area').style.display = 'none';
                document.getElementById('btn-start-next').innerText = 'ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€';
            } else {
                document.getElementById('keyword-input-area').style.display = 'none';
                document.getElementById('manual-input-area').style.display = 'block';
                document.getElementById('btn-start-next').innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
            }
        }

        // --- Step 1: ë¶„ì•¼ ê°ì§€ (Intelligent Start) ---
        async function detectField() {
            const keyword = document.getElementById('keyword').value.trim();
            const model = document.getElementById('ai-model-select').value;

            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.querySelector('#step-1 .btn-secondary');
            const originalText = btn.innerText;
            btn.innerText = 'AI ë¶„ì„ ì¤‘...';
            btn.disabled = true;

            try {
                // 1. ì„¸ì…˜ ì‹œì‘ ë° í•„ë“œ ê°ì§€
                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'auto', keyword, model })
                });
                const data = await res.json();
                sessionId = data.session_id;

                // 2. ì„¸ì…˜ ì •ë³´ ì¡°íšŒ (ê°ì§€ëœ ê²°ê³¼ í™•ì¸)
                const sessionRes = await fetch(`/api/workflow/session/${sessionId}`);
                const session = await sessionRes.json();
                const info = session.field_info;

                // 3. Step 1 ê²°ê³¼ UI í‘œì‹œ
                document.getElementById('smart-analysis-result').style.display = 'block';
                // ê¸°ì¡´ ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€
                document.getElementById('btn-start-next').style.display = 'none';

                // ê°’ ë°”ì¸ë”©
                document.getElementById('confirmed-field').value = info.field_code || 'GENERAL';
                document.getElementById('confirmed-year').innerText = info.target_year || new Date().getFullYear();
                document.getElementById('hidden-target-year').value = info.target_year || new Date().getFullYear();

                if (info.requires_legal_verification) {
                    document.getElementById('verification-needed-badge').style.display = 'flex';
                } else {
                    document.getElementById('verification-needed-badge').style.display = 'none';
                }

                btn.innerText = 'ë‹¤ì‹œ ê°ì§€';
                btn.disabled = false;

            } catch (e) {
                console.error("Detect Field Error:", e);
                alert('ë¶„ì•¼ ê°ì§€ ì˜¤ë¥˜: ' + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function confirmAndStart() {
            // ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ê°’ (í˜¹ì€ AI ê°’)ìœ¼ë¡œ í™•ì •
            const finalField = document.getElementById('confirmed-field').value;
            const finalYear = document.getElementById('hidden-target-year').value;

            // Step 1 -> Step 2
            navigateToStep(2);
            startDataCollection();
        }

        async function startWorkflow() {
            if (selectedMode === 'manual') {
                // ìˆ˜ë™ ëª¨ë“œ: ì‚¬ìš©ìê°€ ì…ë ¥í•œ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±
                const manualContent = document.getElementById('manual-script').value.trim();
                if (!manualContent) {
                    alert('ì‹œë‚˜ë¦¬ì˜¤ ë˜ëŠ” í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const btn = document.getElementById('btn-start-next');
                btn.innerText = 'ì…ë ¥ ë‚´ìš© ì •ë¦¬ ì¤‘...';
                btn.disabled = true;

                try {
                    // ì„¸ì…˜ ìƒì„± (ìˆ˜ë™ ëª¨ë“œ)
                    const startRes = await fetch('/api/workflow/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'manual' })
                    });
                    const startData = await startRes.json();
                    sessionId = startData.session_id;

                    // Step 2ë¡œ ì´ë™
                    goToStep(2);

                    // ìˆ˜ë™ ëª¨ë“œ ì „ìš© ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ í˜¸ì¶œ
                    await collectManualData(manualContent);

                    btn.innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
                    btn.disabled = false;
                } catch (e) {
                    console.error(e);
                    alert('ìˆ˜ë™ ëª¨ë“œ ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                    btn.innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
                    btn.disabled = false;
                }
                return;
            }

            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // [ë³€ê²½] ê°ì§€ ë‹¨ê³„ ì—†ì´ ë°”ë¡œ ì‹œì‘
            // ë¨¼ì € ì„¸ì…˜ì„ ìƒì„±í•˜ê³ 
            const model = document.getElementById('ai-model-select').value;
            try {
                const btn = document.getElementById('btn-start-next');
                btn.innerText = 'AIê°€ ë¶„ì„ ë° ì‹œì‘ ì¤‘...';
                btn.disabled = true;

                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'auto', keyword, model })
                });
                const data = await res.json();
                sessionId = data.session_id;

                btn.innerText = 'ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€';
                btn.disabled = false;

                // ë°”ë¡œ ìë£Œ ìˆ˜ì§‘ ë‹¨ê³„ë¡œ ì´ë™
                goToStep(2);
                collectData();

            } catch (e) {
                console.error(e);
                alert('ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                document.getElementById('btn-start-next').disabled = false;
            }
        }

        // --- Step 2: ìˆ˜ë™ ëª¨ë“œ ìë£Œ íŒŒì‹± ---
        async function collectManualData(content) {
            const loadingEl = document.getElementById('loading-data');
            const reviewArea = document.getElementById('data-review-area');
            const actionsEl = document.getElementById('data-actions');

            // ë¡œë”© ë©”ì‹œì§€ ë³€ê²½ (ìˆ˜ë™ ëª¨ë“œìš©)
            loadingEl.querySelector('div:last-child').innerText = 'ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            try {
                const res = await fetch('/api/workflow/parse-manual-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        content: content
                    })
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'íŒŒì‹± ì˜¤ë¥˜');
                }

                collectedData = data.items || [];

                renderDataItems();

                // ì”¬ ìˆ˜ ì¶”ì²œ (ìˆ˜ë™ ëª¨ë“œ)
                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ë‚´ìš© íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        // --- Step 2: ìë£Œ ìˆ˜ì§‘ ---
        async function collectData() {
            const loadingEl = document.getElementById('loading-data');
            const reviewArea = document.getElementById('data-review-area');
            const actionsEl = document.getElementById('data-actions');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            try {
                const keyword = document.getElementById('keyword').value;
                const model = document.getElementById('ai-model-select').value;

                const res = await fetch('/api/workflow/collect-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, keyword, model })
                });
                const data = await res.json();
                collectedData = data.items || [];

                renderDataItems();

                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ìë£Œ ìˆ˜ì§‘ ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function renderDataItems() {
            const container = document.getElementById('data-container');
            container.innerHTML = collectedData.map((item, idx) => `
                <div class="char-card" style="cursor:pointer; margin-bottom: 0.5rem; align-items: flex-start; flex-direction: column;" onclick="toggleDataBody(${idx})">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <span style="font-weight: 600;">ğŸ“„ ${item.title}</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); editData(${idx})">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteData(${idx})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div id="data-body-${idx}" style="display: block; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; border-top: 1px solid var(--border); padding-top: 0.5rem; width: 100%;">
                        ${item.content}
                    </div>
                </div>
            `).join('');
        }

        function toggleDataBody(idx) {
            const el = document.getElementById(`data-body-${idx}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function confirmData() {
            goToStep(3);
            generateStory();
        }

        // --- Step 3: ìŠ¤í† ë¦¬ ìƒì„± ---
        async function generateStory() {
            const loadingEl = document.getElementById('loading-story');
            const reviewArea = document.getElementById('story-review-area');
            const actionsEl = document.getElementById('story-actions');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            const sceneCount = parseInt(document.getElementById('total-scene-count').value);

            try {
                const res = await fetch('/api/workflow/generate-story', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        scene_count: sceneCount,
                        questioner_type: 'ì¼ë°˜ì¸',
                        expert_type: 'ì„¸ë¬´ì‚¬'
                    })
                });
                const data = await res.json();
                storyData = data.story;
                characters = storyData.characters || [];

                renderCharacters();
                renderScenes(storyData.scenes);

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ìŠ¤í† ë¦¬ ìƒì„± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function renderCharacters() {
            const container = document.getElementById('character-profiles');
            container.innerHTML = characters.map(c => `
                <div class="char-card">
                    <div class="char-avatar">ğŸ‘¤</div>
                    <div class="char-info">
                        <div class="char-name">${c.name} <span class="char-role">${c.role}</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${c.appearance}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderScenes(scenes) {
            const container = document.getElementById('scenes-container');
            container.innerHTML = scenes.map(s => {
                const densityWarnings = validateSceneRules(s);
                return `
                <div class="card" style="margin-bottom: 1rem; border: 1px solid ${densityWarnings.length > 0 ? 'var(--warning)' : 'var(--border)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600;">ì”¬ ${s.scene_number}</span>
                        <div style="display: flex; gap: 0.5rem;">
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;">ìˆ˜ì •</button>
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;">ì¬ìƒì„±</button>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">ğŸ¬ ${s.scene_description}</div>
                    ${s.dialogues.map(d => `
                        <div style="background: var(--bg-input); padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; font-size: 0.875rem;">
                            <span style="font-weight: 600; color: var(--primary);">${d.character}:</span> ${d.text}
                            <span style="float: right; font-size: 0.7rem; color: var(--text-muted);">[${d.emotion}]</span>
                        </div>
                    `).join('')}
                    ${s.narration ? `<div style="font-style: italic; color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">ğŸ’¬ ${s.narration}</div>` : ''}
                    
                    ${densityWarnings.map(w => `
                        <div class="rule-warning">âš ï¸ ${w}</div>
                    `).join('')}
                    
                    ${densityWarnings.length > 0 ? `
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.75rem; background: rgba(255, 152, 0, 0.1);">ìë™ ì”¬ ë¶„í• </button>
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        function validateSceneRules(scene) {
            const warnings = [];
            scene.dialogues.forEach(d => {
                if (d.text.length > 20) warnings.push(`${d.character} ëŒ€ì‚¬ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${d.text.length}ì)`);
            });
            if (scene.dialogues.length > 2) warnings.push(`ë§í’ì„ ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤ (${scene.dialogues.length}ê°œ)`);
            if (scene.narration && scene.narration.length > 30) warnings.push(`ë‚˜ë ˆì´ì…˜ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${scene.narration.length}ì)`);
            return warnings;
        }

        function approveScenes() {
            goToStep(4);
            document.getElementById('image-scene-count').innerText = storyData.scenes.length;
            document.getElementById('image-est-time').innerText = Math.ceil(storyData.scenes.length * 0.25);
        }

        // --- Step 4: ì„¤ì • íƒ­ ê´€ë¦¬ ---
        function switchSettingTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`setting-tab-${tab}`).style.display = 'block';
        }

        // --- Step 5: ì´ë¯¸ì§€ ìƒì„± ---
        async function startImageGeneration() {
            goToStep(5);
            const loadingEl = document.getElementById('loading-images');
            const reviewArea = document.getElementById('images-review-area');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';

            const sceneCount = storyData.scenes.length;
            const style = document.getElementById('image-style').value;
            const subStyle = document.getElementById('image-sub-style').value;
            const ratio = document.getElementById('aspect-ratio').value;

            try {
                await fetch('/api/workflow/generate-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        style: style,
                        sub_style: subStyle,
                        aspect_ratio: ratio
                    })
                });

                checkImageProgress(sceneCount);
            } catch (e) {
                alert('ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function checkImageProgress(total) {
            let current = 0;
            const progressBar = document.getElementById('image-progress-bar');
            const progressDetail = document.getElementById('image-progress-detail');
            const loadingEl = document.getElementById('loading-images');
            const reviewArea = document.getElementById('images-review-area');
            const actionsEl = document.getElementById('image-actions');

            const interval = setInterval(async () => {
                const res = await fetch(`/api/workflow/session/${sessionId}`);
                const session = await res.json();
                current = session.images ? session.images.filter(img => img.status === 'generated').length : 0;

                const progress = (current / total) * 100;
                progressBar.style.width = `${progress}%`;
                progressDetail.innerText = `${current} / ${total}`;

                if (current >= total) {
                    clearInterval(interval);
                    renderFinalImages(session.images);
                    loadingEl.style.display = 'none';
                    reviewArea.style.display = 'block';
                    actionsEl.style.display = 'flex';
                }
            }, 2000);
        }

        function renderFinalImages(images) {
            const container = document.getElementById('images-container');
            container.innerHTML = images.map(img => `
                <div class="card" style="padding: 0.5rem;">
                    <img src="${img.local_path}" style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="font-size: 0.75rem; font-weight: 600;">ì”¬ ${img.scene_number}</div>
                    <button class="btn btn-secondary" style="width: 100%; padding: 4px; font-size: 0.75rem; margin-top: 0.5rem;">ê°œë³„ ì¬ìƒì„±</button>
                </div>
            `).join('');
        }

        // --- Step 5: ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ í›„ ìº¡ì…˜ ìƒì„± ì‹œì‘ ---
        async function generateCaption() {
            const loadingEl = document.getElementById('loading-caption');
            loadingEl.style.display = 'block';

            try {
                const res = await fetch('/api/workflow/generate-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await res.json();
                const caption = data.caption;

                // Step 6 ì…ë ¥ í•„ë“œ ì„¸íŒ…
                document.getElementById('final-hook').value = caption.hook;
                document.getElementById('final-body').value = caption.body;
                document.getElementById('final-tip').value = caption.tip;
                document.getElementById('final-hashtags').value = caption.hashtags.join(' ');

                loadingEl.style.display = 'none';
                goToStep(6);
                updateInstaPreview();
            } catch (e) {
                alert('ìº¡ì…˜ ìƒì„± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function updateInstaPreview() {
            const hook = document.getElementById('final-hook').value;
            const body = document.getElementById('final-body').value;
            const tip = document.getElementById('final-tip').value;
            const hashtags = document.getElementById('final-hashtags').value;

            const fullText = `${hook}\n\n${body}\n\nğŸ’¡ Tip: ${tip}`;
            document.getElementById('insta-preview-caption-text').innerText = fullText;
            document.getElementById('insta-preview-hashtags').innerText = hashtags;

            // ì´ë¯¸ì§€ í”„ë¦¬ì…‹ (ì²« ë²ˆì§¸ ì´ë¯¸ì§€ í‘œì‹œ)
            const firstImg = document.querySelector('#images-container img');
            if (firstImg) {
                document.getElementById('insta-preview-img').src = firstImg.src;
            }

            const totalImages = document.querySelectorAll('#images-container img').length;
            document.getElementById('insta-carousel-index').innerText = `1 / ${totalImages}`;
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            document.querySelectorAll('.step').forEach(s => {
                const sNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'done');
                if (sNum < step) s.classList.add('done');
                if (sNum === step) s.classList.add('active');
            });

            if (step === 6) {
                updateInstaPreview();
            }
        }

        function navigateToStep(step) {
            if (step <= currentStep) goToStep(step);
        }
    </script>
</body>

</html>