<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Progress Steps */
        .progress-bar {
            background: var(--bg-card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step:hover {
            color: var(--primary);
        }

        .step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step.done {
            color: var(--success);
        }

        .step.done:hover {
            color: var(--primary);
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step.active .step-num {
            background: var(--primary);
            color: white;
        }

        .step.done .step-num {
            background: var(--success);
            color: white;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 0.5rem;
        }

        .step.done+.step-line {
            background: var(--success);
        }

        /* Main Content */
        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .card-desc {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mode Selection */
        .mode-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .mode-card {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--primary);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .mode-card.selected {
            background: rgba(99, 102, 241, 0.1);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .mode-title {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .mode-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Scene Cards */
        .scene-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .scene-num {
            font-weight: 700;
            color: var(--primary);
        }

        .scene-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--warning);
            color: black;
        }

        .scene-status.approved {
            background: var(--success);
        }

        .scene-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .dialogue {
            background: var(--bg-card);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .dialogue-char {
            font-weight: 600;
            color: var(--primary);
        }

        .warning {
            color: var(--warning);
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Footer Actions */
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Hide/Show Steps */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <header>
        <a href="/" class="logo" style="text-decoration: none;">ğŸ¨ Tax Webtoon Auto-Generator</a>
        <div><a href="/settings" style="color: var(--text-muted); text-decoration: none;">âš™ï¸ ì„¤ì •</a></div>
    </header>

    <div class="progress-bar">
        <div class="steps">
            <div class="step active" data-step="1" onclick="navigateToStep(1)"><span class="step-num">1</span> ì‹œì‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="2" onclick="navigateToStep(2)"><span class="step-num">2</span> ìë£Œ</div>
            <div class="step-line"></div>
            <div class="step" data-step="3" onclick="navigateToStep(3)"><span class="step-num">3</span> ìŠ¤í† ë¦¬</div>
            <div class="step-line"></div>
            <div class="step" data-step="4" onclick="navigateToStep(4)"><span class="step-num">4</span> ì´ë¯¸ì§€</div>
            <div class="step-line"></div>
            <div class="step" data-step="5" onclick="navigateToStep(5)"><span class="step-num">5</span> ìº¡ì…˜</div>
            <div class="step-line"></div>
            <div class="step" data-step="6" onclick="navigateToStep(6)"><span class="step-num">6</span> ë°œí–‰</div>
        </div>
    </div>

    <main>
        <!-- Step 1: ì‹œì‘ -->
        <div class="step-content active" id="step-1">
            <div class="card">
                <h2 class="card-title">ğŸš€ ì›¹íˆ° ìƒì„± ì‹œì‘</h2>
                <p class="card-desc">ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì‹œì‘í• ê¹Œìš”?</p>

                <div class="mode-cards">
                    <div class="mode-card selected" data-mode="auto" onclick="selectMode('auto')">
                        <div class="mode-icon">ğŸ”„</div>
                        <div class="mode-title">ìë™ ëª¨ë“œ</div>
                        <div class="mode-desc">í‚¤ì›Œë“œë§Œ ì…ë ¥í•˜ë©´ AIê°€ ìë™ ìƒì„±</div>
                    </div>
                    <div class="mode-card" data-mode="manual" onclick="selectMode('manual')">
                        <div class="mode-icon">âœï¸</div>
                        <div class="mode-title">ìˆ˜ë™ ëª¨ë“œ</div>
                        <div class="mode-desc">ì§ì ‘ ë‚´ìš©ì„ ì…ë ¥í•©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>

            <div class="card" id="keyword-card">
                <div class="form-group">
                    <label for="keyword">ì£¼ì œ í‚¤ì›Œë“œ</label>
                    <input type="text" id="keyword" placeholder="ì˜ˆ: ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ , í‡´ì§ê¸ˆ ê³„ì‚°ë²•">
                </div>

                <div id="field-result" style="display: none; margin-bottom: 1rem;">
                    <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px;">
                        <strong>ğŸ“‹ AI ë¶„ì„ ê²°ê³¼:</strong>
                        <div style="margin-top: 0.5rem;">
                            ë¶„ì•¼: <span id="detected-field" style="color: var(--primary); font-weight: 600;">-</span>
                            <span id="verification-badge"
                                style="margin-left: 0.5rem; font-size: 0.75rem; background: var(--warning); color: black; padding: 2px 6px; border-radius: 4px; display: none;">ë²•ë ¹
                                ê²€ì¦ í•„ìš”</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ì”¬ ê°œìˆ˜</label>
                    <select id="scene-count">
                        <option value="6">6ê°œ (ê°„ë‹¨)</option>
                        <option value="8" selected>8ê°œ (ê¸°ë³¸)</option>
                        <option value="10">10ê°œ (ìƒì„¸)</option>
                        <option value="15">15ê°œ (ì‹œë¦¬ì¦ˆ ë¶„í• )</option>
                    </select>
                </div>
            </div>

            <div class="actions">
                <div></div>
                <button class="btn btn-primary" onclick="startWorkflow()">ì‹œì‘í•˜ê¸° â†’</button>
            </div>
        </div>

        <!-- Step 2: ìë£Œ ìˆ˜ì§‘ ê²€í†  -->
        <div class="step-content" id="step-2">
            <div class="loading" id="loading-data">
                <div class="spinner"></div>
                <div>ìë£Œë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div class="card" id="data-review" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="card-title" style="margin-bottom: 0;">ğŸ“š ìˆ˜ì§‘ëœ ìë£Œ ê²€í† </h2>
                    <select id="data-model" style="width: auto; padding: 0.5rem;">
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    </select>
                </div>
                <p class="card-desc">AIê°€ ìˆ˜ì§‘í•œ ìë£Œë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”. ë¶ˆí•„ìš”í•œ ë‚´ìš©ì€ ì‚­ì œí•˜ê³ , ì¶”ê°€í•  ë‚´ìš©ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”.</p>

                <div id="data-container"></div>

                <div class="form-group" style="margin-top: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="new-data-input" placeholder="ì¶”ê°€í•  ìë£Œ ë‚´ìš© ì…ë ¥..." style="flex: 1;">
                        <button class="btn btn-secondary" onclick="addDataItem()">+ ì¶”ê°€</button>
                    </div>
                </div>
            </div>

            <div class="actions" id="data-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(1)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="confirmData()">ìë£Œ í™•ì • â†’ ìŠ¤í† ë¦¬ ìƒì„±</button>
            </div>
        </div>

        <!-- Step 3: ìŠ¤í† ë¦¬ ê²€í†  -->
        <div class="step-content" id="step-3">
            <div class="loading" id="loading-story">
                <div class="spinner"></div>
                <div>ìŠ¤í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div class="card" id="story-review" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="card-title" style="margin-bottom: 0;">ğŸ“– ì”¬ ê²€í† </h2>
                    <select id="story-model" style="width: auto; padding: 0.5rem;">
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    </select>
                </div>
                <p class="card-desc">ìƒì„±ëœ ìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”.</p>

                <div id="scenes-container"></div>

                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="addNewScene()">+ ì”¬ ì¶”ê°€</button>
                    <button class="btn btn-secondary" onclick="regenerateAllScenes()">ğŸ”„ ì „ì²´ ì¬ìƒì„±</button>
                </div>
            </div>

            <div class="actions" id="story-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(2)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="approveScenes()">ëª¨ë“  ì”¬ í™•ì • â†’ ì´ë¯¸ì§€ ìƒì„±</button>
            </div>
        </div>

        <!-- Step 4: ì´ë¯¸ì§€ ê²€í†  -->
        <div class="step-content" id="step-4">
            <div class="loading" id="loading-images">
                <div class="spinner"></div>
                <div>ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                <div style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">ì”¬ë‹¹ ì•½ 10-15ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤.</div>
            </div>

            <div class="card" id="images-review" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="card-title" style="margin-bottom: 0;">ğŸ–¼ï¸ ì´ë¯¸ì§€ ê²€í† </h2>
                    <select id="image-model" style="width: auto; padding: 0.5rem;">
                        <option value="dall-e-3">DALL-E 3 (ê³ í’ˆì§ˆ)</option>
                        <option value="dall-e-2">DALL-E 2 (ê²½ì œì )</option>
                        <option value="gpt-image-1">GPT Image 1 (ìµœì‹ )</option>
                    </select>
                </div>
                <p class="card-desc">ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”. ë¶ˆë§Œì¡±ìŠ¤ëŸ¬ìš´ ì´ë¯¸ì§€ëŠ” ê°œë³„ ì¬ìƒì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

                <div id="images-container"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                </div>
            </div>

            <div class="actions" id="images-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(3)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="generateCaption()">ìº¡ì…˜ ìƒì„± â†’</button>
            </div>
        </div>

        <!-- Step 5: ìº¡ì…˜ ê²€í†  -->
        <div class="step-content" id="step-5">
            <div class="loading" id="loading-caption">
                <div class="spinner"></div>
                <div>ìº¡ì…˜ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div class="card" id="caption-review" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="card-title" style="margin-bottom: 0;">ğŸ“ ìº¡ì…˜ ê²€í† </h2>
                    <select id="caption-model" style="width: auto; padding: 0.5rem;">
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ”¥ í›… ë¬¸ì¥ (ì²« ì¤„)</label>
                    <input type="text" id="caption-hook">
                </div>

                <div class="form-group">
                    <label>ğŸ“ ë³¸ë¬¸ ìº¡ì…˜</label>
                    <textarea id="caption-body" rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label>ğŸ’¡ ì „ë¬¸ê°€ Tip</label>
                    <input type="text" id="caption-tip">
                </div>

                <div class="form-group">
                    <label>#ï¸âƒ£ í•´ì‹œíƒœê·¸</label>
                    <textarea id="caption-hashtags" rows="2" placeholder="#íƒœê·¸1 #íƒœê·¸2 ..."></textarea>
                </div>
            </div>

            <div class="actions" id="caption-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(4)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="goToStep(6)">ìµœì¢… í™•ì¸ â†’</button>
            </div>
        </div>

        <!-- Step 6: ìµœì¢… ë°œí–‰ -->
        <div class="step-content" id="step-6">
            <div class="card">
                <h2 class="card-title">ğŸš€ ìµœì¢… í™•ì¸ ë° ë°œí–‰</h2>
                <p class="card-desc">ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>

                <div id="final-preview" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">âœ…</div>
                    <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">ì›¹íˆ° ìƒì„± ì™„ë£Œ!</div>
                    <div style="color: var(--text-muted);">ì¸ìŠ¤íƒ€ê·¸ë¨ì— ë°œí–‰í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="goToStep(5)">â† ì´ì „</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="downloadImages()">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="publishToInstagram()">ğŸ“± ì¸ìŠ¤íƒ€ê·¸ë¨ ë°œí–‰</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentStep = 1;
        let sessionId = null;
        let selectedMode = 'auto';
        let storyData = null;
        let imagesData = null;
        let captionData = null;

        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
        }

        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            document.querySelectorAll('.step').forEach(s => {
                const sNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'done');
                if (sNum < step) s.classList.add('done');
                if (sNum === step) s.classList.add('active');
            });
        }

        // ì§„í–‰ ë‹¨ê³„ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ê³„ë¡œ ì´ë™ (ì™„ë£Œëœ ë‹¨ê³„ë§Œ ê°€ëŠ¥)
        function navigateToStep(step) {
            const stepEl = document.querySelector(`[data-step="${step}"]`);
            // í˜„ì¬ ë‹¨ê³„ì´ê±°ë‚˜ ì™„ë£Œëœ ë‹¨ê³„ë§Œ ì´ë™ ê°€ëŠ¥
            if (step <= currentStep || stepEl.classList.contains('done')) {
                goToStep(step);
            }
        }

        async function startWorkflow() {
            const keyword = document.getElementById('keyword').value;
            if (!keyword && selectedMode === 'auto') {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: selectedMode, keyword })
                });
                const data = await res.json();
                sessionId = data.session_id;

                if (data.field) {
                    document.getElementById('field-result').style.display = 'block';
                    document.getElementById('detected-field').textContent = data.field;
                    if (data.field_requires_verification) {
                        document.getElementById('verification-badge').style.display = 'inline';
                    }
                }

                goToStep(2);
                collectData();
            } catch (e) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        }

        // ìë£Œ ìˆ˜ì§‘ ë°ì´í„°
        let collectedData = [];

        async function collectData() {
            document.getElementById('loading-data').classList.add('show');
            document.getElementById('data-review').style.display = 'none';
            document.getElementById('data-actions').style.display = 'none';

            try {
                const model = document.getElementById('data-model')?.value || 'gemini-2.0-flash';
                const keyword = document.getElementById('keyword').value;

                const res = await fetch('/api/workflow/collect-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, keyword, model })
                });
                const data = await res.json();
                collectedData = data.items || [];

                renderDataItems();

                document.getElementById('loading-data').classList.remove('show');
                document.getElementById('data-review').style.display = 'block';
                document.getElementById('data-actions').style.display = 'flex';
            } catch (e) {
                // APIê°€ ì•„ì§ ì—†ìœ¼ë©´ ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
                const keyword = document.getElementById('keyword').value;
                collectedData = [
                    `${keyword}ì˜ ê¸°ë³¸ ê°œë…ê³¼ ì •ì˜`,
                    `${keyword} ê´€ë ¨ ìµœì‹  ë²•ë ¹ ë° ê·œì •`,
                    `${keyword} ì‹ ê³ /ì‹ ì²­ ë°©ë²• ë° ì ˆì°¨`,
                    `${keyword} ì‹œ ì£¼ì˜ì‚¬í•­ ë° íŒ`,
                    `${keyword} ê´€ë ¨ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸`
                ];
                renderDataItems();
                document.getElementById('loading-data').classList.remove('show');
                document.getElementById('data-review').style.display = 'block';
                document.getElementById('data-actions').style.display = 'flex';
            }
        }

        function renderDataItems() {
            const container = document.getElementById('data-container');
            container.innerHTML = collectedData.map((item, idx) => `
                <div class="scene-card" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">ğŸ“„ ${item}</div>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteDataItem(${idx})">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            `).join('');
        }

        function deleteDataItem(idx) {
            collectedData.splice(idx, 1);
            renderDataItems();
        }

        function addDataItem() {
            const input = document.getElementById('new-data-input');
            if (input.value.trim()) {
                collectedData.push(input.value.trim());
                input.value = '';
                renderDataItems();
            }
        }

        async function confirmData() {
            goToStep(3);
            generateStory();
        }

        async function generateStory() {
            document.getElementById('loading-story').classList.add('show');
            document.getElementById('story-review').style.display = 'none';
            document.getElementById('story-actions').style.display = 'none';

            const sceneCount = parseInt(document.getElementById('scene-count').value);

            try {
                const res = await fetch('/api/workflow/generate-story', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, scene_count: sceneCount })
                });
                const data = await res.json();
                storyData = data.story;

                renderScenes(storyData.scenes);

                document.getElementById('loading-story').classList.remove('show');
                document.getElementById('story-review').style.display = 'block';
                document.getElementById('story-actions').style.display = 'flex';
            } catch (e) {
                alert('ìŠ¤í† ë¦¬ ìƒì„± ì˜¤ë¥˜: ' + e.message);
            }
        }

        function renderScenes(scenes) {
            const container = document.getElementById('scenes-container');
            container.innerHTML = scenes.map((scene, idx) => `
                <div class="scene-card" id="scene-card-${idx}">
                    <div class="scene-header">
                        <span class="scene-num">ì”¬ ${scene.scene_number}</span>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="regenerateScene(${idx})">ğŸ”„ ì¬ìƒì„±</button>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="toggleEditScene(${idx})">âœï¸ ìˆ˜ì •</button>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--danger);" onclick="deleteScene(${idx})">ğŸ—‘ï¸</button>
                            <span class="scene-status ${scene.status === 'approved' ? 'approved' : ''}">${scene.status === 'approved' ? 'í™•ì •' : 'ê²€í†  í•„ìš”'}</span>
                        </div>
                    </div>
                    
                    <!-- ë³´ê¸° ëª¨ë“œ -->
                    <div class="scene-view" id="scene-view-${idx}">
                        <div class="scene-desc">ğŸ¬ ${scene.scene_description}</div>
                        ${scene.dialogues.map(d => `
                            <div class="dialogue">
                                <span class="dialogue-char">${d.character}:</span> "${d.text}"
                            </div>
                        `).join('')}
                        ${scene.narration ? `<div class="dialogue" style="font-style: italic;">ğŸ“– ${scene.narration}</div>` : ''}
                        ${scene.warnings && scene.warnings.length ? scene.warnings.map(w => `<div class="warning">âš ï¸ ${w}</div>`).join('') : ''}
                    </div>
                    
                    <!-- ìˆ˜ì • ëª¨ë“œ -->
                    <div class="scene-edit" id="scene-edit-${idx}" style="display: none;">
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                            <label style="font-size: 0.75rem;">ì¥ë©´ ì„¤ëª…</label>
                            <textarea id="edit-desc-${idx}" rows="2" style="font-size: 0.875rem;">${scene.scene_description}</textarea>
                        </div>
                        ${scene.dialogues.map((d, dIdx) => `
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <label style="font-size: 0.75rem;">${d.character} ëŒ€ì‚¬</label>
                                <input type="text" id="edit-dialogue-${idx}-${dIdx}" value="${d.text}" style="font-size: 0.875rem;">
                            </div>
                        `).join('')}
                        ${scene.narration !== undefined ? `
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <label style="font-size: 0.75rem;">ë‚˜ë ˆì´ì…˜</label>
                                <input type="text" id="edit-narration-${idx}" value="${scene.narration || ''}" style="font-size: 0.875rem;">
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;" onclick="toggleEditScene(${idx})">ì·¨ì†Œ</button>
                            <button class="btn btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;" onclick="saveScene(${idx})">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleEditScene(idx) {
            const viewEl = document.getElementById(`scene-view-${idx}`);
            const editEl = document.getElementById(`scene-edit-${idx}`);
            if (viewEl.style.display === 'none') {
                viewEl.style.display = 'block';
                editEl.style.display = 'none';
            } else {
                viewEl.style.display = 'none';
                editEl.style.display = 'block';
            }
        }

        function saveScene(idx) {
            const scene = storyData.scenes[idx];
            scene.scene_description = document.getElementById(`edit-desc-${idx}`).value;

            scene.dialogues.forEach((d, dIdx) => {
                const input = document.getElementById(`edit-dialogue-${idx}-${dIdx}`);
                if (input) d.text = input.value;
            });

            const narrationInput = document.getElementById(`edit-narration-${idx}`);
            if (narrationInput) scene.narration = narrationInput.value;

            scene.status = 'approved';
            renderScenes(storyData.scenes);
        }


        async function approveScenes() {
            try {
                await fetch(`/api/workflow/approve-scenes?session_id=${sessionId}`, { method: 'POST' });
                goToStep(4);
                generateImages();
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }
        }

        async function generateImages() {
            document.getElementById('loading-images').classList.add('show');
            document.getElementById('images-review').style.display = 'none';
            document.getElementById('images-actions').style.display = 'none';

            try {
                const res = await fetch('/api/workflow/generate-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, style: 'webtoon', sub_style: 'normal' })
                });
                const data = await res.json();
                imagesData = data.images;

                const container = document.getElementById('images-container');
                container.innerHTML = imagesData.map(img => `
                    <div style="background: var(--bg-input); border-radius: 8px; overflow: hidden;">
                        ${img.image_url ? `<img src="${img.image_url}" style="width: 100%; aspect-ratio: 4/5; object-fit: cover;">` : '<div style="width: 100%; aspect-ratio: 4/5; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">ìƒì„± ì‹¤íŒ¨</div>'}
                        <div style="padding: 0.5rem; text-align: center; font-size: 0.875rem;">ì”¬ ${img.scene_number}</div>
                    </div>
                `).join('');

                document.getElementById('loading-images').classList.remove('show');
                document.getElementById('images-review').style.display = 'block';
                document.getElementById('images-actions').style.display = 'flex';
            } catch (e) {
                alert('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜: ' + e.message);
            }
        }

        async function generateCaption() {
            goToStep(5);
            document.getElementById('loading-caption').classList.add('show');
            document.getElementById('caption-review').style.display = 'none';
            document.getElementById('caption-actions').style.display = 'none';

            try {
                const res = await fetch('/api/workflow/generate-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await res.json();
                captionData = data.caption;

                document.getElementById('caption-hook').value = captionData.hook;
                document.getElementById('caption-body').value = captionData.body;
                document.getElementById('caption-tip').value = captionData.expert_tip;
                document.getElementById('caption-hashtags').value = captionData.hashtags.join(' ');

                document.getElementById('loading-caption').classList.remove('show');
                document.getElementById('caption-review').style.display = 'block';
                document.getElementById('caption-actions').style.display = 'flex';
            } catch (e) {
                alert('ìº¡ì…˜ ìƒì„± ì˜¤ë¥˜: ' + e.message);
            }
        }

        function downloadImages() {
            if (!imagesData || imagesData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            // ê° ì´ë¯¸ì§€ë¥¼ ê°œë³„ ë‹¤ìš´ë¡œë“œ (ZIPì€ ë°±ì—”ë“œ í•„ìš”)
            imagesData.forEach((img, idx) => {
                if (img.image_url) {
                    const a = document.createElement('a');
                    a.href = img.image_url;
                    a.download = `scene_${img.scene_number}.png`;
                    a.target = '_blank';
                    a.click();
                }
            });
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì— ë”°ë¼ ì—¬ëŸ¬ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.');
        }

        async function publishToInstagram() {
            const hook = document.getElementById('caption-hook').value;
            const body = document.getElementById('caption-body').value;
            const tip = document.getElementById('caption-tip').value;
            const hashtags = document.getElementById('caption-hashtags').value;

            const fullCaption = `${hook}\n\n${body}\n\nğŸ’¡ ${tip}\n\n${hashtags}`;

            if (!confirm('Instagramì— ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' + fullCaption.substring(0, 200) + '...')) {
                return;
            }

            try {
                const res = await fetch('/api/workflow/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        caption: fullCaption,
                        images: imagesData.map(i => i.image_url).filter(Boolean)
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('ğŸ‰ Instagram ë°œí–‰ ì™„ë£Œ!\n\nê²Œì‹œë¬¼ ID: ' + data.post_id);
                } else {
                    alert('ë°œí–‰ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (e) {
                alert('Instagram ë°œí–‰ì„ ìœ„í•´ì„œëŠ” ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n' + e.message);
            }
        }

        // ì”¬ ì¶”ê°€
        function addNewScene() {
            const newSceneNum = storyData.scenes.length + 1;
            const newScene = {
                scene_number: newSceneNum,
                scene_description: 'ìƒˆë¡œìš´ ì”¬ - í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”',
                dialogues: [
                    { character: 'ë¯¼ì§€', text: 'ëŒ€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”' }
                ],
                narration: '',
                status: 'pending',
                warnings: []
            };
            storyData.scenes.push(newScene);
            renderScenes(storyData.scenes);
        }

        // ì”¬ ì‚­ì œ
        function deleteScene(idx) {
            if (confirm(`ì”¬ ${idx + 1}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                storyData.scenes.splice(idx, 1);
                // ì”¬ ë²ˆí˜¸ ì¬ì •ë ¬
                storyData.scenes.forEach((s, i) => s.scene_number = i + 1);
                renderScenes(storyData.scenes);
            }
        }

        // ì”¬ ì¬ìƒì„±
        async function regenerateScene(idx) {
            const scene = storyData.scenes[idx];
            const model = document.getElementById('story-model')?.value || 'gemini-2.0-flash';

            try {
                const res = await fetch('/api/workflow/regenerate-scene', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        scene_index: idx,
                        model
                    })
                });
                const data = await res.json();
                if (data.scene) {
                    storyData.scenes[idx] = data.scene;
                    renderScenes(storyData.scenes);
                }
            } catch (e) {
                alert('ì¬ìƒì„± ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ì „ì²´ ì”¬ ì¬ìƒì„±
        async function regenerateAllScenes() {
            if (!confirm('ëª¨ë“  ì”¬ì„ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            generateStory();
        }

        // ì´ë¯¸ì§€ ì¬ìƒì„±
        async function regenerateImage(sceneIndex) {
            const model = document.getElementById('image-model')?.value || 'dall-e-3';

            try {
                const container = document.getElementById('images-container');
                container.children[sceneIndex].innerHTML = '<div style="width: 100%; aspect-ratio: 4/5; display: flex; align-items: center; justify-content: center;">â³ ì¬ìƒì„± ì¤‘...</div>';

                const res = await fetch('/api/workflow/regenerate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        scene_index: sceneIndex,
                        model
                    })
                });
                const data = await res.json();
                if (data.image) {
                    imagesData[sceneIndex] = data.image;
                    renderImages();
                }
            } catch (e) {
                alert('ì´ë¯¸ì§€ ì¬ìƒì„± ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ì´ë¯¸ì§€ ë Œë”ë§ í•¨ìˆ˜
        function renderImages() {
            const container = document.getElementById('images-container');
            container.innerHTML = imagesData.map((img, idx) => `
                <div style="background: var(--bg-input); border-radius: 8px; overflow: hidden;">
                    ${img.image_url ? `<img src="${img.image_url}" style="width: 100%; aspect-ratio: 4/5; object-fit: cover;">` : '<div style="width: 100%; aspect-ratio: 4/5; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">ìƒì„± ì‹¤íŒ¨</div>'}
                    <div style="padding: 0.5rem; text-align: center; font-size: 0.875rem;">
                        ì”¬ ${img.scene_number}
                        <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; margin-left: 0.5rem;" onclick="regenerateImage(${idx})">ğŸ”„</button>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>

</html>