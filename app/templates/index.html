<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Progress Steps */
        .progress-bar {
            background: var(--bg-card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .steps {
            display: flex;
            justify-content: center;
            gap: 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .step:hover {
            color: var(--primary);
        }

        .step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .step.done {
            color: var(--success);
        }

        .step.done:hover {
            color: var(--primary);
        }

        .step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .step.active .step-num {
            background: var(--primary);
            color: white;
        }

        .step.done .step-num {
            background: var(--success);
            color: white;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 0.5rem;
        }

        .step.done+.step-line {
            background: var(--success);
        }

        /* Main Content */
        main {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Step Content - Page View Behavior */
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .card-desc {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Outline Button (ë‹¤í¬ í…Œë§ˆ í†µì¼) */
        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-outline:hover {
            background: var(--bg-input);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Small Button */
        .btn-sm {
            padding: 0.4rem 0.85rem;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        /* File Input ë‹¤í¬ í…Œë§ˆ */
        input[type="file"] {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            padding: 0.5rem;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.4rem 0.85rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 0.75rem;
            transition: all 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background: var(--bg-input);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ëª¨ë‹¬ ë‚´ë¶€ ë‹¤í¬ í…ìŠ¤íŠ¸ í†µì¼ */
        .modal-content-dark h3,
        .modal-content-dark h4,
        .modal-content-dark h5,
        .modal-content-dark label,
        .modal-content-dark p {
            color: var(--text);
        }


        /* Mode Selection */
        .mode-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .mode-card {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: var(--primary);
        }

        .mode-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .mode-card.selected {
            background: rgba(99, 102, 241, 0.1);
        }

        .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .mode-title {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .mode-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Scene Cards */
        .scene-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .scene-num {
            font-weight: 700;
            color: var(--primary);
        }

        .scene-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--warning);
            color: black;
        }

        /* Character Card */
        .char-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .char-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .char-avatar {
            width: 60px;
            height: 60px;
            background: var(--bg-input);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .char-info {
            flex: 1;
        }

        .char-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .char-role {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Rule Warning */
        .rule-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 3px solid var(--warning);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #ff9800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-container {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* --- Style System 2.0 UI Improvements --- */
        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .style-select-card {
            background: var(--bg-card);
            /* Keep card bg */
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
        }

        .style-select-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .style-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .style-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .selected-style-display {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            font-weight: 600;
            color: var(--primary);
            /* Highlight color */
            text-align: center;
            transition: all 0.2s;
        }

        .selected-style-display:hover {
            background: var(--bg);
        }

        /* Modal Dark Theme */
        .modal-content-dark {
            background: var(--bg-card) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
        }

        .modal-header-dark {
            border-bottom: 1px solid var(--border) !important;
        }

        .style-list-dark {
            border-right: 1px solid var(--border) !important;
        }

        .style-item-dark {
            border-bottom: 1px solid var(--border) !important;
            color: var(--text) !important;
            transition: background 0.1s;
        }

        .style-item-dark:hover {
            background: var(--bg-input) !important;
        }

        .preview-box {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .preview-box:hover {
            border-color: var(--text-muted);
        }

        .tab.active {
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* ë§í’ì„  í¸ì§‘ê¸° ë°˜ì‘í˜• */
        @media (max-width: 800px) {
            #bubble-edit-main {
                grid-template-columns: 1fr !important;
            }
            #bubble-edit-main > div:last-child {
                max-height: 400px !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <a href="/" class="logo" style="text-decoration: none;">ğŸ¨ Tax Webtoon Auto-Generator Pro</a>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span id="login-status" style="font-size: 0.875rem; color: var(--text-muted);">Guest User</span>
            <a href="/settings" style="color: var(--text-muted); text-decoration: none;">âš™ï¸ ì„¤ì •</a>
        </div>
    </header>

    <div class="progress-bar">
        <div class="steps">
            <div class="step active" data-step="1" onclick="navigateToStep(1)"><span class="step-num">1</span> ì‹œì‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="2" onclick="navigateToStep(2)"><span class="step-num">2</span> ìë£Œìˆ˜ì§‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="3" onclick="navigateToStep(3)"><span class="step-num">3</span> ìŠ¤í† ë¦¬</div>
            <div class="step-line"></div>
            <div class="step" data-step="4" onclick="navigateToStep(4)"><span class="step-num">4</span> ì´ë¯¸ì§€</div>
            <div class="step-line"></div>
            <div class="step" data-step="5" onclick="navigateToStep(5)"><span class="step-num">5</span> ìƒì„±</div>
            <div class="step-line"></div>
            <div class="step" data-step="6" onclick="navigateToStep(6)"><span class="step-num">6</span> í¸ì§‘</div>
            <div class="step-line"></div>
            <div class="step" data-step="7" onclick="navigateToStep(7)"><span class="step-num">7</span> ë°œí–‰</div>
        </div>
    </div>

    <main>
        <div class="step-content active" id="step-1">
            <div class="card">
                <h2 class="card-title">ğŸš€ ì›Œí¬í”Œë¡œìš° ì‹œì‘</h2>
                <!-- Mode Cards Hidden (Optional: Can keep them if needed, but user didn't ask to remove) -->
                <div class="mode-cards" style="margin-bottom: 2rem;">
                    <div class="mode-card selected" data-mode="auto" onclick="selectMode('auto')">
                        <div class="mode-icon">ğŸ¤–</div>
                        <div class="mode-title">ìë™ ëª¨ë“œ</div>
                        <div class="mode-desc">í‚¤ì›Œë“œë§Œ ì…ë ¥í•˜ë©´ AIê°€ ìë£Œ ìˆ˜ì§‘ë¶€í„°ìŠ¤í† ë¦¬ê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="mode-card" data-mode="manual" onclick="selectMode('manual')">
                        <div class="mode-icon">âœï¸</div>
                        <div class="mode-title">ìˆ˜ë™ ëª¨ë“œ</div>
                        <div class="mode-desc">ì§ì ‘ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</div>
                    </div>
                </div>

                <div id="keyword-input-area">
                    <div class="form-group">
                        <label for="keyword">ë¬´ì—‡ì— ëŒ€í•´ ì„¤ëª…í•˜ëŠ” ì›¹íˆ°ì„ ë§Œë“¤ê¹Œìš”?</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="keyword" placeholder="ì˜ˆ: ì¦ì—¬ì„¸ ì—†ì´ ì¦ì—¬í•˜ëŠ” ë²•, ìœ¡ì•„íœ´ì§ ì‹ ì²­"
                                onkeyup="if(event.key==='Enter') startWorkflow()">
                        </div>

                        <!-- AI Model Selection -->
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                            <span>ì‚¬ìš©í•  AI ëª¨ë¸:</span>
                            <select id="ai-model-select"
                                style="padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                                <option value="gemini-3-pro-preview">Gemini 3.0 Pro (Preview/ìµœê³ ì„±ëŠ¥)</option>
                                <option value="gemini-3-flash-preview" selected>Gemini 3.0 Flash (Preview/ë¹ ë¦„)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Stable/ê³ ì„±ëŠ¥)</option>
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash (Stable/ê· í˜•)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="manual-input-area" style="display : none;">
                    <div class="form-group">
                        <label for="manual-script">ì‹œë‚˜ë¦¬ì˜¤ ë˜ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥</label>
                        <textarea id="manual-script" rows="5" placeholder="ì§ì ‘ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ë‚˜ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>

                <!-- Smart Analysis Result Removed -->
            </div>

            <div class="actions">
                <div></div>
                <!-- Initial Start Button Hidden when Analysis Shown -->
                <button class="btn btn-primary" id="btn-start-next" onclick="startWorkflow()"
                    style="display: block; width: 100%;">
                    ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€
                </button>
            </div>
        </div>

        <!-- Step 2: ìë£Œ ìˆ˜ì§‘ ë° ì¶”ì²œ -->
        <div class="step-content" id="step-2">
            <div class="loading" id="loading-data">
                <div class="spinner"></div>
                <div>AIê°€ ê´€ë ¨ ë²•ë ¹ê³¼ ìƒì„¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <div id="data-review-area" style="display: none;">
                <div class="card">
                    <h2 class="card-title">ğŸ“š ìˆ˜ì§‘ëœ ìƒì„¸ ì •ë³´</h2>
                    <p class="card-desc">AIê°€ í‚¤ì›Œë“œì— ë§ì¶° ìˆ˜ì§‘í•œ ë‚´ìš©ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ë³¸ë¬¸ì„ ìˆ˜ì •í•˜ê±°ë‚˜ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>
                    <div id="data-container"></div>
                    <button class="btn btn-secondary" style="margin-top: 1rem; width: 100%;"
                        onclick="openAddDataModal()">+ ì •ë³´ í•­ëª© ì¶”ê°€</button>
                </div>

                <!-- AI ë¶„í•  ì¶”ì²œ -->
                <div class="card"
                    style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(74, 144, 226, 0.15)); border: 1px solid var(--primary);">
                    <h3 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">ğŸª„ AI ì‹œí€€ìŠ¤ ì¶”ì²œ
                    </h3>
                    <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">ìˆ˜ì§‘ëœ ì •ë³´ì˜ ì–‘ì„ ë¶„ì„í–ˆì„ ë•Œ,
                        ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì„±ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <label style="font-weight: 600;">ì´ ì œì‘ ì”¬(Scene) ê°œìˆ˜</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <input type="number" id="total-scene-count" value="8"
                                    style="width: 80px; text-align: center; font-size: 1.25rem;">
                                <span style="font-size: 0.875rem; color: var(--text-muted);">ì¶”ì²œ: <b
                                        id="ai-rec-scenes">8</b>ê°œ</span>
                            </div>
                        </div>
                        <div>
                            <label style="font-weight: 600;">ì‹œë¦¬ì¦ˆ ë¶„í•  (ì¸ìŠ¤íƒ€ ìºëŸ¬ì…€ìš©)</label>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <input type="text" id="series-split" value="8" placeholder="ì˜ˆ: 8,7 (8ì¥+7ì¥)"
                                    style="width: 120px; text-align: center;">
                                <span style="font-size: 0.875rem; color: var(--text-muted);">ì¶”ì²œ: <b
                                        id="ai-rec-split">ë‹¨ì¼</b></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions" id="data-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(1)">â† ì´ì „</button>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="selectContentType('webtoon')" style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 1.2rem;">ğŸ“–</span> ì›¹íˆ°ìš© ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°
                    </button>
                    <button class="btn btn-secondary" onclick="selectContentType('carousel')" style="display: flex; align-items: center; gap: 6px; border-color: #f59e0b; color: #f59e0b;">
                        <span style="font-size: 1.2rem;">ğŸ </span> ìºëŸ¬ì…€ ë°”ë¡œê°€ê¸°
                    </button>
                    <button class="btn btn-secondary" onclick="selectContentType('cardnews')" style="display: flex; align-items: center; gap: 6px; border-color: #10b981; color: #10b981;">
                        <span style="font-size: 1.2rem;">ğŸ“°</span> ì¹´ë“œë‰´ìŠ¤ ë°”ë¡œê°€ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: ìŠ¤í† ë¦¬ ë° ìºë¦­í„° ê´€ë¦¬ -->
        <div class="step-content" id="step-3">
            <div class="loading" id="loading-story">
                <div class="spinner"></div>
                <div>ë§ì¶¤í˜• ìŠ¤í† ë¦¬ë¥¼ êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>

            <div id="story-review-area" style="display: none;">
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="btn btn-secondary btn-sm" onclick="openStoryHistoryModal()">ğŸ“‚ ì´ì „ ìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
                        (History)</button>
                </div>
                <!-- ìºë¦­í„° í”„ë¡œí•„ ì„¹ì…˜ -->
                <div class="card">
                    <h2 class="card-title">ğŸ‘¥ ë“±ì¥ì¸ë¬¼ í”„ë¡œí•„</h2>
                    <div id="character-profiles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <!-- Character Profile Cards will be injected here -->
                    </div>
                </div>

                <!-- ìŠ¤í† ë¦¬ ì”¬ ì„¹ì…˜ -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="card-title" style="margin-bottom: 0;">ğŸ“– ì”¬ ê²€í†  ë° ê·œì¹™ í™•ì¸</h2>
                        <div style="font-size: 0.75rem; color: var(--text-muted);" id="rule-status">ëŒ€ì‚¬ 20ì / ë§í’ì„  2ê°œ ì¤€ìˆ˜ ì¤‘
                        </div>
                    </div>
                    <div id="scenes-container"></div>
                </div>
            </div>

            <div class="actions" id="story-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(2)">â† ì´ì „</button>
                <button class="btn btn-primary" onclick="approveScenes()">ì‚¬ìš©ì ì •ì˜ ë ˆì´ì•„ì›ƒ/ìŠ¤íƒ€ì¼ ì„¤ì • â†’</button>
            </div>
        </div>

        <!-- Step 4: ìƒì„¸ ì„¤ì • (Font, Style, Layout, Ratio, Model) -->
        <div class="step-content" id="step-4">
            <div class="card">
                <h2 class="card-title">âš™ï¸ ê³ ë„í™”ëœ ì œì‘ ì„¤ì •</h2>

                <div class="tab-container">
                    <div class="tab active" onclick="switchSettingTab('image')">ê·¸ë¦¼ ìŠ¤íƒ€ì¼</div>
                    <div class="tab" onclick="switchSettingTab('text')">í…ìŠ¤íŠ¸ & í°íŠ¸</div>
                    <div class="tab" onclick="switchSettingTab('layout')">ì¥ë©´ & ë¹„ìœ¨</div>
                </div>

                <!-- Image Settings Tab (Style System 2.0) -->
                <div id="setting-tab-image" class="tab-content active">
                    <!-- 1. Model Selection (Moved to Top) -->
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem;">ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸</label>
                        <select id="image-model" style="padding: 1rem; width: 100%;">
                            <!-- Flux Kontext (fal.ai â€” ìºë¦­í„° ì¼ê´€ì„± ìµœê³ ) -->
                            <optgroup label="Flux Kontext (ìºë¦­í„° ì¼ê´€ì„± ìµœê³  â€” fal.ai)">
                                <option value="flux-kontext-dev" selected>Flux Kontext Dev (ì¼ê´€ì„± 94.7% â€” ì¶”ì²œ)</option>
                                <option value="flux-kontext-pro">Flux Kontext Pro (ìµœê³  í’ˆì§ˆ)</option>
                            </optgroup>

                            <!-- Gemini Models (Powered by Google) -->
                            <optgroup label="Google Gemini (ì´ˆê³ ì†/ì§€ëŠ¥í˜•)">
                                <option value="nano-banana">Nano Banana (Gemini 2.5 Flash Image - ë¹ ë¦„)
                                </option>
                                <option value="nano-banana-pro">Nano Banana Pro (Preview - ê³ í’ˆì§ˆ)</option>
                            </optgroup>

                            <!-- GPT/DALL-E Models (Powered by OpenAI) -->
                            <optgroup label="OpenAI DALL-E (ì˜ˆìˆ ì /ë‹¤ì–‘ì„±)">
                                <option value="gpt-image-1">GPT Image 1 (DALL-E 3 í‘œì¤€)</option>
                                <option value="gpt-image-1-mini">GPT Image 1 Mini (ê°€ì„±ë¹„ DALL-E)</option>
                                <option value="gpt-image-1.5">GPT Image 1.5 (ê³ í•´ìƒë„ ìµœì í™”)</option>
                                <option value="dall-e-3">DALL-E 3 (ê³ í’ˆì§ˆ ì›ë³¸)</option>
                                <option value="dall-e-2">DALL-E 2 (ê²½ì œì )</option>
                            </optgroup>

                            <!-- Flux LoRA (í•™ìŠµ ìºë¦­í„° ì „ìš©) -->
                            <optgroup label="Flux LoRA (í•™ìŠµ ìºë¦­í„° ì „ìš© â€” fal.ai)">
                                <option value="flux-lora">Flux LoRA (í•™ìŠµ ìºë¦­í„° ì‚¬ìš©)</option>
                            </optgroup>
                        </select>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
                            * ê¸°ë³¸ ëª¨ë¸ì€ 'Flux Kontext Dev'ì…ë‹ˆë‹¤. ì°¸ì¡° ì´ë¯¸ì§€ ê¸°ë°˜ ìºë¦­í„° ì¼ê´€ì„± 94.7%ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- 2. Legacy Style Area (Hidden) -->
                    <div id="legacy-character-bg-style" style="display: none !important;">
                        <div class="style-grid">
                            <!-- Character Style -->
                            <div class="style-select-card">
                                <div class="style-header">
                                    <span class="style-title">ğŸ§‘ ì¸ë¬¼ ìŠ¤íƒ€ì¼</span>
                                    <button class="btn btn-sm btn-outline"
                                        onclick="openStyleManager('character')">ì„¤ì •</button>
                                </div>
                                <div id="selected-char-style" class="selected-style-display">
                                    ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Webtoon)
                                </div>
                            </div>

                            <!-- Background Style -->
                            <div class="style-select-card">
                                <div class="style-header">
                                    <span class="style-title">ğŸ™ï¸ ë°°ê²½ ìŠ¤íƒ€ì¼</span>
                                    <button class="btn btn-sm btn-outline"
                                        onclick="openStyleManager('background')">ì„¤ì •</button>
                                </div>
                                <div id="selected-bg-style" class="selected-style-display">
                                    ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Modern Office)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. New Style Selection Area -->
                    <div class="style-section" style="margin-bottom: 2rem;">
                        <style>
                            .new-style-card {
                                background: var(--bg-card);
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                padding: 1rem;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                transition: all 0.2s;
                                min-height: 110px;
                                position: relative;
                            }

                            .new-style-card:hover {
                                border-color: var(--primary);
                                transform: translateY(-2px);
                            }

                            .new-style-card.selected {
                                border-color: var(--primary);
                                background: rgba(99, 102, 241, 0.1);
                                box-shadow: 0 0 0 2px var(--primary);
                            }

                            .new-style-emoji {
                                font-size: 2rem;
                                margin-bottom: 0.5rem;
                            }

                            .new-style-name {
                                font-size: 0.9rem;
                                font-weight: 600;
                                text-align: center;
                            }

                            .new-style-thumb {
                                width: 100%;
                                height: 80px;
                                /* Increased height */
                                object-fit: cover;
                                border-radius: 4px;
                                margin-bottom: 0.5rem;
                                background-color: var(--bg-input);
                                /* Placeholder bg */
                            }

                            /* Fallback for no thumbnail */
                            .new-style-no-thumb {
                                width: 100%;
                                height: 80px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: linear-gradient(135deg, var(--bg-input) 0%, var(--bg-card) 100%);
                                border-radius: 4px;
                                margin-bottom: 0.5rem;
                                font-size: 2.5rem;
                            }

                            .delete-btn-card {
                                position: absolute;
                                top: 4px;
                                right: 4px;
                                background: rgba(0, 0, 0, 0.5);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                font-size: 12px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }

                            .delete-btn-card:hover {
                                background: var(--danger);
                            }
                        </style>

                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                            <div>
                                <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem;">â”€â”€ ìŠ¤íƒ€ì¼ ì„ íƒ â”€â”€</h3>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">ì´ë¯¸ì§€ì— ì ìš©ë  ë Œë”ë§ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="openCustomStyleUploadModal()">ï¼‹ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼
                                ê´€ë¦¬</button>
                        </div>

                        <!-- ì¸ë¬¼/ë°°ê²½/í•™ìŠµ íƒ­ -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button id="style-tab-character" class="btn btn-sm btn-primary" onclick="switchStyleTab('character')">ğŸ§‘ ì¸ë¬¼ ìŠ¤íƒ€ì¼</button>
                            <button id="style-tab-background" class="btn btn-sm btn-outline" onclick="switchStyleTab('background')">ğŸ™ï¸ ë°°ê²½ ìŠ¤íƒ€ì¼</button>
                            <button id="style-tab-training" class="btn btn-sm btn-outline" onclick="switchStyleTab('training')" style="position: relative;">
                                ğŸ“ í•™ìŠµ ìŠ¤íƒ€ì¼
                                <span style="position: absolute; top: -6px; right: -6px; background: #f59e0b; color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 8px; font-weight: 700;">NEW</span>
                            </button>
                        </div>

                        <!-- Style Grid -->
                        <div id="new-style-grid"
                            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 1rem;">
                            <!-- Javascript will populate this -->
                        </div>

                        <!-- Pagination -->
                        <div id="style-pagination"
                            style="display: flex; justify-content: center; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                            <button class="btn btn-sm btn-outline" onclick="prevStylePage()">â† ì´ì „</button>
                            <span id="style-page-indicator" style="font-size: 0.85rem; color: var(--text-muted);">1 /
                                1</span>
                            <button class="btn btn-sm btn-outline" onclick="nextStylePage()">ë‹¤ìŒ â†’</button>
                        </div>

                        <div id="selected-style-label"
                            style="background: var(--bg-input); padding: 12px; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--primary); color: var(--text);">
                            ì„ íƒ: ğŸš« ì—†ìŒ - ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§Œ ì‚¬ìš©
                        </div>

                        <!-- í•™ìŠµ ìŠ¤íƒ€ì¼ íŒ¨ë„ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                        <div id="training-style-panel" style="display: none;">
                            <style>
                                .trained-char-card {
                                    background: var(--bg-card);
                                    border: 2px solid var(--border);
                                    border-radius: 12px;
                                    padding: 1rem;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    position: relative;
                                }
                                .trained-char-card:hover {
                                    border-color: var(--primary);
                                    transform: translateY(-2px);
                                }
                                .trained-char-card.selected {
                                    border-color: #f59e0b;
                                    background: rgba(245, 158, 11, 0.1);
                                    box-shadow: 0 0 0 2px #f59e0b;
                                }
                                .trained-badge {
                                    display: inline-block;
                                    background: linear-gradient(135deg, #f59e0b, #d97706);
                                    color: white;
                                    font-size: 0.65rem;
                                    padding: 2px 6px;
                                    border-radius: 4px;
                                    font-weight: 700;
                                    margin-left: 4px;
                                }
                                .training-status-badge {
                                    display: inline-block;
                                    font-size: 0.7rem;
                                    padding: 2px 6px;
                                    border-radius: 4px;
                                    font-weight: 600;
                                }
                                .training-status-badge.completed { background: #10b981; color: white; }
                                .training-status-badge.training { background: #3b82f6; color: white; }
                                .training-status-badge.pending { background: #6b7280; color: white; }
                                .training-status-badge.failed { background: #ef4444; color: white; }
                                .training-progress-bar {
                                    width: 100%;
                                    height: 4px;
                                    background: var(--bg-input);
                                    border-radius: 2px;
                                    margin-top: 8px;
                                    overflow: hidden;
                                }
                                .training-progress-bar-fill {
                                    height: 100%;
                                    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                                    border-radius: 2px;
                                    transition: width 0.5s ease;
                                }
                            </style>

                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem;">ğŸ“ í•™ìŠµ ìºë¦­í„° ê´€ë¦¬</h4>
                                    <p style="color: var(--text-muted); font-size: 0.8rem;">LoRA íŒŒì¸íŠœë‹ìœ¼ë¡œ ìºë¦­í„°ë¥¼ í•™ìŠµí•˜ë©´ 95%+ ì¼ê´€ì„±ì„ ë‹¬ì„±í•©ë‹ˆë‹¤.</p>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="openCreateTrainedCharModal()">ï¼‹ ìƒˆ ìºë¦­í„° í•™ìŠµ</button>
                            </div>

                            <!-- í•™ìŠµ ìºë¦­í„° ëª©ë¡ -->
                            <div id="trained-char-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 1rem;">
                                <div style="text-align: center; color: var(--text-muted); padding: 2rem; grid-column: 1/-1;">
                                    í•™ìŠµëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                                    <span style="font-size: 0.85rem;">ìœ„ ë²„íŠ¼ìœ¼ë¡œ ìºë¦­í„°ë¥¼ í•™ìŠµí•´ë³´ì„¸ìš”.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. ë‹¨ìƒ‰ ë°°ê²½ ìƒ‰ìƒ ì„ íƒê¸° -->
                    <div id="bg-color-picker-area" style="display: none; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.8rem; font-size: 0.95rem;">ğŸ¨ ë°°ê²½ ìƒ‰ìƒ ì„ íƒ</h4>
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                            <input type="color" id="bg-color-input" value="#F5F5DC"
                                style="width: 50px; height: 40px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; padding: 2px;"
                                onchange="onBgColorChange(this.value)">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 0.85rem; color: var(--text-muted);">HEX:</span>
                                <input type="text" id="bg-color-hex" value="#F5F5DC"
                                    style="width: 90px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); color: var(--text); font-family: monospace; font-size: 0.9rem;"
                                    onchange="onBgHexInput(this.value)">
                            </div>
                            <div id="bg-color-preview" style="width: 120px; height: 40px; border-radius: 6px; border: 2px solid var(--border); background: #F5F5DC;"></div>
                        </div>
                        <!-- ìì£¼ ì“°ëŠ” ìƒ‰ìƒ í€µ ì„ íƒ -->
                        <div style="display: flex; gap: 6px; margin-top: 0.8rem; flex-wrap: wrap;">
                            <button onclick="onBgColorChange('#FFFFFF')" style="width:28px; height:28px; background:#FFFFFF; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="í°ìƒ‰"></button>
                            <button onclick="onBgColorChange('#F5F5DC')" style="width:28px; height:28px; background:#F5F5DC; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ë² ì´ì§€"></button>
                            <button onclick="onBgColorChange('#FFE4E1')" style="width:28px; height:28px; background:#FFE4E1; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ì—°í•‘í¬"></button>
                            <button onclick="onBgColorChange('#E0F0FF')" style="width:28px; height:28px; background:#E0F0FF; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ì—°íŒŒë‘"></button>
                            <button onclick="onBgColorChange('#E8F5E9')" style="width:28px; height:28px; background:#E8F5E9; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ì—°ì´ˆë¡"></button>
                            <button onclick="onBgColorChange('#FFF9C4')" style="width:28px; height:28px; background:#FFF9C4; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ì—°ë…¸ë‘"></button>
                            <button onclick="onBgColorChange('#F3E5F5')" style="width:28px; height:28px; background:#F3E5F5; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ì—°ë³´ë¼"></button>
                            <button onclick="onBgColorChange('#D7CCC8')" style="width:28px; height:28px; background:#D7CCC8; border:2px solid #ccc; border-radius:50%; cursor:pointer;" title="ì›œê·¸ë ˆì´"></button>
                            <button onclick="onBgColorChange('#263238')" style="width:28px; height:28px; background:#263238; border:2px solid #555; border-radius:50%; cursor:pointer;" title="ë‹¤í¬"></button>
                            <button onclick="onBgColorChange('#000000')" style="width:28px; height:28px; background:#000000; border:2px solid #555; border-radius:50%; cursor:pointer;" title="ê²€ì •"></button>
                        </div>
                    </div>

                    <!-- 4. Manual Prompt Edit -->
                    <div class="manual-edit-section" style="margin-top: 2rem;">
                        <div
                            style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <h4 style="font-weight: 600; color: var(--text); margin-bottom: 1rem; font-size: 1rem;">âœï¸
                                í”„ë¡¬í”„íŠ¸ ìˆ˜ë™ í¸ì§‘ (ê³ ê¸‰)</h4>
                            <div style="padding-top: 0.5rem;">
                                <div class="form-group">
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                                        â“˜ ìœ„ì—ì„œ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ë©´ í”„ë¡¬í”„íŠ¸ê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                                    </p>
                                    <label>ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸</label>
                                    <textarea id="style-prompt-textarea" rows="4"
                                        placeholder="ì„ íƒí•œ ìŠ¤íƒ€ì¼ì˜ í”„ë¡¬í”„íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."
                                        style="font-family: monospace; font-size: 0.9rem; line-height: 1.4;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>ì¶”ê°€ ì§€ì‹œì‚¬í•­ (Negative Prompt ë“±)</label>
                                    <input type="text" id="manual-additional"
                                        placeholder="ì˜ˆ: text, watermark, ugly, deformed">
                                </div>
                                <div style="text-align: right;">
                                    <button class="btn btn-sm btn-outline" id="btn-manual-apply"
                                        onclick="generatePreview()">ì ìš©í•˜ì—¬ ë‹¤ì‹œ ë¯¸ë¦¬ë³´ê¸°</button>
                                </div>
                                <div id="manual-preview-result"
                                    style="margin-top: 1rem; text-align: center; min-height: 200px; display: none; background: var(--bg-input); border-radius: 8px; align-items: center; justify-content: center;">
                                    <span style="color: var(--text-muted);">ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Text Settings Tab -->
                <div id="setting-tab-text" class="tab-content" style="display: none;">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>í°íŠ¸ ì„ íƒ</label>
                            <select id="font-family">
                                <option value="NanumGothic">ë‚˜ëˆ”ê³ ë”• (ê¸°ë³¸)</option>
                                <option value="Bamin">ë°°ë¯¼ì²´ (ìš°ì•„í•œí˜•ì œë“¤)</option>
                                <option value="Malgun">ë§‘ì€ê³ ë”•</option>
                                <option value="Cafe24">Cafe24</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ëŒ€ì‚¬ ê°€ë…ì„± ì˜µì…˜</label>
                            <select id="dialogue-placement">
                                <option value="bubble">ë§í’ì„  (ì¹œê·¼í•¨)</option>
                                <option value="subtitle">í•˜ë‹¨ ìë§‰ (ê°€ë…ì„± ìš°ìˆ˜)</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ëŒ€ì‚¬ í¬ê¸°</label>
                            <input type="range" id="font-size-dialogue" min="18" max="36" value="24"
                                oninput="document.getElementById('fs-d-val').innerText=this.value+'px'">
                            <span id="fs-d-val">24px</span>
                        </div>
                        <div class="form-group">
                            <label>ë‚˜ë ˆì´ì…˜ í¬ê¸°</label>
                            <input type="range" id="font-size-narration" min="16" max="30" value="20"
                                oninput="document.getElementById('fs-n-val').innerText=this.value+'px'">
                            <span id="fs-n-val">20px</span>
                        </div>
                    </div>
                </div>

                <!-- Image Generation Settings (Duplicate removed) -->
                <!-- Removed per request -->

                <script>
                    // ==========================================
                    // New Style System (Preset + Custom)
                    // ==========================================

                    const PRESET_STYLES = {
                        "none": {
                            "name": "ì—†ìŒ", "emoji": "ğŸš«",
                            "desc": "ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§Œ ì‚¬ìš©",
                            "prompt": "",
                            "is_preset": true,
                            "type": "character"
                        },
                        "ghibli": {
                            "name": "ì§€ë¸Œë¦¬", "emoji": "ğŸŒ¿",
                            "desc": "ì§€ë¸Œë¦¬í’ ë¶€ë“œëŸ¬ìš´ ìƒ‰ê°",
                            "prompt": "studio ghibli inspired, soft colors, dreamy atmosphere, watercolor-like backgrounds, gentle lighting, whimsical characters",
                            "is_preset": true,
                            "type": "character"
                        },
                        "romance": {
                            "name": "ë¡œë§¨ìŠ¤", "emoji": "ğŸ’•",
                            "desc": "íŒŒìŠ¤í…” í†¤, ë”°ëœ»í•œ ê°ì„±",
                            "prompt": "soft pastel colors, warm lighting, emotional atmosphere, delicate character expressions, romantic webtoon style, pink and peach tones",
                            "is_preset": true,
                            "type": "character"
                        },
                        "business": {
                            "name": "ë¹„ì¦ˆë‹ˆìŠ¤", "emoji": "ğŸ’¼",
                            "desc": "ê¹”ë”í•œ ì „ë¬¸ê°€ ëŠë‚Œ",
                            "prompt": "professional, corporate style, clean lines, modern office setting, neutral color palette, business casual characters",
                            "is_preset": true,
                            "type": "character"
                        },
                        "round_lineart": {
                            "name": "ë™ê¸€ ë¼ì¸", "emoji": "âœï¸",
                            "desc": "ë‘¥ê¸€ë‘¥ê¸€ ê·€ì—¬ìš´ ì„ í™”, ì¸ìŠ¤íƒ€íˆ° ëŒ€í‘œ ìŠ¤íƒ€ì¼",
                            "prompt": "simple round line drawing style, thick black outlines, minimal detail, cute rounded shapes, white or solid pastel background, no shading, flat colors only, chibi-like proportions with big head, hand-drawn feel, doodle aesthetic",
                            "is_preset": true,
                            "type": "character"
                        },
                        "pastel_flat": {
                            "name": "íŒŒìŠ¤í…” í”Œë«", "emoji": "ğŸ¨",
                            "desc": "ë¶€ë“œëŸ¬ìš´ íŒŒìŠ¤í…” í‰ë©´ ì¼ëŸ¬ìŠ¤íŠ¸",
                            "prompt": "flat illustration style, soft pastel color palette, no gradients, no shadows, clean vector-like shapes, simple facial features with dot eyes, minimal background, modern Korean illustration style, muted warm tones",
                            "is_preset": true,
                            "type": "character"
                        },
                        "bold_cartoon": {
                            "name": "ë³¼ë“œ ì¹´íˆ°", "emoji": "ğŸ’¥",
                            "desc": "êµµì€ ì„  + ê°•ë ¬í•œ ìƒ‰, ëˆˆì— ë„ëŠ” í”¼ë“œ",
                            "prompt": "bold cartoon style, very thick black outlines 4-5px, bright saturated flat colors, exaggerated expressions, simple geometric shapes, pop art influence, no gradient, solid color fills, high contrast",
                            "is_preset": true,
                            "type": "character"
                        },
                        "pencil_sketch": {
                            "name": "ì—°í•„ ìŠ¤ì¼€ì¹˜", "emoji": "ğŸ“",
                            "desc": "ì†ê·¸ë¦¼ ëŠë‚Œ, ìºì£¼ì–¼ ë‚™ì„œí’",
                            "prompt": "pencil sketch style, hand-drawn rough lines, grayscale with occasional single accent color, notebook paper texture, casual doodle feel, imperfect lines, crosshatch shading, minimal detail",
                            "is_preset": true,
                            "type": "character"
                        },
                        "monoline": {
                            "name": "ëª¨ë…¸ë¼ì¸", "emoji": "ã€°ï¸",
                            "desc": "ì¼ì •í•œ ì„  í•˜ë‚˜ë¡œ ê·¸ë¦° ë¯¸ë‹ˆë©€",
                            "prompt": "monoline illustration style, single consistent line weight, no fill colors, outline only, clean and minimal, white background, modern simple aesthetic, thin continuous lines, no shading",
                            "is_preset": true,
                            "type": "character"
                        },
                        "watercolor_soft": {
                            "name": "ìˆ˜ì±„í™”", "emoji": "ğŸ’§",
                            "desc": "ë¬¼ê° ë²ˆì§ ëŠë‚Œ, ë¶€ë“œëŸ¬ìš´ ê°ì„±",
                            "prompt": "soft watercolor illustration style, light color bleeding edges, pastel tones, gentle brush strokes, slightly transparent colors, white paper background showing through, dreamy and warm, simple character design with minimal facial features",
                            "is_preset": true,
                            "type": "character"
                        },
                        "neon_pop": {
                            "name": "ë„¤ì˜¨ íŒ", "emoji": "ğŸŒ™",
                            "desc": "ì–´ë‘ìš´ ë°°ê²½ + ë„¤ì˜¨ ìƒ‰, ê°•ë ¬í•œ ì„íŒ©íŠ¸",
                            "prompt": "neon pop style illustration, dark navy or black background, bright neon accent colors pink cyan yellow, simple flat character design, glowing edges, bold minimal shapes, high visual contrast, modern and trendy",
                            "is_preset": true,
                            "type": "character"
                        },
                        "emoji_icon": {
                            "name": "ì´ëª¨ì§€", "emoji": "ğŸ˜Š",
                            "desc": "ê·¹ë‹¨ì ìœ¼ë¡œ ë‹¨ìˆœí™”, ì•„ì´ì½˜ ëŠë‚Œ",
                            "prompt": "emoji-like simple icon style illustration, extremely simplified characters, circle heads, dot eyes, line mouth, no nose, stick-figure inspired but cute, solid bright background, 2-3 colors maximum per scene, Google emoji aesthetic, flat design",
                            "is_preset": true,
                            "type": "character"
                        },
                        "retro_90s": {
                            "name": "90s ë ˆíŠ¸ë¡œ", "emoji": "ğŸ“¼",
                            "desc": "ë³µê³ í’ ë¹ˆí‹°ì§€ ìƒ‰ê°",
                            "prompt": "1990s retro cartoon style, slightly grainy texture, warm vintage color palette with orange brown teal, rounded character shapes, simple dot eyes, nostalgic feel, VHS-era cartoon aesthetic, thick outlines, limited color palette 4-5 colors",
                            "is_preset": true,
                            "type": "character"
                        },
                        "cutout_collage": {
                            "name": "ì»·ì•„ì›ƒ", "emoji": "âœ‚ï¸",
                            "desc": "ì˜¤ë ¤ë¶™ì¸ ì¢…ì´ ì½œë¼ì£¼, íŠ¸ë Œë””",
                            "prompt": "paper cutout collage style illustration, torn paper edges, layered flat shapes, craft paper texture, handmade feel, simple character shapes from geometric cuts, warm earth tones with one bright accent color, scrapbook aesthetic, tactile and trendy",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_webtoon": {
                            "name": "ê¸°ë³¸ ì›¹íˆ°", "emoji": "ğŸ“–",
                            "desc": "ê¹”ë”í•˜ê³  ì„ ëª…í•œ ë¼ì¸, í‘œì¤€ ì›¹íˆ° ìŠ¤íƒ€ì¼",
                            "prompt": "Korean webtoon style, digital art, manhwa style, clean heavy outlines, vibrant colors, detailed shading, expressive faces, standard rectangular panels format",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_bw_pen": {
                            "name": "í‘ë°± íœí™”", "emoji": "âœ’ï¸",
                            "desc": "í‘ë°± íœí™” ìŠ¤íƒ€ì¼, ì¶œíŒ ë§Œí™”/ëˆ„ì•„ë¥´",
                            "prompt": "Black and white ink drawing, pen and ink style, crosshatching, manga inking, monochrome, high contrast, detailed line work, no color, traditional comic art",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_shonen": {
                            "name": "ì†Œë…„ë§Œí™”/ì•¡ì…˜", "emoji": "âš”ï¸",
                            "desc": "ì—­ë™ì ì¸ ì„ ê³¼ ê°•ë ¬í•œ ëª…ì•” ëŒ€ë¹„",
                            "prompt": "Japanese Shonen manga style, highly dynamic action pose, sharp ink lines, dramatic shading, intense expression, speed lines, high contrast, vibrant colors, detailed muscles and clothes",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_flat_vector": {
                            "name": "í”Œë« ë²¡í„°", "emoji": "ğŸ“",
                            "desc": "ë‹¨ìˆœí•œ ë©´ê³¼ ìƒ‰ìƒ ì¤‘ì‹¬ì˜ ë””ìì¸",
                            "prompt": "Flat vector art style, clean minimalistic design, no gradients, solid colors, bold geometric shapes, corporate art style, icon style, modern illustration, simple shading",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_chibi": {
                            "name": "SD/ì¹˜ë¹„", "emoji": "ğŸ‘¶",
                            "desc": "ê·€ì—¬ìš´ SD ìºë¦­í„° ìŠ¤íƒ€ì¼",
                            "prompt": "Chibi style, super deformed, big head small body, cute exaggerate expressions, simple coloring, kawaii aesthetic, soft outlines",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_retro_anime": {
                            "name": "ë ˆíŠ¸ë¡œ ì• ë‹ˆ", "emoji": "ğŸ“º",
                            "desc": "90ë…„ëŒ€ ì…€ ì• ë‹ˆë©”ì´ì…˜ ê°ì„±",
                            "prompt": "90s anime style, cel shading, retro aesthetic, slightly grainy, vibrant but vintage colors, detailed eyes, classic anime character design",
                            "is_preset": true,
                            "type": "character"
                        },
                        "char_pixel_art": {
                            "name": "í”½ì…€ ì•„íŠ¸", "emoji": "ğŸ‘¾",
                            "desc": "ë ˆíŠ¸ë¡œ ê²Œì„ ë„íŠ¸ ê°ì„±",
                            "prompt": "Pixel art style, 8-bit or 16-bit game graphic, limitations of color palette, blocky shapes, retro game aesthetic, detailed sprite work",
                            "is_preset": true,
                            "type": "character"
                        },
                        "bg_default": {
                            "name": "ìŠ¤íƒ€ì¼ ê¸°ë³¸", "emoji": "ğŸ­",
                            "desc": "ìŠ¤íƒ€ì¼ì— ë§ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë°°ê²½",
                            "prompt": "",
                            "bg_instruction": "",
                            "is_preset": true,
                            "type": "background"
                        },
                        "bg_remove": {
                            "name": "ë°°ê²½ ì§€ìš°ê¸°", "emoji": "ğŸš«",
                            "desc": "ë°°ê²½ ì—†ì´ ìºë¦­í„°ë§Œ (í° ë°°ê²½)",
                            "prompt": "",
                            "bg_instruction": "Pure white (#FFFFFF) background only. No background elements, no objects, no scenery, no environment. Show only the character on a completely blank white background.",
                            "is_preset": true,
                            "type": "background"
                        },
                        "bg_solid": {
                            "name": "ë‹¨ìƒ‰ ë°°ê²½", "emoji": "ğŸ¨",
                            "desc": "ì„ íƒí•œ ìƒ‰ìƒì˜ ë‹¨ìƒ‰ ë°°ê²½",
                            "prompt": "",
                            "bg_instruction": "",
                            "is_preset": true,
                            "type": "background"
                        }
                    };

                    var currentSelectedStyle = "none";
                    // sessionId matches global decl in main script
                    var customStyles = {}; // Load from API later
                    var stylePage = 1;
                    const itemsPerPage = 12;

                    // ë‹¤ë¥¸ <script> ë¸”ë¡ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ var ì‚¬ìš©
                    var currentStyleType = 'character';
                    var selectedStyles = {
                        character: null,
                        background: null
                    };
                    var stylesData = { character: [], background: [] };
                    var manualOverrides = { charPrompt: '', bgPrompt: '', additional: '' };

                    async function loadCustomStyles() {
                        try {
                            const [charRes, bgRes] = await Promise.all([
                                fetch('/api/styles/character'),
                                fetch('/api/styles/background')
                            ]);

                            const charStyles = await charRes.json();
                            const bgStyles = await bgRes.json();

                            customStyles = {}; // Reset

                            // Process Character Styles
                            charStyles.forEach(s => {
                                customStyles[s.id] = {
                                    id: s.id,
                                    name: s.name,
                                    emoji: "ğŸ§‘",
                                    desc: s.description || "ì‚¬ìš©ì ì •ì˜ ì¸ë¬¼ ìŠ¤íƒ€ì¼",
                                    prompt: s.prompt_block,
                                    thumbnail: s.preview_image || (s.reference_images && s.reference_images.length > 0 ? s.reference_images[0] : null),
                                    is_preset: s.is_default || false,
                                    type: 'character'
                                };
                            });

                            // Process Background Styles
                            bgStyles.forEach(s => {
                                customStyles[s.id] = {
                                    id: s.id,
                                    name: s.name,
                                    emoji: "ğŸ™ï¸",
                                    desc: s.description || "ì‚¬ìš©ì ì •ì˜ ë°°ê²½ ìŠ¤íƒ€ì¼",
                                    prompt: s.prompt_block,
                                    thumbnail: s.preview_image || (s.reference_images && s.reference_images.length > 0 ? s.reference_images[0] : null),
                                    is_preset: s.is_default || false,
                                    type: 'background'
                                };
                            });

                            renderNewStyleGrid();

                        } catch (e) {
                            console.error("Failed to load custom styles:", e);
                        }
                    }

                    function switchStyleTab(type) {
                        currentStyleType = type;
                        stylePage = 1;

                        // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì „í™˜
                        const charTab = document.getElementById('style-tab-character');
                        const bgTab = document.getElementById('style-tab-background');
                        const trainTab = document.getElementById('style-tab-training');
                        const label = document.getElementById('selected-style-label');
                        const colorPicker = document.getElementById('bg-color-picker-area');
                        const styleGrid = document.getElementById('new-style-grid');
                        const pagination = document.getElementById('style-pagination');
                        const trainingPanel = document.getElementById('training-style-panel');

                        // ê¸°ë³¸: ëª¨ë“  íƒ­ ë¹„í™œì„±
                        charTab.className = 'btn btn-sm btn-outline';
                        bgTab.className = 'btn btn-sm btn-outline';
                        if (trainTab) trainTab.className = 'btn btn-sm btn-outline';
                        if (trainTab) trainTab.style.position = 'relative';

                        if (type === 'training') {
                            // í•™ìŠµ ìŠ¤íƒ€ì¼ íƒ­
                            if (trainTab) {
                                trainTab.className = 'btn btn-sm btn-primary';
                                trainTab.style.position = 'relative';
                            }
                            if (styleGrid) styleGrid.style.display = 'none';
                            if (pagination) pagination.style.display = 'none';
                            if (colorPicker) colorPicker.style.display = 'none';
                            if (label) label.style.display = 'none';
                            if (trainingPanel) trainingPanel.style.display = 'block';
                            loadTrainedCharacters();
                            return;
                        }

                        // ì¸ë¬¼/ë°°ê²½ íƒ­ â€” í•™ìŠµ íŒ¨ë„ ìˆ¨ê¸°ê¸°
                        if (trainingPanel) trainingPanel.style.display = 'none';
                        if (styleGrid) styleGrid.style.display = 'grid';
                        if (pagination) pagination.style.display = 'flex';
                        if (label) label.style.display = 'block';

                        if (type === 'character') {
                            charTab.className = 'btn btn-sm btn-primary';
                            if (colorPicker) colorPicker.style.display = 'none';

                            // ì¸ë¬¼ íƒ­ ì„ íƒ ë¼ë²¨ ë³µì›
                            if (selectedStyles.character) {
                                currentSelectedStyle = selectedStyles.character.id || 'none';
                                const s = selectedStyles.character;
                                if (label) label.innerText = `ì„ íƒ: ${s.emoji || 'ğŸ–¼ï¸'} ${s.name}${s.desc ? ' - ' + s.desc : ''}`;
                            } else {
                                currentSelectedStyle = 'none';
                                if (label) label.innerText = 'ì„ íƒ: ğŸš« ì—†ìŒ - ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§Œ ì‚¬ìš©';
                            }
                        } else {
                            bgTab.className = 'btn btn-sm btn-primary';

                            // ë°°ê²½ íƒ­ ì§„ì… ì‹œ ê¸°ë³¸ ì„ íƒ: bg_default
                            if (!selectedStyles.background || !selectedStyles.background.id) {
                                currentSelectedStyle = 'bg_default';
                                selectedStyles.background = { ...PRESET_STYLES['bg_default'], id: 'bg_default' };
                                if (label) label.innerText = 'ì„ íƒ: ğŸ­ ìŠ¤íƒ€ì¼ ê¸°ë³¸ - ìŠ¤íƒ€ì¼ì— ë§ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ë°°ê²½';
                                if (colorPicker) colorPicker.style.display = 'none';
                            } else {
                                currentSelectedStyle = selectedStyles.background.id;
                                const s = selectedStyles.background;
                                if (currentSelectedStyle === 'bg_solid') {
                                    if (colorPicker) colorPicker.style.display = 'block';
                                    if (label) label.innerHTML = `ì„ íƒ: ğŸ¨ ë‹¨ìƒ‰ ë°°ê²½ â€” <span style="display:inline-block;width:14px;height:14px;background:${bgSolidColor};border:1px solid #888;border-radius:3px;vertical-align:middle;"></span> ${bgSolidColor}`;
                                } else {
                                    if (colorPicker) colorPicker.style.display = 'none';
                                    if (label) label.innerText = `ì„ íƒ: ${s.emoji || 'ğŸ–¼ï¸'} ${s.name}${s.desc ? ' - ' + s.desc : ''}`;
                                }
                            }
                        }

                        renderNewStyleGrid();
                    }

                    function getAllStyles() {
                        // â”€â”€ ë°°ê²½ íƒ­: bg_default, bg_remove, bg_solid í‘œì‹œ â”€â”€
                        if (currentStyleType === 'background') {
                            return [
                                { id: 'bg_default', ...PRESET_STYLES['bg_default'], is_preset: true },
                                { id: 'bg_remove', ...PRESET_STYLES['bg_remove'], is_preset: true },
                                { id: 'bg_solid', ...PRESET_STYLES['bg_solid'], is_preset: true }
                            ];
                        }

                        // â”€â”€ ì¸ë¬¼ íƒ­: í”„ë¦¬ì…‹ + ì»¤ìŠ¤í…€ ì¸ë¬¼ ìŠ¤íƒ€ì¼ â”€â”€
                        const presetIds = Object.keys(PRESET_STYLES);
                        const customIds = Object.keys(customStyles);
                        const allIds = Array.from(new Set([...presetIds, ...customIds]));

                        let combined = allIds.map(id => {
                            if (customStyles[id]) {
                                const style = { ...customStyles[id] };
                                if (PRESET_STYLES[id]) {
                                    style.is_preset = true;
                                    if (!style.type) style.type = PRESET_STYLES[id].type;
                                }
                                return style;
                            } else {
                                const preset = { id, ...PRESET_STYLES[id] };
                                if (id !== 'none') {
                                    preset.thumbnail = `/static/img/presets/${id}.png`;
                                }
                                preset.is_preset = true;
                                return preset;
                            }
                        });

                        // ì¸ë¬¼ íƒ€ì…ë§Œ í•„í„° (ë°°ê²½ íƒ€ì… ì œì™¸)
                        combined = combined.filter(s => {
                            if (s.id === 'none') return false; // ì•„ë˜ì—ì„œ ë§¨ ì•ì— ì¶”ê°€
                            return s.type === 'character';
                        });

                        // "ì—†ìŒ"ì„ ë§¨ ì•ì— ì¶”ê°€
                        if (PRESET_STYLES['none']) {
                            combined.unshift({ id: 'none', ...PRESET_STYLES['none'], is_preset: true, type: 'character' });
                        }

                        return combined;
                    }

                    function renderNewStyleGrid() {
                        const grid = document.getElementById('new-style-grid');
                        if (!grid) return;
                        grid.innerHTML = '';

                        const allStyles = getAllStyles();
                        const totalPages = Math.ceil(allStyles.length / itemsPerPage) || 1;
                        if (stylePage > totalPages) stylePage = totalPages;

                        const start = (stylePage - 1) * itemsPerPage;
                        const end = start + itemsPerPage;
                        const pageItems = allStyles.slice(start, end);

                        document.getElementById('style-page-indicator').innerText = `${stylePage} / ${totalPages}`;

                        pageItems.forEach(style => {
                            const card = document.createElement('div');
                            card.className = `new-style-card ${currentSelectedStyle === style.id ? 'selected' : ''}`;
                            card.onclick = () => onStyleCardClick(style.id);

                            let contentHtml = '';

                            // ë°°ê²½ ìŠ¤íƒ€ì¼ íŠ¹ìˆ˜ ì¹´ë“œ ë Œë”ë§
                            if (style.id === 'bg_default') {
                                contentHtml = `<div class="new-style-no-thumb" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:2rem;">ğŸ­</div>`;
                            } else if (style.id === 'bg_remove') {
                                contentHtml = `<div class="new-style-no-thumb" style="background:#fff; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; font-size:2rem;">ğŸš«</div>`;
                            } else if (style.id === 'bg_solid') {
                                contentHtml = `<div class="new-style-no-thumb" style="background:${bgSolidColor}; border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:1.2rem; color:#666;">
                                    <span style="background:rgba(255,255,255,0.8); padding:2px 6px; border-radius:4px; font-size:0.75rem;">${bgSolidColor}</span>
                                </div>`;
                            } else if (style.thumbnail) {
                                const thumbUrl = (style.thumbnail && style.thumbnail.indexOf('/app_data/') === 0) ? (style.thumbnail + '?t=' + Date.now()) : style.thumbnail;
                                contentHtml = `<img src="${thumbUrl}" class="new-style-thumb" onerror="this.replaceWith(document.createElement('div')); this.className='new-style-no-thumb'; this.innerText='${style.emoji || 'ğŸ–¼ï¸'}';">`;
                            } else {
                                contentHtml = `<div class="new-style-no-thumb">${style.emoji || 'ğŸ–¼ï¸'}</div>`;
                            }

                            // If it has thumbnail, emoji is redundant or can be small badge. 
                            // But if we use new-style-no-thumb, the emoji is inside it.
                            // So we only show separate emoji if we have a real thumbnail.
                            if (style.thumbnail && style.id !== 'bg_default' && style.id !== 'bg_remove' && style.id !== 'bg_solid') {
                                contentHtml += `<div style="font-size:0.8rem; margin-bottom:0.2rem;">${style.emoji || ''}</div>`;
                            }

                            // Badge Logic
                            let badge = '';
                            if (style.is_preset) {
                                if (style.id === 'none') {
                                    badge = '<span class="style-badge preset">ğŸš« ì—†ìŒ</span>';
                                } else if (style.id === 'bg_default' || style.id === 'bg_remove' || style.id === 'bg_solid') {
                                    badge = '<span class="style-badge preset">ğŸ”§ ë°°ê²½</span>';
                                } else {
                                    badge = '<span class="style-badge preset">ğŸ”’ ê¸°ë³¸</span>';
                                }
                            } else {
                                badge = '<span class="style-badge custom">ğŸ‘¤ ì»¤ìŠ¤í…€</span>';
                            }

                            contentHtml += `<div class="new-style-name">${style.name}</div>`;
                            contentHtml += `<div style="text-align:center;">${badge}</div>`;


                            // Delete button for custom styles
                            if (!style.is_preset) {
                                contentHtml += `<button class="delete-btn-card" onclick="event.stopPropagation(); deleteCustomStyle('${style.id}', '${style.type}')">âœ•</button>`;
                            }

                            card.innerHTML = contentHtml;
                            grid.appendChild(card);
                        });
                    }

                    // ë‹¨ìƒ‰ ë°°ê²½ ìƒ‰ìƒ ë³€ìˆ˜ (ë‹¤ë¥¸ <script> ë¸”ë¡ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ var ì‚¬ìš©)
                    var bgSolidColor = '#F5F5DC';

                    function onBgColorChange(hex) {
                        bgSolidColor = hex;
                        document.getElementById('bg-color-input').value = hex;
                        document.getElementById('bg-color-hex').value = hex;
                        document.getElementById('bg-color-preview').style.background = hex;
                        // ë¼ë²¨ ì—…ë°ì´íŠ¸
                        const label = document.getElementById('selected-style-label');
                        if (label) {
                            label.innerHTML = `ì„ íƒ: ğŸ¨ ë‹¨ìƒ‰ ë°°ê²½ â€” <span style="display:inline-block;width:14px;height:14px;background:${hex};border:1px solid #888;border-radius:3px;vertical-align:middle;"></span> ${hex}`;
                        }
                    }

                    function onBgHexInput(val) {
                        let hex = val.trim();
                        if (!hex.startsWith('#')) hex = '#' + hex;
                        if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                            onBgColorChange(hex);
                        }
                    }

                    function onStyleCardClick(styleId) {
                        currentSelectedStyle = styleId;
                        renderNewStyleGrid(); // Re-render to update selected state

                        let style = PRESET_STYLES[styleId];
                        if (!style && customStyles[styleId]) style = customStyles[styleId];
                        if (!style) return;

                        // Update Prompt Textarea
                        const promptArea = document.getElementById('style-prompt-textarea');
                        if (promptArea) {
                            promptArea.value = style.prompt;
                        }

                        // Update Label
                        const label = document.getElementById('selected-style-label');
                        if (label) {
                            const desc = style.desc ? ` - ${style.desc}` : '';
                            label.innerText = `ì„ íƒ: ${style.emoji || 'ğŸ–¼ï¸'} ${style.name}${desc}`;
                        }

                        // ë‹¨ìƒ‰ ë°°ê²½ ìƒ‰ìƒ í”¼ì»¤ í‘œì‹œ/ìˆ¨ê¹€
                        const colorPicker = document.getElementById('bg-color-picker-area');
                        if (colorPicker) {
                            if (styleId === 'bg_solid') {
                                colorPicker.style.display = 'block';
                                onBgColorChange(bgSolidColor); // ë¼ë²¨ë„ ê°±ì‹ 
                            } else {
                                colorPicker.style.display = 'none';
                            }
                        }

                        // Fixed: Update selectedStyles for Preview
                        // ì¸ë¬¼/ë°°ê²½ ë…ë¦½ ì„ íƒ: í˜„ì¬ íƒ­ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ íƒ€ì…ë§Œ ì—…ë°ì´íŠ¸
                        if (currentStyleType === 'background') {
                            selectedStyles.background = { ...style, id: styleId };
                        } else {
                            selectedStyles.character = style;
                        }
                    }

                    function nextStylePage() {
                        const total = getAllStyles().length;
                        const totalPages = Math.ceil(total / itemsPerPage);
                        if (stylePage < totalPages) {
                            stylePage++;
                            renderNewStyleGrid();
                        }
                    }

                    function prevStylePage() {
                        if (stylePage > 1) {
                            stylePage--;
                            renderNewStyleGrid();
                        }
                    }

                    function openCustomStyleUploadModal() {
                        // Open the new Style Manager
                        // Default to character style, or ask user? 
                        // For now, let's open character style and they can switch tab if implemented, 
                        // or just default to character.
                        openStyleManager('character');
                    }

                    async function deleteCustomStyle(id, type) {
                        if (confirm('ì •ë§ ì´ ìŠ¤íƒ€ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            try {
                                const res = await fetch(`/api/styles/${type}/${id}`, { method: 'DELETE' });
                                const data = await res.json();
                                if (data.success) {
                                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                    loadCustomStyles(); // Reload
                                } else {
                                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.detail);
                                }
                            } catch (e) {
                                alert('ì‚­ì œ ì˜¤ë¥˜: ' + e);
                            }
                        }
                    }

                    // Initialize Grid
                    document.addEventListener('DOMContentLoaded', () => {
                        // Restore session ID if exists
                        const savedSession = localStorage.getItem('lastSessionId');
                        if (savedSession) {
                            sessionId = savedSession;
                            console.log("Restored session ID:", sessionId);
                        }

                        // ê¸°ë³¸ íƒ­: ì¸ë¬¼ ìŠ¤íƒ€ì¼
                        switchStyleTab('character');
                        loadCustomStyles(); // Load custom styles from API
                        // Default select 'none'
                        onStyleCardClick('none');
                    });
                </script>
                <style>
                    .sub-style-card {
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        padding: 10px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: var(--bg-card);
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        gap: 5px;
                        position: relative;
                        overflow: hidden;
                        min-height: 100px;
                    }

                    .sub-style-card:hover {
                        border-color: var(--primary);
                        transform: translateY(-2px);
                    }

                    .sub-style-card.selected {
                        border-color: var(--primary);
                        background: rgba(99, 102, 241, 0.1);
                        box-shadow: 0 0 0 2px var(--primary);
                    }

                    .sub-style-preview-bg {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        opacity: 0.3;
                        z-index: 0;
                    }

                    .sub-style-card div {
                        z-index: 1;
                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
                    }

                    .style-badge {
                        display: inline-block;
                        font-size: 0.7rem;
                        padding: 2px 6px;
                        border-radius: 4px;
                        margin-bottom: 4px;
                        font-weight: 600;
                    }

                    .style-badge.preset {
                        background: rgba(0, 0, 0, 0.6);
                        color: #eee;
                        border: 1px solid #555;
                    }

                    .style-badge.custom {
                        background: var(--primary);
                        color: #fff;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                    }

                    .delete-btn-card {
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        background: rgba(0, 0, 0, 0.6);
                        color: #fff;
                        border: none;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        font-size: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0.7;
                        transition: opacity 0.2s;
                        z-index: 10;
                    }

                    .delete-btn-card:hover {
                        opacity: 1;
                        background: rgba(220, 38, 38, 0.8);
                    }
                </style>


                <!-- Layout Settings Tab -->
                <div id="setting-tab-layout" class="tab-content" style="display: none;">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>ì´ë¯¸ì§€ ë¹„ìœ¨</label>
                            <select id="aspect-ratio">
                                <option value="4:5" selected>1080x1350 (ì¸ìŠ¤íƒ€ ì„¸ë¡œ ê¶Œì¥)</option>
                                <option value="1:1">1080x1080 (ì •ì‚¬ê°í˜•)</option>
                                <option value="9:16">1080x1920 (ë¦´ìŠ¤/ìŠ¤í† ë¦¬ìš©)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>í˜ì´ì§€ ë²ˆí˜¸ ìœ„ì¹˜</label>
                            <select id="page-number-position">
                                <option value="bottom_right">ìš°ì¸¡ í•˜ë‹¨ (ê¸°ë³¸)</option>
                                <option value="bottom_center">ì¤‘ì•™ í•˜ë‹¨</option>
                                <option value="hide">í‘œì‹œ ì•ˆ í•¨</option>
                            </select>
                        </div>
                    </div>
                </div>


            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="goToStep(3)">â† ì´ì „</button>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ <b
                            id="image-est-time">2</b>ë¶„</span>
                    <button class="btn btn-primary" onclick="startImageGeneration()">ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ğŸš€</button>
                </div>
            </div>
        </div>

        <!-- Step 6: ë§í’ì„  & ëŒ€ì‚¬ í¸ì§‘ (ë¹„íŒŒê´´ ë ˆì´ì–´ ì‹œìŠ¤í…œ) -->
        <div class="step-content" id="step-6">
            <div class="card" style="padding: 1.25rem;">
                <h2 class="card-title" style="margin-bottom: 0.25rem;">ğŸ’¬ ë§í’ì„  & ëŒ€ì‚¬ í¸ì§‘</h2>
                <p class="card-desc" style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                    ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ê±´ë“œë¦¬ì§€ ì•ŠëŠ” ë¹„íŒŒê´´ í¸ì§‘. ëŒ€ì‚¬ ìˆ˜ì •, ìœ„ì¹˜ ë³€ê²½, ìŠ¤íƒ€ì¼ ë³€ê²½ì´ ììœ ë¡­ìŠµë‹ˆë‹¤.
                </p>

                <!-- â•â•â• ì”¬ ë„¤ë¹„ê²Œì´ì…˜ â•â•â• -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="bubbleNav(-1)" id="bubble-prev-btn" style="padding: 8px 16px; font-size: 1.1rem;">â†</button>
                    <span style="font-weight: 700; font-size: 1.1rem;" id="bubble-scene-indicator">ì”¬ 1 / 7</span>
                    <button class="btn btn-secondary" onclick="bubbleNav(1)" id="bubble-next-btn" style="padding: 8px 16px; font-size: 1.1rem;">â†’</button>
                    <div style="margin-left: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <label style="font-size: 0.8rem;">ë§í’ì„  ì „ì²´</label>
                        <input type="checkbox" id="bubble-show-all" checked onchange="toggleShowAll()">
                    </div>
                </div>

                <!-- â•â•â• ë©”ì¸ í¸ì§‘ ì˜ì—­ (2ì»¬ëŸ¼) â•â•â• -->
                <div style="display: grid; grid-template-columns: 1fr 340px; gap: 1.25rem; min-height: 500px;" id="bubble-edit-main">

                    <!-- â˜… ì™¼ìª½: ì´ë¯¸ì§€ + CSS ë§í’ì„  ì˜¤ë²„ë ˆì´ (ì‹¤ì‹œê°„ í”„ë¦¬ë·°) â˜… -->
                    <div style="position: relative; background: #1a1a2e; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <div id="bubble-preview-container" style="position: relative; width: 100%; max-width: 480px; aspect-ratio: 4/5;">
                            <img id="bubble-preview-img" src="" alt="ì”¬ ì´ë¯¸ì§€"
                                 style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
                            <!-- CSS ë§í’ì„  ì˜¤ë²„ë ˆì´ ë ˆì´ì–´ (JSë¡œ ë™ì  ìƒì„±) -->
                            <div id="bubble-overlay-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                            </div>
                        </div>
                    </div>

                    <!-- â˜… ì˜¤ë¥¸ìª½: í¸ì§‘ íŒ¨ë„ â˜… -->
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; overflow-y: auto; max-height: 600px;">

                        <!-- ê¸€ë¡œë²Œ ì„¤ì • -->
                        <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <label style="font-size: 0.8rem; font-weight: 600;">í°íŠ¸</label>
                                <select id="bubble-font-family" onchange="onGlobalSettingChange()" style="padding: 4px 8px; font-size: 0.8rem; flex:1;">
                                    <option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option>
                                    <option value="Do Hyeon">ë„í˜„</option>
                                    <option value="Jua">ì£¼ì•„</option>
                                    <option value="Gaegu">ê°œêµ¬</option>
                                    <option value="Black Han Sans">ë¸”ë™í•œì‚°ìŠ¤</option>
                                </select>
                                <label style="font-size: 0.8rem; font-weight: 600;">ëª¨ì–‘</label>
                                <select id="bubble-global-shape" onchange="applyGlobalShape()" style="padding: 4px 8px; font-size: 0.8rem;">
                                    <option value="round">ë‘¥ê·¼</option>
                                    <option value="square">ì‚¬ê°</option>
                                    <option value="shout">ê°•ì¡°</option>
                                    <option value="thought">ìƒê°</option>
                                </select>
                            </div>
                        </div>

                        <!-- ê°œë³„ ë§í’ì„  í¸ì§‘ ì¹´ë“œ (JSë¡œ ìƒì„±) -->
                        <div id="bubble-edit-cards" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <!-- ë™ì  ìƒì„± -->
                        </div>

                        <!-- ë§í’ì„  ì¶”ê°€ / ë˜ëŒë¦¬ê¸° ë²„íŠ¼ -->
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="addNewBubble()" style="font-size: 0.8rem; padding: 6px; flex: 1;">
                                + ë§í’ì„  ì¶”ê°€
                            </button>
                            <button class="btn btn-secondary" onclick="undoBubbles()" style="font-size: 0.8rem; padding: 6px;" title="ë§ˆì§€ë§‰ ë³€ê²½ ë˜ëŒë¦¬ê¸°">
                                â†© ë˜ëŒë¦¬ê¸°
                            </button>
                            <button class="btn btn-secondary" onclick="resetBubbles()" style="font-size: 0.8rem; padding: 6px; color: var(--danger);" title="ì´ˆê¸° ìƒíƒœë¡œ ë³µì›">
                                ğŸ”„ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>

                <!-- â•â•â• í†¤ ì¡°ì ˆ (ì ‘ì´ì‹) â•â•â• -->
                <details style="margin-top: 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                    <summary style="padding: 0.75rem; cursor: pointer; font-weight: 600; font-size: 0.9rem;">ğŸ¨ í†¤ ì¡°ì ˆ (ì„ íƒì‚¬í•­)</summary>
                    <div style="padding: 0 0.75rem 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="quickTone('brightness', 1.2)" style="font-size: 0.75rem; padding: 5px 10px;">â˜€ï¸ ë°ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('brightness', 0.8)" style="font-size: 0.75rem; padding: 5px 10px;">ğŸŒ™ ì–´ë‘¡ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('saturation', 1.3)" style="font-size: 0.75rem; padding: 5px 10px;">ğŸŒˆ ì±„ë„â†‘</button>
                        <button class="btn btn-secondary" onclick="quickTone('warm_filter', 1.15)" style="font-size: 0.75rem; padding: 5px 10px;">ğŸ”¥ ë”°ëœ»í•˜ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('cool_filter', 1.15)" style="font-size: 0.75rem; padding: 5px 10px;">â„ï¸ ì°¨ê°‘ê²Œ</button>
                        <button class="btn btn-secondary" onclick="quickTone('contrast', 1.3)" style="font-size: 0.75rem; padding: 5px 10px;">ğŸ”³ ëŒ€ë¹„â†‘</button>
                    </div>
                </details>
            </div>

            <!-- í•˜ë‹¨ ì•¡ì…˜ -->
            <div class="actions" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-secondary" onclick="goToStep(5)">â† ì´ì „ (ìƒì„± ê²°ê³¼)</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="exportWithBubbles()" id="bubble-export-btn">ğŸ“¥ ìµœì¢… ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-primary" onclick="proceedFromEditStage()">ë‹¤ìŒ ë‹¨ê³„ (ìº¡ì…˜) â†’</button>
                </div>
            </div>
        </div>

        <!-- Step 5: ì´ë¯¸ì§€ ìƒì„± ë° ê²€í†  -->
        <div class="step-content" id="step-5">
            <!-- ìƒë‹¨ ì§„í–‰ ìƒíƒœ ë°” -->
            <div id="gen-status-bar" class="card" style="display:none; margin-bottom:1rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
                    <div>
                        <span id="gen-status-text" style="font-size:1.1rem; font-weight:700;">ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...</span>
                        <span id="gen-status-count" style="font-size:0.9rem; color:var(--text-muted); margin-left:0.5rem;">0/0</span>
                    </div>
                    <div style="display:flex; gap:0.5rem;" id="gen-control-buttons">
                        <button class="btn btn-secondary" onclick="pauseGeneration()" id="btn-pause" style="padding:6px 14px; font-size:0.85rem;">â¸ï¸ ì¼ì‹œì •ì§€</button>
                        <button class="btn btn-secondary" onclick="stopGeneration()" id="btn-stop" style="padding:6px 14px; font-size:0.85rem; border-color:var(--danger); color:var(--danger);">â¹ï¸ ì¤‘ë‹¨</button>
                    </div>
                </div>
                <div style="background:var(--bg-input); border-radius:10px; height:10px; overflow:hidden; border:1px solid var(--border);">
                    <div id="gen-progress-bar" style="background:linear-gradient(90deg,var(--primary),#7c3aed); height:100%; width:0%; transition:width 0.5s; border-radius:10px;"></div>
                </div>
                <div id="gen-status-sub" style="font-size:0.85rem; color:var(--text-muted); margin-top:0.5rem;">ì²« ë²ˆì§¸ ì”¬ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>

            <!-- ì‹¤ì‹œê°„ ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ -->
            <div class="card">
                <h2 class="card-title">ğŸï¸ ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼</h2>
                <div id="images-container" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:1rem;">
                    <!-- ì”¬ ì¹´ë“œê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>

            <div class="actions" id="image-actions" style="display: none;">
                <button class="btn btn-secondary" onclick="goToStep(4)">â† ì´ì „ (ì„¤ì •)</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="goToEditStage()">ì´ë¯¸ì§€ í¸ì§‘ â†’</button>
                </div>
            </div>
        </div>

        <!-- Step 7: ìº¡ì…˜ ìƒì„± + ìµœì¢… ë°œí–‰ -->
        <div class="step-content" id="step-7">
            <div class="loading" id="loading-caption" style="display: none;">
                <div class="spinner"></div>
                <div>AIê°€ ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ì¶¤í˜• ìº¡ì…˜ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
            <div id="caption-publish-area" style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem;">
                <!-- Left: Instagram Mockup -->
                <div class="card"
                    style="padding: 0; overflow: hidden; background: #fff; color: #000; border-radius: 12px; border: 1px solid #dbdbdb;">
                    <div
                        style="padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #efefef;">
                        <div
                            style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); padding: 2px;">
                            <div
                                style="width: 100%; height: 100%; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">
                                TAX</div>
                        </div>
                        <span style="font-weight: 600; font-size: 14px;">tax_webtoon_pro</span>
                    </div>

                    <div id="insta-preview-carousel"
                        style="aspect-ratio: 1/1; background: #fafafa; position: relative;">
                        <!-- Preview Image will be here -->
                        <img id="insta-preview-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 12px;"
                            id="insta-carousel-index">1 / 8</div>
                    </div>

                    <div style="padding: 12px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                            <span>â¤ï¸</span> <span>ğŸ’¬</span> <span>âœˆï¸</span> <span style="margin-left: auto;">ğŸ”–</span>
                        </div>
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">ì¢‹ì•„ìš” 1,234ê°œ</div>
                        <div style="font-size: 14px; line-height: 1.4;">
                            <span style="font-weight: 600; margin-right: 5px;">tax_webtoon_pro</span>
                            <span id="insta-preview-caption-text">AIê°€ ìƒì„±í•œ ìº¡ì…˜ì´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
                        </div>
                        <div style="color: #0095f6; font-size: 14px; margin-top: 5px;" id="insta-preview-hashtags">#í•´ì‹œíƒœê·¸
                            #ì›¹íˆ°</div>
                    </div>
                </div>

                <!-- Right: Content Review & Actions -->
                <div>
                    <div class="card" style="padding: 1.5rem;">
                        <h2 class="card-title" style="font-size: 1.25rem;">ğŸ“ ìº¡ì…˜ ë° íƒœê·¸ ìˆ˜ì •</h2>
                        <div class="form-group">
                            <label>ğŸ”¥ í›… ë¬¸ì¥</label>
                            <input type="text" id="final-hook" oninput="updateInstaPreview()">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ ë³¸ë¬¸ ìº¡ì…˜</label>
                            <textarea id="final-body" rows="6" oninput="updateInstaPreview()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ğŸ’¡ ì „ë¬¸ê°€ Tip</label>
                            <input type="text" id="final-tip" oninput="updateInstaPreview()">
                        </div>
                        <div class="form-group">
                            <label>#ï¸âƒ£ í•´ì‹œíƒœê·¸</label>
                            <textarea id="final-hashtags" rows="2" oninput="updateInstaPreview()"></textarea>
                        </div>
                    </div>

                    <div class="card" style="padding: 1.5rem; background: var(--bg-input);">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem;">ğŸš€ ë°œí–‰ ì˜µì…˜</h3>
                        <button class="btn btn-primary" onclick="publishToInstagram()"
                            style="width: 100%; margin-bottom: 0.5rem;">ì¸ìŠ¤íƒ€ê·¸ë¨ ì¦‰ì‹œ ë°œí–‰</button>
                        <button class="btn btn-secondary" onclick="downloadImages()" style="width: 100%;">ì´ë¯¸ì§€ ZIP
                            ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="goToStep(6)">â† ì´ì „ ë‹¨ê³„</button>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- ìºëŸ¬ì…€ ì „ìš© íŒ¨ë„ (ê°„ì†Œí™” ì›Œí¬í”Œë¡œìš°) -->
        <!-- ============================================ -->
        <div class="step-content" id="step-carousel" style="display:none;">
            <div class="card">
                <h2 class="card-title">ğŸ  ìºëŸ¬ì…€ ë§Œë“¤ê¸°</h2>
                <p class="card-desc">ì¸ìŠ¤íƒ€ê·¸ë¨ ìºëŸ¬ì…€(ìŠ¬ë¼ì´ë“œí˜•) ì½˜í…ì¸ ë¥¼ ë¹ ë¥´ê²Œ ì œì‘í•©ë‹ˆë‹¤.</p>

                <!-- ì„¤ì • íŒ¨ë„ -->
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">âš™ï¸ ìºëŸ¬ì…€ ì„¤ì •</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ìŠ¬ë¼ì´ë“œ ìˆ˜</label>
                            <select id="carousel-slide-count" style="width:100%; padding: 6px 10px;">
                                <option value="3">3ì¥</option>
                                <option value="5" selected>5ì¥</option>
                                <option value="7">7ì¥</option>
                                <option value="10">10ì¥</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">í…œí”Œë¦¿</label>
                            <select id="carousel-template" style="width:100%; padding: 6px 10px;">
                                <option value="centered">ì¤‘ì•™ ì •ë ¬</option>
                                <option value="left-aligned">ì™¼ìª½ ì •ë ¬</option>
                                <option value="highlight">ê°•ì¡° ìŠ¤íƒ€ì¼</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ë°°ê²½ìƒ‰</label>
                            <input type="color" id="carousel-bg-color" value="#FFFFFF" style="width:100%; height:36px; border:1px solid var(--border); border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ê¸€ììƒ‰</label>
                            <input type="color" id="carousel-text-color" value="#111111" style="width:100%; height:36px; border:1px solid var(--border); border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ê°•ì¡°ìƒ‰</label>
                            <input type="color" id="carousel-accent-color" value="#6366f1" style="width:100%; height:36px; border:1px solid var(--border); border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">í°íŠ¸</label>
                            <select id="carousel-font" style="width:100%; padding: 6px 10px;">
                                <option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option>
                                <option value="Do Hyeon">ë„í˜„</option>
                                <option value="Jua">ì£¼ì•„</option>
                                <option value="Black Han Sans">ë¸”ë™í•œì‚°ìŠ¤</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateCarouselSlides()" style="width: 100%;">
                        ğŸ  AI ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸ ìƒì„±
                    </button>
                </div>

                <!-- ìƒì„±ëœ ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸ í¸ì§‘ -->
                <div id="carousel-slides-editor" style="display:none; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ“ ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸ í¸ì§‘</h3>
                    <div id="carousel-slides-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                    <button class="btn btn-primary" onclick="renderCarouselImages()" style="width: 100%; margin-top: 1rem;">
                        ğŸ–¼ï¸ ì´ë¯¸ì§€ ë Œë”ë§ (Playwright)
                    </button>
                </div>

                <!-- ë Œë”ë§ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="carousel-preview" style="display:none;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸°</h3>
                    <div id="carousel-preview-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;"></div>
                    <button class="btn btn-primary" onclick="renderCarouselImages()" style="margin-top: 1rem;">
                        ğŸ”„ ë‹¤ì‹œ ë Œë”ë§
                    </button>
                </div>

                <div id="carousel-status" style="display:none; margin-top: 1rem; padding: 10px; background: var(--bg-card); border-radius: 8px; font-size: 0.85rem;"></div>

                <!-- ìº¡ì…˜ + ë°œí–‰ -->
                <div id="carousel-publish-area" style="display:none; margin-top: 1.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ“ ìº¡ì…˜ & ë°œí–‰</h3>
                    <div class="form-group">
                        <label>ğŸ”¥ í›… ë¬¸ì¥</label>
                        <input type="text" id="carousel-hook" placeholder="ìºëŸ¬ì…€ ì²« ë¬¸ì¥" style="width:100%;">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ ìº¡ì…˜</label>
                        <textarea id="carousel-caption" rows="4" placeholder="ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜..." style="width:100%;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>#ï¸âƒ£ í•´ì‹œíƒœê·¸</label>
                        <textarea id="carousel-hashtags" rows="2" placeholder="#ì„¸ë¬´ #ì ˆì„¸íŒ" style="width:100%;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateCarouselCaption()" style="flex:1;">âœ¨ AI ìº¡ì…˜ ìƒì„±</button>
                        <button class="btn btn-secondary" onclick="downloadCarouselImages()" style="flex:1;">ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="exitCarouselMode()">â† ìë£Œ ìˆ˜ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- ì¹´ë“œë‰´ìŠ¤ ì „ìš© íŒ¨ë„ (ê°„ì†Œí™” ì›Œí¬í”Œë¡œìš°) -->
        <!-- ============================================ -->
        <div class="step-content" id="step-cardnews" style="display:none;">
            <div class="card">
                <h2 class="card-title">ğŸ“° ì¹´ë“œë‰´ìŠ¤ ë§Œë“¤ê¸°</h2>
                <p class="card-desc">ì¸ìŠ¤íƒ€ê·¸ë¨ ì¹´ë“œë‰´ìŠ¤ë¥¼ ë¹ ë¥´ê²Œ ì œì‘í•©ë‹ˆë‹¤. (4:5 ì„¸ë¡œí˜•)</p>

                <!-- ì„¤ì • íŒ¨ë„ -->
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">âš™ï¸ ì¹´ë“œë‰´ìŠ¤ ì„¤ì •</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ì¹´ë“œ ìˆ˜</label>
                            <select id="cardnews-card-count" style="width:100%; padding: 6px 10px;">
                                <option value="3">3ì¥</option>
                                <option value="5" selected>5ì¥</option>
                                <option value="7">7ì¥</option>
                                <option value="10">10ì¥</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">í…œí”Œë¦¿</label>
                            <select id="cardnews-template" style="width:100%; padding: 6px 10px;">
                                <option value="centered">ì¤‘ì•™ ì •ë ¬</option>
                                <option value="left-aligned">ì™¼ìª½ ì •ë ¬</option>
                                <option value="highlight">ê°•ì¡° ìŠ¤íƒ€ì¼</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ë°°ê²½ìƒ‰</label>
                            <input type="color" id="cardnews-bg-color" value="#1a1a2e" style="width:100%; height:36px; border:1px solid var(--border); border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ê¸€ììƒ‰</label>
                            <input type="color" id="cardnews-text-color" value="#FFFFFF" style="width:100%; height:36px; border:1px solid var(--border); border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">ê°•ì¡°ìƒ‰</label>
                            <input type="color" id="cardnews-accent-color" value="#e94560" style="width:100%; height:36px; border:1px solid var(--border); border-radius:6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; font-weight: 600;">í°íŠ¸</label>
                            <select id="cardnews-font" style="width:100%; padding: 6px 10px;">
                                <option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option>
                                <option value="Do Hyeon">ë„í˜„</option>
                                <option value="Jua">ì£¼ì•„</option>
                                <option value="Black Han Sans">ë¸”ë™í•œì‚°ìŠ¤</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateCardNewsCards()" style="width: 100%;">
                        ğŸ“° AI ì¹´ë“œ í…ìŠ¤íŠ¸ ìƒì„±
                    </button>
                </div>

                <!-- ì¹´ë“œ í…ìŠ¤íŠ¸ í¸ì§‘ -->
                <div id="cardnews-cards-editor" style="display:none; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ“ ì¹´ë“œ í…ìŠ¤íŠ¸ í¸ì§‘</h3>
                    <div id="cardnews-cards-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                    <button class="btn btn-primary" onclick="renderCardNewsImages()" style="width: 100%; margin-top: 1rem;">
                        ğŸ–¼ï¸ ì´ë¯¸ì§€ ë Œë”ë§ (Playwright)
                    </button>
                </div>

                <!-- ë Œë”ë§ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="cardnews-preview" style="display:none;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ–¼ï¸ ë¯¸ë¦¬ë³´ê¸°</h3>
                    <div id="cardnews-preview-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem;"></div>
                    <button class="btn btn-primary" onclick="renderCardNewsImages()" style="margin-top: 1rem;">
                        ğŸ”„ ë‹¤ì‹œ ë Œë”ë§
                    </button>
                </div>

                <div id="cardnews-status" style="display:none; margin-top: 1rem; padding: 10px; background: var(--bg-card); border-radius: 8px; font-size: 0.85rem;"></div>

                <!-- ìº¡ì…˜ + ë°œí–‰ -->
                <div id="cardnews-publish-area" style="display:none; margin-top: 1.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ“ ìº¡ì…˜ & ë°œí–‰</h3>
                    <div class="form-group">
                        <label>ğŸ”¥ í›… ë¬¸ì¥</label>
                        <input type="text" id="cardnews-hook" placeholder="ì¹´ë“œë‰´ìŠ¤ ì²« ë¬¸ì¥" style="width:100%;">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ ìº¡ì…˜</label>
                        <textarea id="cardnews-caption" rows="4" placeholder="ì¸ìŠ¤íƒ€ê·¸ë¨ ìº¡ì…˜..." style="width:100%;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>#ï¸âƒ£ í•´ì‹œíƒœê·¸</label>
                        <textarea id="cardnews-hashtags" rows="2" placeholder="#ì„¸ë¬´ #ì¹´ë“œë‰´ìŠ¤" style="width:100%;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateCardNewsCaption()" style="flex:1;">âœ¨ AI ìº¡ì…˜ ìƒì„±</button>
                        <button class="btn btn-secondary" onclick="downloadCardNewsImages()" style="flex:1;">ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </div>

            <div class="actions" style="margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="exitCardNewsMode()">â† ìë£Œ ìˆ˜ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>

    </main>

    <script>
        var currentStep = 1;
        var sessionId = null;
        var storyData = null;
        var collectedData = [];
        var characters = [];
        var selectedMode = 'auto'; // 'auto' or 'manual'

        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => {
                c.classList.toggle('selected', c.dataset.mode === mode);
            });

            if (mode === 'auto') {
                document.getElementById('keyword-input-area').style.display = 'block';
                document.getElementById('manual-input-area').style.display = 'none';
                document.getElementById('btn-start-next').innerText = 'ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€';
            } else {
                document.getElementById('keyword-input-area').style.display = 'none';
                document.getElementById('manual-input-area').style.display = 'block';
                document.getElementById('btn-start-next').innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
            }
        }

        // --- Step 1: ë¶„ì•¼ ê°ì§€ (Intelligent Start) ---
        async function detectField() {
            const keyword = document.getElementById('keyword').value.trim();
            const model = document.getElementById('ai-model-select').value;

            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.querySelector('#step-1 .btn-secondary');
            const originalText = btn.innerText;
            btn.innerText = 'AI ë¶„ì„ ì¤‘...';
            btn.disabled = true;

            try {
                // 1. ì„¸ì…˜ ì‹œì‘ ë° í•„ë“œ ê°ì§€
                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'auto', keyword, model })
                });
                const data = await res.json();
                sessionId = data.session_id;
                localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥

                // 2. ì„¸ì…˜ ì •ë³´ ì¡°íšŒ (ê°ì§€ëœ ê²°ê³¼ í™•ì¸)
                const sessionRes = await fetch(`/api/workflow/session/${sessionId}`);
                const session = await sessionRes.json();
                const info = session.field_info;

                // 3. Step 1 ê²°ê³¼ UI í‘œì‹œ
                document.getElementById('smart-analysis-result').style.display = 'block';
                // ê¸°ì¡´ ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¹€
                document.getElementById('btn-start-next').style.display = 'none';

                // ê°’ ë°”ì¸ë”©
                document.getElementById('confirmed-field').value = info.field_code || 'GENERAL';
                document.getElementById('confirmed-year').innerText = info.target_year || new Date().getFullYear();
                document.getElementById('hidden-target-year').value = info.target_year || new Date().getFullYear();

                if (info.requires_legal_verification) {
                    document.getElementById('verification-needed-badge').style.display = 'flex';
                } else {
                    document.getElementById('verification-needed-badge').style.display = 'none';
                }

                btn.innerText = 'ë‹¤ì‹œ ê°ì§€';
                btn.disabled = false;

            } catch (e) {
                console.error("Detect Field Error:", e);
                alert('ë¶„ì•¼ ê°ì§€ ì˜¤ë¥˜: ' + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function confirmAndStart() {
            // ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ê°’ (í˜¹ì€ AI ê°’)ìœ¼ë¡œ í™•ì •
            const finalField = document.getElementById('confirmed-field').value;
            const finalYear = document.getElementById('hidden-target-year').value;

            // Step 1 -> Step 2
            navigateToStep(2);
            startDataCollection();
        }

        async function startWorkflow() {
            if (selectedMode === 'manual') {
                // ìˆ˜ë™ ëª¨ë“œ: ì‚¬ìš©ìê°€ ì…ë ¥í•œ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±
                const manualContent = document.getElementById('manual-script').value.trim();
                if (!manualContent) {
                    alert('ì‹œë‚˜ë¦¬ì˜¤ ë˜ëŠ” í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const btn = document.getElementById('btn-start-next');
                btn.innerText = 'ì…ë ¥ ë‚´ìš© ì •ë¦¬ ì¤‘...';
                btn.disabled = true;

                try {
                    // ì„¸ì…˜ ìƒì„± (ìˆ˜ë™ ëª¨ë“œ)
                    const startRes = await fetch('/api/workflow/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'manual' })
                    });
                    const startData = await startRes.json();
                    sessionId = startData.session_id;
                    localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥

                    // Step 2ë¡œ ì´ë™
                    goToStep(2);

                    // ìˆ˜ë™ ëª¨ë“œ ì „ìš© ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ í˜¸ì¶œ
                    await collectManualData(manualContent);

                    btn.innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
                    btn.disabled = false;
                } catch (e) {
                    console.error(e);
                    alert('ìˆ˜ë™ ëª¨ë“œ ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                    btn.innerText = 'ë‹¤ìŒ ë‹¨ê³„: ìŠ¤í† ë¦¬ ì§ì ‘ êµ¬ì„± â†’';
                    btn.disabled = false;
                }
                return;
            }

            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // [ë³€ê²½] ê°ì§€ ë‹¨ê³„ ì—†ì´ ë°”ë¡œ ì‹œì‘
            // ë¨¼ì € ì„¸ì…˜ì„ ìƒì„±í•˜ê³ 
            const model = document.getElementById('ai-model-select').value;
            try {
                const btn = document.getElementById('btn-start-next');
                btn.innerText = 'AIê°€ ë¶„ì„ ë° ì‹œì‘ ì¤‘...';
                btn.disabled = true;

                const res = await fetch('/api/workflow/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'auto', keyword, model })
                });
                const data = await res.json();
                sessionId = data.session_id;
                localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥

                btn.innerText = 'ì›¹íˆ° ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€';
                btn.disabled = false;

                // ë°”ë¡œ ìë£Œ ìˆ˜ì§‘ ë‹¨ê³„ë¡œ ì´ë™
                goToStep(2);
                collectData();

            } catch (e) {
                console.error(e);
                alert('ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
                document.getElementById('btn-start-next').disabled = false;
            }
        }

        // --- Step 2: ìˆ˜ë™ ëª¨ë“œ ìë£Œ íŒŒì‹± ---
        async function collectManualData(content) {
            const loadingEl = document.getElementById('loading-data');
            const reviewArea = document.getElementById('data-review-area');
            const actionsEl = document.getElementById('data-actions');

            // ë¡œë”© ë©”ì‹œì§€ ë³€ê²½ (ìˆ˜ë™ ëª¨ë“œìš©)
            loadingEl.querySelector('div:last-child').innerText = 'ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            try {
                const res = await fetch('/api/workflow/parse-manual-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        content: content
                    })
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.detail || 'íŒŒì‹± ì˜¤ë¥˜');
                }

                collectedData = data.items || [];

                renderDataItems();
                saveDataToStorage(); // localStorageì— ì €ì¥

                // ì”¬ ìˆ˜ ì¶”ì²œ (ìˆ˜ë™ ëª¨ë“œ)
                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ë‚´ìš© íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        // --- Step 2: ìë£Œ ìˆ˜ì§‘ ---
        async function collectData() {
            const loadingEl = document.getElementById('loading-data');
            const reviewArea = document.getElementById('data-review-area');
            const actionsEl = document.getElementById('data-actions');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            try {
                const keyword = document.getElementById('keyword').value;
                const model = document.getElementById('ai-model-select').value;

                const res = await fetch('/api/workflow/collect-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, keyword, model })
                });
                const data = await res.json();
                collectedData = data.items || [];

                renderDataItems();
                saveDataToStorage(); // localStorageì— ì €ì¥

                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                alert('ìë£Œ ìˆ˜ì§‘ ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function renderDataItems() {
            const container = document.getElementById('data-container');
            container.innerHTML = collectedData.map((item, idx) => `
                <div class="char-card data-item" 
                     draggable="true"
                     ondragstart="handleDragStart(event, ${idx})"
                     ondragend="handleDragEnd(event)"
                     ondragover="handleDragOver(event, ${idx})"
                     ondrop="handleDrop(event, ${idx})"
                     style="cursor: grab; margin-bottom: 0.5rem; align-items: flex-start; flex-direction: column; transition: all 0.2s;">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <span style="font-weight: 600;" onclick="toggleDataBody(${idx})">
                            <span style="cursor: grab; margin-right: 0.5rem;">â‹®â‹®</span>
                            ğŸ“„ ${item.title}
                        </span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); editData(${idx})">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteData(${idx})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div id="data-body-${idx}" onclick="event.stopPropagation();" style="display: block; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; border-top: 1px solid var(--border); padding-top: 0.5rem; width: 100%;">
                        ${item.content}
                    </div>
                </div>
            `).join('');
        }

        function toggleDataBody(idx) {
            const el = document.getElementById(`data-body-${idx}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // === localStorage ë°ì´í„° ì €ì¥/ë³µì› ===
        function saveDataToStorage() {
            if (sessionId && collectedData.length > 0) {
                localStorage.setItem(`webtoon_data_${sessionId}`, JSON.stringify(collectedData));
                console.log('[Storage] ë°ì´í„° ì €ì¥ë¨:', collectedData.length, 'ê°œ í•­ëª©');
            }
        }

        function loadDataFromStorage() {
            if (sessionId) {
                const saved = localStorage.getItem(`webtoon_data_${sessionId}`);
                if (saved) {
                    collectedData = JSON.parse(saved);
                    console.log('[Storage] ë°ì´í„° ë³µì›ë¨:', collectedData.length, 'ê°œ í•­ëª©');
                    return true;
                }
            }
            return false;
        }

        function clearDataFromStorage() {
            if (sessionId) {
                localStorage.removeItem(`webtoon_data_${sessionId}`);
            }
        }

        // === ì •ë³´ í•­ëª© ìˆ˜ì • ===
        function editData(idx) {
            const item = collectedData[idx];
            const newTitle = prompt('ì œëª©ì„ ìˆ˜ì •í•˜ì„¸ìš”:', item.title);
            if (newTitle === null) return;

            const newContent = prompt('ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”:', item.content);
            if (newContent === null) return;

            collectedData[idx] = { title: newTitle, content: newContent };
            renderDataItems();
            saveDataToStorage();
        }

        // === ì •ë³´ í•­ëª© ì‚­ì œ ===
        function deleteData(idx) {
            if (confirm(`"${collectedData[idx].title}" í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                collectedData.splice(idx, 1);
                renderDataItems();
                saveDataToStorage();

                // ì”¬ ìˆ˜ ì¬ê³„ì‚°
                const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
                document.getElementById('total-scene-count').value = recScenes;
                document.getElementById('ai-rec-scenes').innerText = recScenes;
            }
        }

        // === ì •ë³´ í•­ëª© ì¶”ê°€ ëª¨ë‹¬ ===
        function openAddDataModal() {
            const title = prompt('ìƒˆ í•­ëª©ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!title) return;

            const content = prompt('ìƒˆ í•­ëª©ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!content) return;

            collectedData.push({ title, content });
            renderDataItems();
            saveDataToStorage();

            // ì”¬ ìˆ˜ ì¬ê³„ì‚°
            const recScenes = Math.min(Math.max(collectedData.length * 1.5, 6), 15).toFixed(0);
            document.getElementById('total-scene-count').value = recScenes;
            document.getElementById('ai-rec-scenes').innerText = recScenes;
        }

        // === ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì •ë ¬ ===
        let draggedIdx = null;

        function handleDragStart(e, idx) {
            draggedIdx = idx;
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedIdx = null;
            // ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì œê±°
            document.querySelectorAll('.data-item').forEach(el => {
                el.style.borderTop = '';
                el.style.borderBottom = '';
            });
        }

        function handleDragOver(e, idx) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // ë“œë¡­ ìœ„ì¹˜ í‘œì‹œ
            const items = document.querySelectorAll('.data-item');
            items.forEach((el, i) => {
                el.style.borderTop = '';
                el.style.borderBottom = '';
                if (i === idx) {
                    if (draggedIdx < idx) {
                        el.style.borderBottom = '3px solid var(--primary)';
                    } else if (draggedIdx > idx) {
                        el.style.borderTop = '3px solid var(--primary)';
                    }
                }
            });
        }

        function handleDrop(e, targetIdx) {
            e.preventDefault();
            if (draggedIdx === null || draggedIdx === targetIdx) return;

            // ë°°ì—´ ìˆœì„œ ë³€ê²½
            const [removed] = collectedData.splice(draggedIdx, 1);
            collectedData.splice(targetIdx, 0, removed);

            renderDataItems();
            saveDataToStorage();
            console.log('[Drag] ìˆœì„œ ë³€ê²½ ì™„ë£Œ');
        }

        // ì½˜í…ì¸  íƒ€ì… (webtoon | carousel | cardnews)
        let currentContentType = 'webtoon';

        function selectContentType(type) {
            currentContentType = type;

            if (type === 'webtoon') {
                confirmData();
            } else if (type === 'carousel') {
                showContentPanel('carousel');
            } else if (type === 'cardnews') {
                showContentPanel('cardnews');
            }
        }

        function showContentPanel(panel) {
            // ëª¨ë“  step-content ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');

            const target = document.getElementById(`step-${panel}`);
            if (target) {
                target.style.display = 'block';
                target.classList.add('active');
            }
        }

        function exitCarouselMode() {
            document.getElementById('step-carousel').style.display = 'none';
            goToStep(2);
        }

        function exitCardNewsMode() {
            document.getElementById('step-cardnews').style.display = 'none';
            goToStep(2);
        }

        async function confirmData() {
            goToStep(3);
            generateStory();
        }

        // â”€â”€ ìºëŸ¬ì…€ JavaScript â”€â”€
        let carouselSessionId = null;
        let carouselSlides = [];

        async function generateCarouselSlides() {
            const statusEl = document.getElementById('carousel-status');
            if (statusEl) { statusEl.style.display = 'block'; statusEl.innerHTML = 'â³ AIê°€ ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸ë¥¼ ìƒì„± ì¤‘...'; }

            const topic = collectedData.map(d => d.title || d.text || '').join(' ').substring(0, 500) || 'ì„¸ë¬´ ì •ë³´';

            try {
                const resp = await fetch('/api/carousel/generate-slides', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        collected_data: JSON.stringify(collectedData).substring(0, 3000),
                        slide_count: parseInt(document.getElementById('carousel-slide-count')?.value || '5'),
                        bg_color: document.getElementById('carousel-bg-color')?.value || '#FFFFFF',
                        text_color: document.getElementById('carousel-text-color')?.value || '#111111',
                        accent_color: document.getElementById('carousel-accent-color')?.value || '#6366f1',
                        font_family: document.getElementById('carousel-font')?.value || 'Nanum Gothic',
                        template: document.getElementById('carousel-template')?.value || 'centered',
                    }),
                });
                const data = await resp.json();
                if (data.session_id) {
                    carouselSessionId = data.session_id;
                    carouselSlides = data.slides;
                    renderCarouselEditor(data.slides);
                    if (statusEl) statusEl.innerHTML = `âœ… ${data.total}ê°œ ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ! í¸ì§‘ í›„ ë Œë”ë§í•˜ì„¸ìš”.`;
                } else {
                    if (statusEl) statusEl.innerHTML = `âŒ ì˜¤ë¥˜: ${data.detail || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                }
            } catch (err) {
                if (statusEl) statusEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`;
            }
        }

        function renderCarouselEditor(slides) {
            const editor = document.getElementById('carousel-slides-editor');
            const list = document.getElementById('carousel-slides-list');
            if (!editor || !list) return;
            editor.style.display = 'block';

            list.innerHTML = slides.map((s, i) => `
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">ìŠ¬ë¼ì´ë“œ ${i + 1}</div>
                    <input type="text" id="carousel-title-${i}" value="${(s.title || '').replace(/"/g, '&quot;')}"
                        placeholder="ì œëª©" style="width: 100%; margin-bottom: 6px; font-weight: 700;">
                    <textarea id="carousel-body-${i}" rows="2" placeholder="ë³¸ë¬¸"
                        style="width: 100%; resize: vertical;">${s.body || ''}</textarea>
                </div>
            `).join('');
        }

        async function renderCarouselImages() {
            if (!carouselSessionId) return alert('ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('carousel-status');
            if (statusEl) { statusEl.style.display = 'block'; statusEl.innerHTML = 'â³ Playwrightë¡œ ì´ë¯¸ì§€ ë Œë”ë§ ì¤‘...'; }

            // í¸ì§‘ëœ í…ìŠ¤íŠ¸ ì €ì¥
            for (let i = 0; i < carouselSlides.length; i++) {
                const titleEl = document.getElementById(`carousel-title-${i}`);
                const bodyEl = document.getElementById(`carousel-body-${i}`);
                if (titleEl) {
                    await fetch(`/api/carousel/${carouselSessionId}/edit-slide`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slide_index: i, title: titleEl.value, body: bodyEl?.value || '' }),
                    });
                }
            }

            try {
                const resp = await fetch(`/api/carousel/${carouselSessionId}/render`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bg_color: document.getElementById('carousel-bg-color')?.value,
                        text_color: document.getElementById('carousel-text-color')?.value,
                        accent_color: document.getElementById('carousel-accent-color')?.value,
                        font_family: document.getElementById('carousel-font')?.value,
                        template: document.getElementById('carousel-template')?.value,
                    }),
                });
                const data = await resp.json();
                if (data.success) {
                    renderCarouselPreview(data.images);
                    if (statusEl) statusEl.innerHTML = `âœ… ${data.total}ê°œ ìŠ¬ë¼ì´ë“œ ë Œë”ë§ ì™„ë£Œ!`;
                } else {
                    if (statusEl) statusEl.innerHTML = `âŒ ë Œë”ë§ ì˜¤ë¥˜: ${data.detail || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                }
            } catch (err) {
                if (statusEl) statusEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`;
            }
        }

        function renderCarouselPreview(images) {
            const preview = document.getElementById('carousel-preview');
            const grid = document.getElementById('carousel-preview-grid');
            if (!preview || !grid) return;
            preview.style.display = 'block';

            grid.innerHTML = images.map((url, i) => `
                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                    <img src="${url}?t=${Date.now()}" style="width:100%; display:block;" alt="ìŠ¬ë¼ì´ë“œ ${i+1}">
                    <div style="text-align:center; padding:4px; font-size:0.75rem; color:var(--text-muted);">${i+1}/${images.length}</div>
                </div>
            `).join('');

            // ë°œí–‰ íŒ¨ë„ í‘œì‹œ
            const pub = document.getElementById('carousel-publish-area');
            if (pub) pub.style.display = 'block';
        }

        async function generateCarouselCaption() {
            const hookEl = document.getElementById('carousel-hook');
            const capEl = document.getElementById('carousel-caption');
            const tagEl = document.getElementById('carousel-hashtags');
            if (!carouselSessionId) return;

            try {
                const resp = await fetch(`/api/carousel/${carouselSessionId}`);
                const session = await resp.json();
                const topic = session.topic || '';
                const slideTexts = (session.slides || []).map(s => s.title + ': ' + s.body).join('\n');

                const aiResp = await fetch('/api/workflow/generate-common-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, content: slideTexts, content_type: 'carousel' }),
                });
                const data = await aiResp.json();
                if (data.hook) hookEl.value = data.hook;
                if (data.body) capEl.value = data.body;
                if (data.hashtags) tagEl.value = data.hashtags;
            } catch (err) {
                alert('ìº¡ì…˜ ìƒì„± ì˜¤ë¥˜: ' + err.message);
            }
        }

        function downloadCarouselImages() {
            alert('ìºëŸ¬ì…€ ì´ë¯¸ì§€ê°€ output/carousel_' + carouselSessionId + '/ í´ë”ì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }

        // â”€â”€ ì¹´ë“œë‰´ìŠ¤ JavaScript â”€â”€
        let cardnewsSessionId = null;
        let cardnewsCards = [];

        async function generateCardNewsCards() {
            const statusEl = document.getElementById('cardnews-status');
            if (statusEl) { statusEl.style.display = 'block'; statusEl.innerHTML = 'â³ AIê°€ ì¹´ë“œ í…ìŠ¤íŠ¸ë¥¼ ìƒì„± ì¤‘...'; }

            const topic = collectedData.map(d => d.title || d.text || '').join(' ').substring(0, 500) || 'ì„¸ë¬´ ì •ë³´';

            try {
                const resp = await fetch('/api/cardnews/generate-cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        collected_data: JSON.stringify(collectedData).substring(0, 3000),
                        card_count: parseInt(document.getElementById('cardnews-card-count')?.value || '5'),
                        bg_color: document.getElementById('cardnews-bg-color')?.value || '#1a1a2e',
                        text_color: document.getElementById('cardnews-text-color')?.value || '#FFFFFF',
                        accent_color: document.getElementById('cardnews-accent-color')?.value || '#e94560',
                        font_family: document.getElementById('cardnews-font')?.value || 'Nanum Gothic',
                        template: document.getElementById('cardnews-template')?.value || 'centered',
                    }),
                });
                const data = await resp.json();
                if (data.session_id) {
                    cardnewsSessionId = data.session_id;
                    cardnewsCards = data.cards;
                    renderCardNewsEditor(data.cards);
                    if (statusEl) statusEl.innerHTML = `âœ… ${data.total}ì¥ ì¹´ë“œ í…ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ!`;
                } else {
                    if (statusEl) statusEl.innerHTML = `âŒ ì˜¤ë¥˜: ${data.detail || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                }
            } catch (err) {
                if (statusEl) statusEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`;
            }
        }

        function renderCardNewsEditor(cards) {
            const editor = document.getElementById('cardnews-cards-editor');
            const list = document.getElementById('cardnews-cards-list');
            if (!editor || !list) return;
            editor.style.display = 'block';

            list.innerHTML = cards.map((c, i) => `
                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">ì¹´ë“œ ${i + 1}</div>
                    <input type="text" id="cardnews-title-${i}" value="${(c.title || '').replace(/"/g, '&quot;')}"
                        placeholder="ì œëª©" style="width: 100%; margin-bottom: 6px; font-weight: 700;">
                    <textarea id="cardnews-body-${i}" rows="3" placeholder="ë³¸ë¬¸"
                        style="width: 100%; resize: vertical;">${c.body || ''}</textarea>
                </div>
            `).join('');
        }

        async function renderCardNewsImages() {
            if (!cardnewsSessionId) return alert('ì¹´ë“œ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('cardnews-status');
            if (statusEl) { statusEl.style.display = 'block'; statusEl.innerHTML = 'â³ Playwrightë¡œ ì´ë¯¸ì§€ ë Œë”ë§ ì¤‘...'; }

            for (let i = 0; i < cardnewsCards.length; i++) {
                const titleEl = document.getElementById(`cardnews-title-${i}`);
                const bodyEl = document.getElementById(`cardnews-body-${i}`);
                if (titleEl) {
                    await fetch(`/api/cardnews/${cardnewsSessionId}/edit-card`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ card_index: i, title: titleEl.value, body: bodyEl?.value || '' }),
                    });
                }
            }

            try {
                const resp = await fetch(`/api/cardnews/${cardnewsSessionId}/render`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bg_color: document.getElementById('cardnews-bg-color')?.value,
                        text_color: document.getElementById('cardnews-text-color')?.value,
                        accent_color: document.getElementById('cardnews-accent-color')?.value,
                        font_family: document.getElementById('cardnews-font')?.value,
                        template: document.getElementById('cardnews-template')?.value,
                    }),
                });
                const data = await resp.json();
                if (data.success) {
                    renderCardNewsPreview(data.images);
                    if (statusEl) statusEl.innerHTML = `âœ… ${data.total}ì¥ ì¹´ë“œ ë Œë”ë§ ì™„ë£Œ!`;
                } else {
                    if (statusEl) statusEl.innerHTML = `âŒ ë Œë”ë§ ì˜¤ë¥˜: ${data.detail || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                }
            } catch (err) {
                if (statusEl) statusEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`;
            }
        }

        function renderCardNewsPreview(images) {
            const preview = document.getElementById('cardnews-preview');
            const grid = document.getElementById('cardnews-preview-grid');
            if (!preview || !grid) return;
            preview.style.display = 'block';

            grid.innerHTML = images.map((url, i) => `
                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                    <img src="${url}?t=${Date.now()}" style="width:100%; display:block;" alt="ì¹´ë“œ ${i+1}">
                    <div style="text-align:center; padding:4px; font-size:0.75rem; color:var(--text-muted);">${i+1}/${images.length}</div>
                </div>
            `).join('');

            // ë°œí–‰ íŒ¨ë„ í‘œì‹œ
            const pub = document.getElementById('cardnews-publish-area');
            if (pub) pub.style.display = 'block';
        }

        async function generateCardNewsCaption() {
            const hookEl = document.getElementById('cardnews-hook');
            const capEl = document.getElementById('cardnews-caption');
            const tagEl = document.getElementById('cardnews-hashtags');
            if (!cardnewsSessionId) return;

            try {
                const resp = await fetch(`/api/cardnews/${cardnewsSessionId}`);
                const session = await resp.json();
                const topic = session.topic || '';
                const cardTexts = (session.cards || []).map(c => c.title + ': ' + c.body).join('\n');

                const aiResp = await fetch('/api/workflow/generate-common-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, content: cardTexts, content_type: 'cardnews' }),
                });
                const data = await aiResp.json();
                if (data.hook) hookEl.value = data.hook;
                if (data.body) capEl.value = data.body;
                if (data.hashtags) tagEl.value = data.hashtags;
            } catch (err) {
                alert('ìº¡ì…˜ ìƒì„± ì˜¤ë¥˜: ' + err.message);
            }
        }

        function downloadCardNewsImages() {
            alert('ì¹´ë“œë‰´ìŠ¤ ì´ë¯¸ì§€ê°€ output/cardnews_' + cardnewsSessionId + '/ í´ë”ì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }

        // --- Step 3: ìŠ¤í† ë¦¬ ìƒì„± ---
        async function generateStory() {
            const loadingEl = document.getElementById('loading-story');
            const reviewArea = document.getElementById('story-review-area');
            const actionsEl = document.getElementById('story-actions');

            loadingEl.style.display = 'block';
            reviewArea.style.display = 'none';
            actionsEl.style.display = 'none';

            const sceneCount = parseInt(document.getElementById('total-scene-count').value);

            try {
                const storyModel = document.getElementById('ai-model-select') ? document.getElementById('ai-model-select').value : 'gemini-2.0-flash';
                const res = await fetch('/api/workflow/generate-story', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        scene_count: sceneCount,
                        questioner_type: 'ì¼ë°˜ì¸',
                        expert_type: 'ì„¸ë¬´ì‚¬',
                        model: storyModel
                    })
                });
                const data = await res.json();

                // API ì—ëŸ¬ ì²´í¬
                if (!res.ok) {
                    throw new Error(data.detail || 'ìŠ¤í† ë¦¬ ìƒì„± ì‹¤íŒ¨');
                }

                if (data.session_id) {
                    sessionId = data.session_id;
                    localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥ (ì•ˆì „ì¥ì¹˜)
                }

                storyData = data.story;

                // storyDataê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
                if (!storyData) {
                    throw new Error('ìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }

                characters = storyData.characters || [];

                renderCharacters();
                renderScenes(storyData.scenes || []);

                loadingEl.style.display = 'none';
                reviewArea.style.display = 'block';
                actionsEl.style.display = 'flex';
            } catch (e) {
                console.error('ìŠ¤í† ë¦¬ ìƒì„± ì˜¤ë¥˜:', e);
                alert('ìŠ¤í† ë¦¬ ìƒì„± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
            }
        }

        function renderCharacters() {
            const container = document.getElementById('character-profiles');
            container.innerHTML = characters.map((c, idx) => `
                <div class="char-card" style="position: relative;">
                    <div class="char-avatar">ğŸ‘¤</div>
                    <div class="char-info">
                        <div class="char-name">${c.name} <span class="char-role">${c.role}</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${c.appearance}</div>
                    </div>
                    <button class="btn btn-secondary" style="position: absolute; top: 0.5rem; right: 0.5rem; padding: 2px 8px; font-size: 0.7rem;" onclick="editCharacter(${idx})">ìˆ˜ì •</button>
                </div>
            `).join('');
        }

        function editCharacter(idx) {
            const char = characters[idx];
            const newName = prompt('ìºë¦­í„° ì´ë¦„:', char.name);
            if (newName === null) return;

            const newRole = prompt('ì—­í•  (ì „ë¬¸ê°€/ì§ˆë¬¸ì/ì¡°ë ¥ì):', char.role);
            if (newRole === null) return;

            const newAppearance = prompt('ì™¸ëª¨ ë¬˜ì‚¬:', char.appearance);
            if (newAppearance === null) return;

            characters[idx] = {
                ...char,
                name: newName || char.name,
                role: newRole || char.role,
                appearance: newAppearance || char.appearance
            };

            // storyDataë„ ì—…ë°ì´íŠ¸
            if (storyData && storyData.characters) {
                storyData.characters[idx] = characters[idx];
            }

            renderCharacters();
        }

        function renderScenes(scenes) {
            const container = document.getElementById('scenes-container');
            container.innerHTML = scenes.map((s, idx) => {
                const densityWarnings = validateSceneRules(s);
                return `
                <div class="card" style="margin-bottom: 1rem; border: 1px solid ${densityWarnings.length > 0 ? 'var(--warning)' : 'var(--border)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600;">ì”¬ ${s.scene_number}</span>
                        <div style="display: flex; gap: 0.5rem;">
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="editScene(${idx})">ìˆ˜ì •</button>
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" onclick="regenerateScene(${idx})">ì¬ìƒì„±</button>
                             <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem; background-color: #fee2e2; color: #dc2626; border: 1px solid #fecaca;" onclick="deleteScene(${idx})">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">ğŸ¬ ${s.scene_description}</div>
                    ${s.dialogues.map((d, dIdx) => `
                        <div style="background: var(--bg-input); padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; font-size: 0.875rem; cursor: pointer;" onclick="editDialogue(${idx}, ${dIdx})">
                            <span style="font-weight: 600; color: var(--primary);">${d.character}:</span> ${d.text}
                            <span style="float: right; font-size: 0.7rem; color: var(--text-muted);">[${d.emotion}]</span>
                        </div>
                    `).join('')}
                    ${s.narration ? `<div style="font-style: italic; color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem; cursor: pointer;" onclick="editNarration(${idx})">ğŸ’¬ ${s.narration}</div>` : ''}
                    
                    ${densityWarnings.map(w => `
                        <div class="rule-warning">âš ï¸ ${w}</div>
                    `).join('')}
                    
                    ${densityWarnings.length > 0 ? `
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.75rem; background: rgba(255, 152, 0, 0.1);">ìë™ ì”¬ ë¶„í• </button>
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        // ì”¬ ìˆ˜ì • í•¨ìˆ˜
        function editScene(idx) {
            const scene = storyData.scenes[idx];
            const newDesc = prompt('ì”¬ ì„¤ëª…:', scene.scene_description);
            if (newDesc !== null && newDesc.trim()) {
                storyData.scenes[idx].scene_description = newDesc;
                renderScenes(storyData.scenes);
            }
        }

        // ëŒ€ì‚¬ ìˆ˜ì • í•¨ìˆ˜
        function editDialogue(sceneIdx, dialogueIdx) {
            const dialogue = storyData.scenes[sceneIdx].dialogues[dialogueIdx];
            const newText = prompt(`${dialogue.character}ì˜ ëŒ€ì‚¬:`, dialogue.text);
            if (newText !== null && newText.trim()) {
                storyData.scenes[sceneIdx].dialogues[dialogueIdx].text = newText;
                renderScenes(storyData.scenes);
            }
        }

        // ë‚˜ë ˆì´ì…˜ ìˆ˜ì • í•¨ìˆ˜
        function editNarration(sceneIdx) {
            const scene = storyData.scenes[sceneIdx];
            const newNarration = prompt('ë‚˜ë ˆì´ì…˜:', scene.narration || '');
            if (newNarration !== null) {
                storyData.scenes[sceneIdx].narration = newNarration;
                renderScenes(storyData.scenes);
            }
        }

        // ì”¬ ì¬ìƒì„± í•¨ìˆ˜
        async function regenerateScene(idx) {
            if (!confirm(`ì”¬ ${idx + 1}ì„ AIë¡œ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const scene = storyData.scenes[idx];
            alert('ì”¬ ì¬ìƒì„± ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ìˆ˜ì • ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        }

        // ì”¬ ì‚­ì œ í•¨ìˆ˜
        function deleteScene(idx) {
            if (!confirm(`ì”¬ ${idx + 1}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            // ì”¬ ì‚­ì œ
            storyData.scenes.splice(idx, 1);

            // ì”¬ ë²ˆí˜¸ ì¬ì •ë ¬
            storyData.scenes.forEach((scene, index) => {
                scene.scene_number = index + 1;
            });

            renderScenes(storyData.scenes);
        }

        // ì´ˆê¸°í™” ì‹œ ìë™ ë³µì› ë° ê¸°ë³¸ ëª¨ë¸ ì„¤ì •
        window.addEventListener('DOMContentLoaded', async () => {
            // 1. ê¸°ë³¸ ëª¨ë¸ ì„¤ì •
            const modelSelect = document.getElementById('ai-model-select');
            if (modelSelect) {
                const selectedOption = modelSelect.querySelector('option[selected]');
                if (selectedOption) {
                    modelSelect.value = selectedOption.value;
                } else {
                    modelSelect.value = "gemini-3-flash-preview";
                }
            }

            // 2. ìë™ ì„¸ì…˜ ë³µì› (ê°œë°œ íš¨ìœ¨ì„±)
            const savedSessionId = localStorage.getItem('lastSessionId');
            if (savedSessionId) {
                console.log('Found saved session:', savedSessionId);
                try {
                    // ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ ë° ë°ì´í„° ë¡œë“œ
                    const res = await fetch(`/api/workflow/session/${savedSessionId}`);
                    if (res.ok) {
                        const session = await res.json();
                        sessionId = session.session_id;

                        // ë°ì´í„° ë³µì›
                        if (session.story) {
                            storyData = session.story;
                            characters = storyData.characters || [];
                            collectedData = session.collected_data || [];

                            // UI ë Œë”ë§
                            renderCharacters();
                            renderScenes(storyData.scenes || []);

                            // 3ë‹¨ê³„(ìŠ¤í† ë¦¬ í¸ì§‘)ë¡œ ì´ë™
                            // ë§Œì•½ ì´ë¯¸ì§€ê°€ ìƒì„±ëœ ìƒíƒœë¼ë©´ 4ë‹¨ê³„ë‚˜ 5ë‹¨ê³„ë¡œ ê°ˆ ìˆ˜ë„ ìˆê² ì§€ë§Œ, 
                            // ì¼ë‹¨ ì‚¬ìš©ìê°€ ìš”ì²­í•œ "3ë²ˆ íƒ­ë¶€í„° ì‹œì‘"ì„ ìœ„í•´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ 3ë‹¨ê³„ë¡œ ì´ë™

                            document.getElementById('loading-story').style.display = 'none';
                            document.getElementById('story-review-area').style.display = 'block';
                            document.getElementById('story-actions').style.display = 'flex';

                            goToStep(3);

                            // ë§Œì•½ ì´ë¯¸ì§€ ìƒì„± ë‹¨ê³„ê¹Œì§€ ê°”ë˜ ì„¸ì…˜ì´ë¼ë©´?
                            if (session.images && session.images.length > 0) {
                                // ì„ íƒì ìœ¼ë¡œ 5ë‹¨ê³„ ë“±ìœ¼ë¡œ ì´ë™ ê°€ëŠ¥. ì¼ë‹¨ì€ 3ë‹¨ê³„ ìœ ì§€í•˜ê±°ë‚˜ ì•Œë¦¼.
                                console.log('This session has generated images.');
                            }

                            console.log('Session restored functionality enabled.');
                        } else if (session.collected_data && session.collected_data.length > 0) {
                            // ë°ì´í„°ìˆ˜ì§‘ì€ í–ˆì§€ë§Œ ìŠ¤í† ë¦¬ëŠ” ì—†ëŠ” ê²½ìš° -> 2ë‹¨ê³„
                            collectedData = session.collected_data;
                            renderDataItems();
                            goToStep(2);
                        }
                    } else {
                        console.log('Saved session is invalid or expired.');
                        localStorage.removeItem('lastSessionId');
                    }
                } catch (e) {
                    console.error('Auto-restore failed:', e);
                }
            }
        });

        function validateSceneRules(scene) {
            const warnings = [];
            scene.dialogues.forEach(d => {
                if (d.text.length > 50) warnings.push(`${d.character} ëŒ€ì‚¬ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${d.text.length}ì > 50ì)`);
            });
            if (scene.dialogues.length > 3) warnings.push(`ë§í’ì„ ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤ (${scene.dialogues.length}ê°œ > 3ê°œ)`);
            if (scene.narration && scene.narration.length > 60) warnings.push(`ë‚˜ë ˆì´ì…˜ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${scene.narration.length}ì > 60ì)`);
            return warnings;
        }

        function approveScenes() {
            goToStep(4);
            document.getElementById('image-scene-count').innerText = storyData.scenes.length;
            document.getElementById('image-est-time').innerText = Math.ceil(storyData.scenes.length * 0.25);
        }

        // --- Step 4: ì„¤ì • íƒ­ ê´€ë¦¬ ---
        function switchSettingTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

            event.target.classList.add('active');
            document.getElementById(`setting-tab-${tab}`).style.display = 'block';
        }

        // --- Step 5: ì´ë¯¸ì§€ ìƒì„± ---
        var genPollInterval = null;  // í´ë§ interval
        var genIsStopped = false;    // ì¤‘ë‹¨ í”Œë˜ê·¸
        var genIsPaused = false;     // ì¼ì‹œì •ì§€ í”Œë˜ê·¸

        function getImageUrl(localPath) {
            // output/scene_1_xxx.png â†’ /output/scene_1_xxx.png
            if (!localPath) return '';
            if (localPath.startsWith('/')) return localPath;
            if (localPath.startsWith('http')) return localPath;
            return '/' + localPath.replace(/\\/g, '/');
        }

        async function startImageGeneration() {
            goToStep(5);
            genIsStopped = false;
            genIsPaused = false;

            const sceneCount = storyData.scenes.length;
            const statusBar = document.getElementById('gen-status-bar');
            const controlBtns = document.getElementById('gen-control-buttons');
            const actionsEl = document.getElementById('image-actions');
            actionsEl.style.display = 'none';
            statusBar.style.display = 'block';
            controlBtns.style.display = 'flex';

            // ì´ˆê¸° ê·¸ë¦¬ë“œ: ëª¨ë“  ì”¬ì„ "ëŒ€ê¸° ì¤‘" ì¹´ë“œë¡œ í‘œì‹œ
            const container = document.getElementById('images-container');
            container.innerHTML = Array.from({length: sceneCount}, (_, i) => `
                <div class="card" id="scene-card-${i}" style="padding:0.5rem; position:relative; min-height:220px;">
                    <div id="scene-img-area-${i}" style="width:100%; aspect-ratio:9/16; background:var(--bg-input); border-radius:8px; display:flex; align-items:center; justify-content:center; margin-bottom:0.5rem; position:relative; overflow:hidden;">
                        <div id="scene-placeholder-${i}" style="text-align:center;">
                            <div style="font-size:1.5rem; margin-bottom:4px;">â³</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">ëŒ€ê¸° ì¤‘</div>
                        </div>
                    </div>
                    <div style="font-size:0.8rem; font-weight:600;">ì”¬ ${i + 1}</div>
                    <div id="scene-status-${i}" style="font-size:0.7rem; color:var(--text-muted); margin-top:2px;">ëŒ€ê¸° ì¤‘</div>
                </div>
            `).join('');

            // ì§„í–‰ ìƒíƒœ ì´ˆê¸°í™”
            document.getElementById('gen-status-text').innerText = 'ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...';
            document.getElementById('gen-status-count').innerText = `0/${sceneCount}`;
            document.getElementById('gen-progress-bar').style.width = '0%';
            document.getElementById('gen-status-sub').innerText = 'ì²« ë²ˆì§¸ ì”¬ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

            // Style System 2.0 Inputs
            const model = document.getElementById('image-model').value;
            const stylePromptEl = document.getElementById('style-prompt-textarea');
            const stylePrompt = stylePromptEl ? stylePromptEl.value : '';

            let bgStylePrompt = "";
            let bgStyleId = null;
            if (selectedStyles.background && selectedStyles.background.id) {
                const bgId = selectedStyles.background.id;
                if (bgId === 'bg_remove') {
                    bgStylePrompt = "Pure white (#FFFFFF) background only. No background elements, no objects, no scenery, no environment. Show only the character on a completely blank white background.";
                } else if (bgId === 'bg_solid') {
                    bgStylePrompt = `Solid flat single color background (${bgSolidColor}). No background elements, no objects, no patterns, no gradients. Plain flat ${bgSolidColor} color fill only.`;
                }
            }

            const overrides = {
                character_style_prompt: "",
                background_style_prompt: bgStylePrompt,
                style_prompt: stylePrompt,
                additional_instructions: ""
            };

            const ratio = document.getElementById('aspect-ratio').value;

            try {
                // í˜„ì¬ "ìƒì„± ì¤‘" í‘œì‹œ: ì”¬ 1
                updateSceneCard(0, 'generating');

                // fire-and-forget: ë°±ì—”ë“œì— ìƒì„± ìš”ì²­
                fetch('/api/workflow/generate-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        character_style_id: selectedStyles.character ? selectedStyles.character.id : null,
                        background_style_id: bgStyleId,
                        sub_style: "",
                        manual_overrides: overrides,
                        model: model,
                        aspect_ratio: ratio
                    })
                }).catch(e => console.error('ì´ë¯¸ì§€ ìƒì„± ë°±ì—”ë“œ ì˜¤ë¥˜:', e));

                // ì¦‰ì‹œ í´ë§ ì‹œì‘
                checkImageProgress(sceneCount);
            } catch (e) {
                alert('ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ ì˜¤ë¥˜: ' + e.message);
            }
        }

        function updateSceneCard(idx, state, imgData) {
            const placeholder = document.getElementById(`scene-placeholder-${idx}`);
            const imgArea = document.getElementById(`scene-img-area-${idx}`);
            const statusEl = document.getElementById(`scene-status-${idx}`);
            const card = document.getElementById(`scene-card-${idx}`);
            if (!imgArea) return;

            if (state === 'generating') {
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="spinner" style="width:24px;height:24px;border-width:3px;margin-bottom:4px;"></div>
                        <div style="font-size:0.75rem;color:var(--primary);">ìƒì„± ì¤‘...</div>`;
                }
                if (statusEl) statusEl.innerText = 'ğŸ¨ ìƒì„± ì¤‘...';
                if (card) card.style.borderColor = 'var(--primary)';
            } else if (state === 'done' && imgData) {
                const url = getImageUrl(imgData.local_path);
                imgArea.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" id="gen-img-${idx}">`;
                if (statusEl) statusEl.innerHTML = `<span style="color:var(--success);">âœ… ì™„ë£Œ</span>`;
                if (card) {
                    card.style.borderColor = 'var(--success)';
                    // ì¬ìƒì„± ë²„íŠ¼ ì¶”ê°€
                    let btnEl = card.querySelector('.regen-btn');
                    if (!btnEl) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-secondary regen-btn';
                        btn.style.cssText = 'width:100%;padding:4px;font-size:0.75rem;margin-top:0.5rem;';
                        btn.innerText = 'ğŸ”„ ì¬ìƒì„±';
                        btn.onclick = () => regenerateOneImage(idx);
                        card.appendChild(btn);
                    }
                }
            } else if (state === 'error') {
                imgArea.innerHTML = `<div style="text-align:center;"><span style="font-size:2rem;">âš ï¸</span><div style="font-size:0.75rem;color:var(--danger);margin-top:4px;">ìƒì„± ì‹¤íŒ¨</div></div>`;
                if (statusEl) statusEl.innerHTML = `<span style="color:var(--danger);">âŒ ì˜¤ë¥˜</span>`;
                if (card) {
                    card.style.borderColor = 'var(--danger)';
                    let btnEl = card.querySelector('.regen-btn');
                    if (!btnEl) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-primary regen-btn';
                        btn.style.cssText = 'width:100%;padding:4px;font-size:0.75rem;margin-top:0.5rem;';
                        btn.innerText = 'ğŸ”„ ì¬ìƒì„±';
                        btn.onclick = () => regenerateOneImage(idx);
                        card.appendChild(btn);
                    }
                }
            } else if (state === 'stopped') {
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div style="font-size:1.5rem;margin-bottom:4px;">â¹ï¸</div>
                        <div style="font-size:0.75rem;color:var(--text-muted);">ì¤‘ë‹¨ë¨</div>`;
                }
                if (statusEl) statusEl.innerText = 'â¹ï¸ ì¤‘ë‹¨ë¨';
                if (card) card.style.borderColor = 'var(--border)';
            }
        }

        function checkImageProgress(total) {
            let prevCount = 0;
            let pollCount = 0;

            const statusText = document.getElementById('gen-status-text');
            const statusCount = document.getElementById('gen-status-count');
            const progressBar = document.getElementById('gen-progress-bar');
            const statusSub = document.getElementById('gen-status-sub');
            const actionsEl = document.getElementById('image-actions');
            const controlBtns = document.getElementById('gen-control-buttons');

            genPollInterval = setInterval(async () => {
                if (genIsPaused) return; // ì¼ì‹œì •ì§€ë©´ ìŠ¤í‚µ
                if (genIsStopped) {
                    clearInterval(genPollInterval);
                    return;
                }
                pollCount++;
                try {
                    const res = await fetch(`/api/workflow/session/${sessionId}`);
                    const session = await res.json();
                    const allImages = session.images || [];
                    const doneCount = allImages.length;  // ìƒì„±ì™„ë£Œ + ì—ëŸ¬ í•©ì‚°
                    const generated = allImages.filter(img => img.status === 'generated');
                    const errors = allImages.filter(img => img.status === 'error');
                    const genCount = generated.length;

                    // ìƒˆë¡œ ì™„ë£Œëœ ì”¬ ì¹´ë“œ ì—…ë°ì´íŠ¸
                    for (let i = prevCount; i < doneCount; i++) {
                        const imgData = allImages[i];
                        if (imgData.status === 'generated' && imgData.local_path) {
                            updateSceneCard(i, 'done', imgData);
                        } else {
                            updateSceneCard(i, 'error', imgData);
                        }
                    }

                    // ë‹¤ìŒ ìƒì„± ì¤‘ì¸ ì”¬ í‘œì‹œ
                    if (doneCount < total) {
                        updateSceneCard(doneCount, 'generating');
                    }

                    prevCount = doneCount;

                    // ìƒë‹¨ ë°” ì—…ë°ì´íŠ¸
                    const pct = total > 0 ? Math.round((genCount / total) * 100) : 0;
                    progressBar.style.width = `${pct}%`;
                    statusCount.innerText = `${genCount}/${total}`;

                    if (genCount > 0 && genCount < total) {
                        statusText.innerText = `ğŸ¨ ${genCount}/${total} ìƒì„± ì™„ë£Œ`;
                        statusSub.innerText = `ì”¬ ${doneCount + 1} ìƒì„± ì¤‘... (ì”¬ë‹¹ ì•½ 15~30ì´ˆ)`;
                    } else if (genCount === 0) {
                        statusText.innerText = 'ğŸ¨ ì´ë¯¸ì§€ ìƒì„± ì¤‘...';
                        statusSub.innerText = pollCount > 3 ? 'ì”¬ 1 ìƒì„± ì¤‘... (ì²« ì”¬ì€ ì¡°ê¸ˆ ë” ê±¸ë¦½ë‹ˆë‹¤)' : 'ì²« ë²ˆì§¸ ì”¬ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                    }

                    if (errors.length > 0) {
                        statusSub.innerText += ` (âš ï¸ ${errors.length}ê°œ ì˜¤ë¥˜)`;
                    }

                    // ì „ì²´ ì™„ë£Œ
                    if (doneCount >= total) {
                        clearInterval(genPollInterval);
                        genPollInterval = null;
                        statusText.innerText = `âœ… ${genCount}/${total} ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!`;
                        statusSub.innerText = errors.length > 0 ? `âš ï¸ ${errors.length}ê°œ ì”¬ì—ì„œ ì˜¤ë¥˜ ë°œìƒ â€” ê°œë³„ ì¬ìƒì„± ê°€ëŠ¥` : 'ëª¨ë“  ì”¬ì´ ì •ìƒ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤';
                        progressBar.style.width = '100%';
                        controlBtns.style.display = 'none';
                        actionsEl.style.display = 'flex';
                    }
                } catch (e) {
                    console.error('ì§„í–‰ë¥  í™•ì¸ ì˜¤ë¥˜:', e);
                }
            }, 2500);
        }

        function pauseGeneration() {
            genIsPaused = !genIsPaused;
            const btn = document.getElementById('btn-pause');
            if (genIsPaused) {
                btn.innerText = 'â–¶ï¸ ê³„ì†';
                document.getElementById('gen-status-sub').innerText = 'â¸ï¸ ì¼ì‹œì •ì§€ë¨ â€” "ê³„ì†" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰ë¥  í™•ì¸ì„ ì¬ê°œí•˜ì„¸ìš”';
            } else {
                btn.innerText = 'â¸ï¸ ì¼ì‹œì •ì§€';
                document.getElementById('gen-status-sub').innerText = 'ë‹¤ì‹œ ì§„í–‰ë¥ ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...';
            }
        }

        function stopGeneration() {
            if (!confirm('ì´ë¯¸ì§€ ìƒì„±ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ë¯¸ ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.')) return;
            genIsStopped = true;
            if (genPollInterval) {
                clearInterval(genPollInterval);
                genPollInterval = null;
            }

            // ë°±ì—”ë“œì— ì¤‘ë‹¨ ì‹ í˜¸ ë³´ë‚´ê¸°
            fetch('/api/workflow/stop-generation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            }).catch(e => console.error('ì¤‘ë‹¨ ìš”ì²­ ì˜¤ë¥˜:', e));

            // ë‚¨ì€ ë¯¸ì™„ì„± ì¹´ë“œë“¤ì— "ì¤‘ë‹¨ë¨" í‘œì‹œ
            const total = storyData.scenes.length;
            for (let i = 0; i < total; i++) {
                const statusEl = document.getElementById(`scene-status-${i}`);
                if (statusEl && statusEl.innerText.includes('ëŒ€ê¸°') || (statusEl && statusEl.innerText.includes('ìƒì„± ì¤‘'))) {
                    updateSceneCard(i, 'stopped');
                }
            }

            document.getElementById('gen-status-text').innerText = 'â¹ï¸ ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤';
            document.getElementById('gen-status-sub').innerText = 'ì´ë¯¸ ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ì•„ë˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
            document.getElementById('gen-control-buttons').style.display = 'none';
            document.getElementById('image-actions').style.display = 'flex';
        }

        async function regenerateOneImage(sceneIndex) {
            const btn = event.target;
            const origText = btn.innerText;
            btn.innerText = 'â³ ì¬ìƒì„± ì¤‘...';
            btn.disabled = true;

            // ì¹´ë“œë„ ë¡œë”© ìƒíƒœë¡œ ì „í™˜
            updateSceneCard(sceneIndex, 'generating');

            try {
                const model = document.getElementById('image-model') ? document.getElementById('image-model').value : 'gpt-image-1';
                const res = await fetch('/api/workflow/regenerate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, scene_index: sceneIndex, model: model })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status}): ${errText}`);
                }

                const data = await res.json();
                if (data.image && data.image.local_path) {
                    updateSceneCard(sceneIndex, 'done', data.image);
                } else {
                    throw new Error('ì´ë¯¸ì§€ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (e) {
                updateSceneCard(sceneIndex, 'error');
                alert('ì¬ìƒì„± ì‹¤íŒ¨: ' + e.message);
            } finally {
                btn.innerText = origText;
                btn.disabled = false;
            }
        }

        // --- ìº¡ì…˜ ìƒì„± (Step 6 í¸ì§‘ â†’ Step 7 ìº¡ì…˜/ë°œí–‰) ---
        async function generateCaption() {
            // ë¨¼ì € Step 7ìœ¼ë¡œ ì´ë™í•˜ì—¬ ë¡œë”© UI í‘œì‹œ
            goToStep(7);
            const loadingEl = document.getElementById('loading-caption');
            const captionArea = document.getElementById('caption-publish-area');
            loadingEl.style.display = 'block';
            if (captionArea) captionArea.style.display = 'none';

            try {
                const res = await fetch('/api/workflow/generate-caption', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                const data = await res.json();
                const caption = data.caption;

                // Step 7 ì…ë ¥ í•„ë“œ ì„¸íŒ…
                document.getElementById('final-hook').value = caption.hook || '';
                document.getElementById('final-body').value = caption.body || '';
                document.getElementById('final-tip').value = caption.expert_tip || caption.tip || '';
                document.getElementById('final-hashtags').value = (caption.hashtags || []).join(' ');

                loadingEl.style.display = 'none';
                if (captionArea) captionArea.style.display = 'grid';
                updateInstaPreview();
            } catch (e) {
                alert('ìº¡ì…˜ ìƒì„± ì˜¤ë¥˜: ' + e.message);
                loadingEl.style.display = 'none';
                if (captionArea) captionArea.style.display = 'grid';
            }
        }

        function updateInstaPreview() {
            const hook = document.getElementById('final-hook').value;
            const body = document.getElementById('final-body').value;
            const tip = document.getElementById('final-tip').value;
            const hashtags = document.getElementById('final-hashtags').value;

            const fullText = `${hook}\n\n${body}\n\nğŸ’¡ Tip: ${tip}`;
            document.getElementById('insta-preview-caption-text').innerText = fullText;
            document.getElementById('insta-preview-hashtags').innerText = hashtags;

            // ì´ë¯¸ì§€ í”„ë¦¬ì…‹ (ì²« ë²ˆì§¸ ì´ë¯¸ì§€ í‘œì‹œ)
            const firstImg = document.querySelector('#images-container img');
            if (firstImg) {
                document.getElementById('insta-preview-img').src = firstImg.src;
            }

            const totalImages = document.querySelectorAll('#images-container img').length;
            document.getElementById('insta-carousel-index').innerText = `1 / ${totalImages}`;
        }

        async function publishToInstagram() {
            if (!sessionId) { alert('ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const hook = document.getElementById('final-hook').value || '';
            const body = document.getElementById('final-body').value || '';
            const tip = document.getElementById('final-tip').value || '';
            const hashtags = document.getElementById('final-hashtags').value || '';
            const caption = `${hook}\n\n${body}\n\nğŸ’¡ ${tip}`.trim() + (hashtags ? '\n\n' + hashtags.trim() : '');
            try {
                const res = await fetch('/api/workflow/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, caption: caption, images: [] })
                });
                const data = await res.json();
                if (data.success) {
                    alert('ì¸ìŠ¤íƒ€ê·¸ë¨ì— ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë°œí–‰ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ìŒ'));
                }
            } catch (e) {
                alert('ë°œí–‰ ì˜¤ë¥˜: ' + e.message);
            }
        }

        function downloadImages() {
            const imgs = document.querySelectorAll('#images-container img');
            if (!imgs.length) { alert('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            imgs.forEach((img, i) => {
                const a = document.createElement('a');
                a.href = img.src;
                a.download = `scene_${i + 1}.png`;
                a.click();
            });
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            document.querySelectorAll('.step').forEach(s => {
                const sNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'done');
                if (sNum < step) s.classList.add('done');
                if (sNum === step) s.classList.add('active');
            });

            // --- VIEW STATE MANAGEMENT (ì‚¬ìš©ì ê²½í—˜ ê°œì„ ) ---
            // íƒ­ ì´ë™ ì‹œ 'ë¡œë”© ì¤‘' í™”ë©´ì´ ì•„ë‹ˆë¼ 'ê²°ê³¼/ì‘ì—…' í™”ë©´ì„ ìš°ì„  í‘œì‹œí•˜ë„ë¡ ê°•ì œ

            // Step 2: ìë£Œ ìˆ˜ì§‘
            if (step === 2) {
                document.getElementById('loading-data').style.display = 'none';
                document.getElementById('data-review-area').style.display = 'block';
                document.getElementById('data-actions').style.display = 'flex';

                if (collectedData.length === 0) {
                    loadDataFromStorage();
                }
                renderDataItems();
            }

            // Step 3: ìŠ¤í† ë¦¬
            if (step === 3) {
                document.getElementById('loading-story').style.display = 'none';
                document.getElementById('story-review-area').style.display = 'block';
                document.getElementById('story-actions').style.display = 'flex';

                if (storyData && storyData.scenes) {
                    renderCharacters();
                    renderScenes(storyData.scenes);
                }
            }

            // Step 5: ì´ë¯¸ì§€ ìƒì„± ê²°ê³¼
            if (step === 5) {
                // ì´ë¯¸ ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
                const hasImages = document.getElementById('images-container') && document.getElementById('images-container').children.length > 0;
                if (hasImages && !genPollInterval) {
                    document.getElementById('image-actions').style.display = 'flex';
                }
            }

            // Step 6: ë§í’ì„  í¸ì§‘ (ë¹„íŒŒê´´ ë ˆì´ì–´)
            if (step === 6) {
                initBubbleEditor();
            }

            // Step 7: ìº¡ì…˜ + ë°œí–‰
            if (step === 7) {
                updateInstaPreview();
            }
        }

        function navigateToStep(step) {
            // ì‚¬ìš©ì ìš”ì²­: ììœ ë¡œìš´ íƒ­ ì´ë™ í—ˆìš© (ë‹¨, ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŒì„ ê°ì•ˆ)
            goToStep(step);
        }

        // ============================================
        // ============================================
        // Step 6: ë¹„íŒŒê´´ ë§í’ì„  í¸ì§‘ ì‹œìŠ¤í…œ (Non-destructive Bubble Editor)
        // ============================================

        let bubbleLayers = [];       // ì „ì²´ ì”¬ ë§í’ì„  ë°ì´í„°
        let bubbleCurrentScene = 0;  // í˜„ì¬ ë³´ê³  ìˆëŠ” ì”¬ ì¸ë±ìŠ¤ (0-based)
        let bubbleImages = [];       // ì´ë¯¸ì§€ ê²½ë¡œ ë°°ì—´
        let bubbleHistory = {};      // ì”¬ë³„ ë˜ëŒë¦¬ê¸° íˆìŠ¤í† ë¦¬ { sceneIdx: [ snapshot, ... ] }

        // 9-Grid ìœ„ì¹˜ â†’ CSS ì¢Œí‘œ ë§¤í•‘
        const POSITION_CSS = {
            "top-left":      { top: "3%", left: "5%", right: "auto", bottom: "auto" },
            "top-center":    { top: "3%", left: "25%", right: "auto", bottom: "auto" },
            "top-right":     { top: "3%", right: "5%", left: "auto", bottom: "auto" },
            "middle-left":   { top: "35%", left: "5%", right: "auto", bottom: "auto" },
            "middle-center": { top: "35%", left: "25%", right: "auto", bottom: "auto" },
            "middle-right":  { top: "35%", right: "5%", left: "auto", bottom: "auto" },
            "bottom-left":   { bottom: "18%", left: "5%", right: "auto", top: "auto" },
            "bottom-center": { bottom: "3%", left: "10%", right: "10%", top: "auto" },
            "bottom-right":  { bottom: "18%", right: "5%", left: "auto", top: "auto" },
        };

        // ë§í’ì„  ëª¨ì–‘ â†’ CSS ìŠ¤íƒ€ì¼
        const SHAPE_CSS = {
            "round":   { borderRadius: "18px", border: "2px solid" },
            "square":  { borderRadius: "6px", border: "2px solid" },
            "shout":   { borderRadius: "4px", border: "3px solid", fontWeight: "700" },
            "thought": { borderRadius: "50%", border: "2px dashed", fontStyle: "italic" },
        };

        function goToEditStage() { goToStep(6); }

        // â˜… í¸ì§‘ íƒ­ ì§„ì… ì‹œ ì´ˆê¸°í™”
        async function initBubbleEditor() {
            if (!sessionId) return;

            // ì´ë¯¸ì§€ ëª©ë¡ ìˆ˜ì§‘ (step 5ì—ì„œ ìƒì„±ëœ ì´ë¯¸ì§€)
            bubbleImages = [];
            try {
                const res = await fetch(`/api/workflow/session/${sessionId}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.images) {
                        bubbleImages = data.images.map(img => ({
                            scene_number: img.scene_number,
                            path: img.local_path || img.image_url || ''
                        }));
                    }
                }
            } catch(e) {
                // fallback: ì´ë¯¸ ì €ì¥ëœ ì´ë¯¸ì§€ ì‚¬ìš©
                console.warn("ì„¸ì…˜ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ëŒ€ì²´ ë¡œì§ ì‚¬ìš©");
            }

            // ë§í’ì„  ë ˆì´ì–´ ì´ˆê¸°í™” (ì„œë²„ì—ì„œ)
            try {
                const initRes = await fetch(`/api/workflow/bubble-layers/${sessionId}/init`, { method: 'POST' });
                const initData = await initRes.json();
                if (initData.success) {
                    bubbleLayers = initData.layers;
                }
            } catch(e) {
                console.error("ë§í’ì„  ë ˆì´ì–´ ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
            }

            // ì´ë¯¸ ë ˆì´ì–´ê°€ ìˆìœ¼ë©´ ì„œë²„ì—ì„œ ë¡œë“œ
            if (!bubbleLayers.length) {
                try {
                    const getRes = await fetch(`/api/workflow/bubble-layers/${sessionId}`);
                    const getData = await getRes.json();
                    if (getData.layers) bubbleLayers = getData.layers;
                } catch(e) {}
            }

            bubbleCurrentScene = 0;
            renderBubbleEditor();
        }

        // â˜… ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
        function renderBubbleEditor() {
            if (!bubbleLayers.length && !bubbleImages.length) {
                document.getElementById('bubble-scene-indicator').innerText = 'ì´ë¯¸ì§€ ì—†ìŒ';
                return;
            }

            const total = Math.max(bubbleLayers.length, bubbleImages.length);
            const idx = bubbleCurrentScene;

            // ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ
            document.getElementById('bubble-scene-indicator').innerText = `ì”¬ ${idx + 1} / ${total}`;
            document.getElementById('bubble-prev-btn').disabled = idx <= 0;
            document.getElementById('bubble-next-btn').disabled = idx >= total - 1;

            // ì´ë¯¸ì§€ í‘œì‹œ
            const imgEl = document.getElementById('bubble-preview-img');
            const imgData = bubbleImages[idx];
            if (imgData && imgData.path) {
                imgEl.src = imgData.path.startsWith('/') ? imgData.path : '/' + imgData.path;
            } else {
                imgEl.src = '';
            }

            // í˜„ì¬ ë ˆì´ì–´
            const layer = bubbleLayers[idx] || { bubbles: [], show_all: true, font_family: "Nanum Gothic" };

            // ì „ì²´ í‘œì‹œ ì²´í¬ë°•ìŠ¤
            document.getElementById('bubble-show-all').checked = layer.show_all !== false;

            // CSS ì˜¤ë²„ë ˆì´ ë Œë”ë§
            renderCSSOverlay(layer);

            // í¸ì§‘ ì¹´ë“œ ë Œë”ë§
            renderBubbleEditCards(layer);
        }

        // â˜… CSS ì‹¤ì‹œê°„ í”„ë¦¬ë·° â€” ì„œë²„ ì™•ë³µ ì—†ì´ ì¦‰ì‹œ í‘œì‹œ
        function renderCSSOverlay(layer) {
            const container = document.getElementById('bubble-overlay-layer');
            container.innerHTML = '';

            if (!layer.show_all) return;

            const fontFamily = layer.font_family || "Nanum Gothic";

            layer.bubbles.forEach((bubble, i) => {
                if (!bubble.visible || !bubble.text) return;

                const posCSS = POSITION_CSS[bubble.position] || POSITION_CSS["top-center"];
                const shapeCSS = SHAPE_CSS[bubble.shape] || SHAPE_CSS["round"];

                const div = document.createElement('div');
                div.style.cssText = `
                    position: absolute; pointer-events: auto; cursor: pointer;
                    max-width: 55%; padding: 8px 12px;
                    font-family: '${fontFamily}', sans-serif;
                    font-size: ${bubble.font_size || 13}px; line-height: 1.4;
                    background: ${bubble.bg_color || '#FFF'};
                    color: ${bubble.text_color || '#000'};
                    border-color: ${bubble.border_color || '#333'};
                    opacity: ${bubble.opacity || 0.95};
                    z-index: ${10 + i};
                    ${shapeCSS.border || ''};
                    border-radius: ${shapeCSS.borderRadius || '18px'};
                    ${shapeCSS.fontWeight ? 'font-weight:'+shapeCSS.fontWeight+';' : ''}
                    ${shapeCSS.fontStyle ? 'font-style:'+shapeCSS.fontStyle+';' : ''}
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    word-break: keep-all;
                `;

                // ìœ„ì¹˜ ì ìš©
                Object.entries(posCSS).forEach(([k, v]) => { div.style[k] = v; });

                // ë‚˜ë ˆì´ì…˜ ìŠ¤íƒ€ì¼
                if (bubble.type === 'narration') {
                    div.style.cssText += `
                        left: 0; right: 0; bottom: 0; top: auto;
                        max-width: 100%; border-radius: 0;
                        text-align: center; padding: 10px 20px;
                        background: rgba(0,0,0,0.7); color: #fff;
                        font-size: 12px; border: none;
                    `;
                }

                // ìºë¦­í„° ì´ë¦„ + ëŒ€ì‚¬
                if (bubble.type === 'dialogue' && bubble.character) {
                    div.innerHTML = `<div style="font-size:0.7em; font-weight:700; margin-bottom:2px; opacity:0.7;">${bubble.character}</div>${bubble.text}`;
                } else {
                    div.innerText = bubble.text;
                }

                // í´ë¦­ ì‹œ í•´ë‹¹ í¸ì§‘ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
                div.onclick = () => highlightEditCard(i);

                container.appendChild(div);
            });
        }

        // â˜… í¸ì§‘ ì¹´ë“œ ë Œë”ë§ â€” ì¸ë¼ì¸ ëŒ€ì‚¬ í¸ì§‘ + 9-Grid ìœ„ì¹˜ í”¼ì»¤
        function renderBubbleEditCards(layer) {
            const container = document.getElementById('bubble-edit-cards');
            container.innerHTML = '';

            layer.bubbles.forEach((bubble, i) => {
                const card = document.createElement('div');
                card.id = `bubble-card-${i}`;
                card.style.cssText = `
                    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
                    padding: 0.6rem; transition: border-color 0.2s;
                `;

                const isNarr = bubble.type === 'narration';
                const typeLabel = isNarr ? 'ğŸ“– ë‚˜ë ˆì´ì…˜' : `ğŸ’¬ ${bubble.character || 'ëŒ€ì‚¬'}`;
                const typeColor = isNarr ? 'var(--warning)' : (bubble.bg_color || '#fff');

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                        <span style="font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 4px;">
                            <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ${typeColor}; border: 1px solid #666;"></span>
                            ${typeLabel}
                        </span>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="toggleBubbleVisible(${i})" title="${bubble.visible ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ì´ê¸°'}"
                                style="background:none; border:none; cursor:pointer; font-size: 0.9rem; opacity: ${bubble.visible ? 1 : 0.4};">
                                ${bubble.visible ? 'ğŸ‘' : 'ğŸš«'}
                            </button>
                            <button onclick="removeBubble(${i})" title="ì‚­ì œ"
                                style="background:none; border:none; cursor:pointer; font-size: 0.9rem; color: var(--danger);">âœ•</button>
                        </div>
                    </div>

                    <!-- ëŒ€ì‚¬ í…ìŠ¤íŠ¸ í¸ì§‘ -->
                    <textarea onchange="updateBubbleText(${i}, this.value)" oninput="livePreviewText(${i}, this.value)"
                        style="width: 100%; min-height: 40px; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 6px; padding: 6px; resize: vertical; background: var(--bg-input); color: var(--text);"
                    >${bubble.text || ''}</textarea>

                    <!-- 9-Grid ìœ„ì¹˜ í”¼ì»¤ + ëª¨ì–‘ ì„ íƒ -->
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.4rem; align-items: start;">
                        <!-- 9-Grid -->
                        <div style="display: grid; grid-template-columns: repeat(3, 22px); grid-template-rows: repeat(3, 18px); gap: 2px; flex-shrink: 0;">
                            ${['top-left','top-center','top-right','middle-left','middle-center','middle-right','bottom-left','bottom-center','bottom-right'].map(pos => `
                                <div onclick="updateBubblePosition(${i}, '${pos}')"
                                     style="background: ${bubble.position === pos ? 'var(--primary)' : 'var(--bg-input)'}; border: 1px solid var(--border);
                                            border-radius: 3px; cursor: pointer; transition: background 0.15s;"
                                     title="${pos}"></div>
                            `).join('')}
                        </div>

                        <!-- ëª¨ì–‘ ì„ íƒ -->
                        <select onchange="updateBubbleShape(${i}, this.value)" style="font-size: 0.7rem; padding: 2px 4px; flex: 1;">
                            <option value="round" ${bubble.shape==='round'?'selected':''}>ë‘¥ê·¼</option>
                            <option value="square" ${bubble.shape==='square'?'selected':''}>ì‚¬ê°</option>
                            <option value="shout" ${bubble.shape==='shout'?'selected':''}>ê°•ì¡°</option>
                            <option value="thought" ${bubble.shape==='thought'?'selected':''}>ìƒê°</option>
                        </select>

                        <!-- ê¸€ê¼´ í¬ê¸° -->
                        <input type="number" value="${bubble.font_size || 15}" min="8" max="30" step="1"
                               onchange="updateBubbleFontSize(${i}, this.value)"
                               style="width: 45px; font-size: 0.7rem; padding: 2px 4px;" title="ê¸€ê¼´ í¬ê¸°">
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€
        function bubbleNav(dir) {
            const total = Math.max(bubbleLayers.length, bubbleImages.length);
            const next = bubbleCurrentScene + dir;
            if (next >= 0 && next < total) {
                saveBubbleLayerToServer(); // í˜„ì¬ ì”¬ ì €ì¥
                bubbleCurrentScene = next;
                renderBubbleEditor();
            }
        }

        // â”€â”€ í¸ì§‘ í•¨ìˆ˜ë“¤ â”€â”€
        function updateBubbleText(idx, text) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer && layer.bubbles[idx]) {
                saveSnapshot();
                layer.bubbles[idx].text = text;
                renderCSSOverlay(layer);
            }
        }

        function livePreviewText(idx, text) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer && layer.bubbles[idx]) {
                layer.bubbles[idx].text = text;
                renderCSSOverlay(layer);
            }
        }

        function updateBubblePosition(idx, pos) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer && layer.bubbles[idx]) {
                saveSnapshot();
                layer.bubbles[idx].position = pos;
                renderBubbleEditor();
            }
        }

        function updateBubbleShape(idx, shape) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer && layer.bubbles[idx]) {
                layer.bubbles[idx].shape = shape;
                renderCSSOverlay(layer);
            }
        }

        function updateBubbleFontSize(idx, size) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer && layer.bubbles[idx]) {
                layer.bubbles[idx].font_size = parseInt(size) || 15;
                renderCSSOverlay(layer);
            }
        }

        function toggleBubbleVisible(idx) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer && layer.bubbles[idx]) {
                layer.bubbles[idx].visible = !layer.bubbles[idx].visible;
                renderBubbleEditor();
            }
        }

        function removeBubble(idx) {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer) {
                saveSnapshot();
                layer.bubbles.splice(idx, 1);
                renderBubbleEditor();
            }
        }

        function addNewBubble() {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (!layer) return;
            const newId = `s${layer.scene_number}_new_${Date.now()}`;
            layer.bubbles.push({
                id: newId, type: "dialogue", character: "", text: "ìƒˆ ëŒ€ì‚¬",
                position: "top-center", shape: "round",
                bg_color: "#FFFFFF", text_color: "#000000", border_color: "#333333",
                font_size: 15, visible: true, opacity: 0.95
            });
            renderBubbleEditor();
        }

        // â”€â”€ ë˜ëŒë¦¬ê¸° (Undo) â”€â”€
        function saveSnapshot() {
            const idx = bubbleCurrentScene;
            const layer = bubbleLayers[idx];
            if (!layer) return;
            if (!bubbleHistory[idx]) bubbleHistory[idx] = [];
            // ìµœëŒ€ 20ê°œ íˆìŠ¤í† ë¦¬
            if (bubbleHistory[idx].length >= 20) bubbleHistory[idx].shift();
            bubbleHistory[idx].push(JSON.parse(JSON.stringify(layer.bubbles)));
        }

        function undoBubbles() {
            const idx = bubbleCurrentScene;
            if (!bubbleHistory[idx] || bubbleHistory[idx].length === 0) {
                alert('ë˜ëŒë¦´ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const prev = bubbleHistory[idx].pop();
            const layer = bubbleLayers[idx];
            if (layer) {
                layer.bubbles = prev;
                renderBubbleEditor();
            }
        }

        function resetBubbles() {
            if (!confirm('ì´ ì”¬ì˜ ë§í’ì„ ì„ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦´ê¹Œìš”?')) return;
            // ì„œë²„ì—ì„œ ë‹¤ì‹œ ì´ˆê¸°í™”
            initBubbleEditor();
        }

        function toggleShowAll() {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer) {
                layer.show_all = document.getElementById('bubble-show-all').checked;
                renderCSSOverlay(layer);
            }
        }

        function applyGlobalShape() {
            const shape = document.getElementById('bubble-global-shape').value;
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer) {
                layer.bubbles.forEach(b => { if (b.type === 'dialogue') b.shape = shape; });
                renderBubbleEditor();
            }
        }

        function onGlobalSettingChange() {
            const font = document.getElementById('bubble-font-family').value;
            const layer = bubbleLayers[bubbleCurrentScene];
            if (layer) {
                layer.font_family = font;
                renderCSSOverlay(layer);
            }
        }

        function highlightEditCard(idx) {
            document.querySelectorAll('[id^="bubble-card-"]').forEach(el => {
                el.style.borderColor = 'var(--border)';
            });
            const card = document.getElementById(`bubble-card-${idx}`);
            if (card) {
                card.style.borderColor = 'var(--primary)';
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // â”€â”€ ì„œë²„ ì €ì¥ â”€â”€
        async function saveBubbleLayerToServer() {
            const layer = bubbleLayers[bubbleCurrentScene];
            if (!layer || !sessionId) return;
            try {
                await fetch(`/api/workflow/bubble-layers/${sessionId}/${layer.scene_number}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bubbles: layer.bubbles,
                        show_all: layer.show_all,
                        font_family: layer.font_family
                    })
                });
            } catch(e) { console.warn("ë§í’ì„  ì €ì¥ ì‹¤íŒ¨:", e); }
        }

        // â”€â”€ ìµœì¢… ë‚´ë³´ë‚´ê¸° â”€â”€
        async function exportWithBubbles() {
            if (!sessionId) return alert('ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
            // í˜„ì¬ ì”¬ ë¨¼ì € ì €ì¥
            await saveBubbleLayerToServer();
            // ëª¨ë“  ì”¬ ì €ì¥
            for (let i = 0; i < bubbleLayers.length; i++) {
                const layer = bubbleLayers[i];
                try {
                    await fetch(`/api/workflow/bubble-layers/${sessionId}/${layer.scene_number}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bubbles: layer.bubbles, show_all: layer.show_all, font_family: layer.font_family })
                    });
                } catch(e) {}
            }

            const btn = document.getElementById('bubble-export-btn');
            btn.disabled = true; btn.innerText = 'â³ ë‚´ë³´ë‚´ê¸° ì¤‘...';

            try {
                const res = await fetch(`/api/workflow/bubble-layers/${sessionId}/export`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    btn.innerText = `âœ… ${data.exported_count}ì¥ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!`;
                    setTimeout(() => { btn.disabled = false; btn.innerText = 'ğŸ“¥ ìµœì¢… ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°'; }, 3000);
                } else {
                    throw new Error(data.detail || 'ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
                }
            } catch(e) {
                alert('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + e.message);
                btn.disabled = false; btn.innerText = 'ğŸ“¥ ìµœì¢… ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°';
            }
        }

        // â”€â”€ í†¤ ì¡°ì ˆ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) â”€â”€
        async function quickTone(effect, value) {
            try {
                const res = await fetch(`/api/edit-stage/${sessionId}/tone-apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ effects: [{ effect, value }], scene_numbers: null })
                });
                const data = await res.json();
                if (data.success) renderBubbleEditor();
            } catch (e) { alert('í†¤ ì¡°ì ˆ ì‹¤íŒ¨: ' + e.message); }
        }

        async function proceedFromEditStage() {
            await saveBubbleLayerToServer();
            generateCaption();
        }
    </script>
    <!-- Story History Modal -->
    <div id="history-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content"
            style="background: #1e1e1e; color: #ffffff; padding: 20px; border-radius: 8px; width: 500px; max-width: 90%; border: 1px solid #444;">
            <h3 style="margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">ì´ì „ ìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (ìµœê·¼ 5ê°œ)</h3>
            <div id="history-list" style="margin: 15px 0; max-height: 300px; overflow-y: auto;">
                Loading...
            </div>
            <div style="text-align: right;">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('history-modal').style.display='none'">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        async function openStoryHistoryModal() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            modal.style.display = 'flex';
            list.innerHTML = '<div>Loading...</div>';

            try {
                const res = await fetch('/api/workflow/history/stories');
                const files = await res.json();

                if (files.length === 0) {
                    list.innerHTML = '<div style="color: #aaa;">ì €ì¥ëœ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                list.innerHTML = files.map(f => `
                <div style="background: #2d2d2d; border: 1px solid #444; padding: 10px; margin-bottom: 5px; cursor: pointer; border-radius: 4px; color: #eee;" 
                     onclick="loadStory('${f.filename}')" 
                     onmouseover="this.style.background='#3d3d3d'" 
                     onmouseout="this.style.background='#2d2d2d'">
                    <div style="font-weight: bold;">${f.keyword}</div>
                    <div style="font-size: 0.8em; color: #666;">
                        ${new Date(f.timestamp).toLocaleString()} | ${f.title} (${f.scene_count} scenes)
                    </div>
                </div>
            `).join('');
            } catch (e) {
                list.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
            }
        }

        async function loadStory(filename) {
            if (!confirm('í˜„ì¬ ì‘ì—… ë‚´ìš©ì„ ë®ì–´ì“°ê³  ìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const res = await fetch('/api/workflow/history/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, filename: filename })
                });
                const data = await res.json();

                if (data.session_id) {
                    sessionId = data.session_id;
                    localStorage.setItem('lastSessionId', sessionId); // ì„¸ì…˜ ID ì €ì¥
                }

                if (data.success) {
                    storyData = data.story;
                    collectedData = data.collected_data || [];
                    characters = storyData.characters || [];

                    // Update UI
                    document.getElementById('history-modal').style.display = 'none';

                    renderCharacters();
                    renderScenes(storyData.scenes);

                    // Show Step 3 areas
                    document.getElementById('loading-story').style.display = 'none';
                    document.getElementById('story-review-area').style.display = 'block';
                    document.getElementById('story-actions').style.display = 'flex';

                    // Go to step 3 if not already
                    goToStep(3);

                    alert('ìŠ¤í† ë¦¬ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                alert('Failed to load: ' + e.message);
            }
        }

        // --- Style System 2.0 Logic ---

        // Variables moved to top of script

        // Variables moved to top of script

        function openCustomStyleUploadModal() {
            // Default to 'character', or we could ask the user? 
            // Since the user is likely looking for the style manager, checking character tab first is safe.
            // Or use currentStyleType if set.
            openStyleManager(currentStyleType || 'character');
        }

        function openStyleManager(type) {
            currentStyleType = type;
            document.getElementById('style-manager-modal').style.display = 'flex';
            document.getElementById('style-modal-title').innerText = type === 'character' ? 'ì¸ë¬¼ ìŠ¤íƒ€ì¼ ê´€ë¦¬' : 'ë°°ê²½ ìŠ¤íƒ€ì¼ ê´€ë¦¬';

            // Reset Form View
            document.getElementById('style-detail-view').style.display = 'none';
            document.getElementById('style-form-view').style.display = 'none';

            loadStyles(type);
        }

        function closeStyleManager() {
            document.getElementById('style-manager-modal').style.display = 'none';
            loadCustomStyles(); // Refresh main grid
        }

        async function loadStyles(type) {
            const listEl = document.getElementById('style-list');
            listEl.innerHTML = '<div style="padding:1rem;">Loading...</div>';

            try {
                const res = await fetch(`/api/styles/${type}`);
                stylesData[type] = await res.json();
                console.log('Loaded styles:', stylesData[type]); // Debugging
                // Filter out default styles for the manager list
                const customOnly = stylesData[type].filter(s => s.is_default !== true);
                renderStyleList(customOnly);
            } catch (e) {
                listEl.innerHTML = `<div style="color:red; padding:1rem;">Error: ${e.message}</div>`;
            }
        }

        function renderStyleList(styles) {
            const listEl = document.getElementById('style-list');
            if (styles.length === 0) {
                listEl.innerHTML = '<div style="padding:1rem; color:var(--text-muted);">ì €ì¥ëœ ìŠ¤íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            listEl.innerHTML = styles.map(s => {
                let badge = s.is_default
                    ? '<span style="font-size:0.7rem; background:#444; color:#fff; padding:2px 6px; border-radius:4px; margin-left:6px;">ğŸ”’ê¸°ë³¸</span>'
                    : '<span style="font-size:0.7rem; background:var(--primary); color:#fff; padding:2px 6px; border-radius:4px; margin-left:6px;">ğŸ‘¤ì»¤ìŠ¤í…€</span>';

                // For preset 'none', maybe no badge or special
                if (s.id === 'none') badge = '<span class="style-badge preset">ğŸš« ì—†ìŒ</span>';

                // Assuming 'previewHtml' is defined elsewhere or not needed here,
                // and 'style' refers to 's' in this map function.
                // The original code already had a badge and similar structure.
                // I'm integrating the new badge logic and content structure.

                // If there's a preview_image or reference_images, create a preview.
                let previewHtml = '';
                if (s.preview_image) {
                    previewHtml = `<img src="${s.preview_image}" style="width:100%; height:100px; object-fit:cover; border-radius:4px; margin-bottom:0.5rem;">`;
                } else if (s.reference_images && s.reference_images.length > 0) {
                    previewHtml = `<img src="${s.reference_images[0]}" style="width:100%; height:100px; object-fit:cover; border-radius:4px; margin-bottom:0.5rem;">`;
                }


                return `
                <div class="style-item-dark" onclick="viewStyleDetail('${s.id}')" style="padding: 1rem; cursor: pointer;">
                    ${previewHtml}
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 0.2rem;">${s.name}</div>
                    ${badge}
                    <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 4px;">
                        ${s.description || s.prompt_block || ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function viewStyleDetail(id) {
            const style = stylesData[currentStyleType].find(s => s.id === id);
            if (!style) return;

            window.activeStyleDetail = style;

            document.getElementById('style-form-view').style.display = 'none';
            document.getElementById('style-detail-view').style.display = 'block';

            document.getElementById('detail-name').innerText = style.name;
            document.getElementById('detail-prompt').innerText = style.prompt_block;

            const previewEl = document.getElementById('detail-preview');

            // ìš°ì„ ìˆœìœ„: 1. preview_image (ìƒì„±ëœ ëŒ€í‘œ ì´ë¯¸ì§€) 2. reference_images (ì‚¬ìš©ì ì—…ë¡œë“œ)
            if (style.preview_image) {
                previewEl.innerHTML = `<img src="${style.preview_image}" style="max-width:100%; max-height:100%; border-radius:4px;">`;
            } else if (style.reference_images && style.reference_images.length > 0) {
                previewEl.innerHTML = `<img src="${style.reference_images[0]}" style="max-width:100%; max-height:100%; border-radius:4px;">`;
            } else {
                previewEl.innerHTML = 'No Image';
            }

            // ë²„íŠ¼ ì˜ì—­ ë Œë”ë§ (Added here)
            const btnContainer = document.getElementById('style-btn-container');
            if (style.is_default) {
                btnContainer.innerHTML = `<div style="text-align:center; padding:10px; color:#888; font-size:0.9rem;">ğŸ”’ ê¸°ë³¸ ìŠ¤íƒ€ì¼ì€ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                btnContainer.innerHTML = `
                    <div style="display:flex; gap:10px; margin-top:1rem;">
                        <button class="btn btn-secondary" style="flex:1;" onclick="editStyle('${style.id}')">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-danger" style="flex:1;" onclick="deleteStyle('${style.type}', '${style.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                `;
            }
        }

        function selectCurrentStyle() {
            if (!window.activeStyleDetail) return;
            selectedStyles[currentStyleType] = window.activeStyleDetail;

            // Update UI card
            const uiId = currentStyleType === 'character' ? 'selected-char-style' : 'selected-bg-style';
            document.getElementById(uiId).innerHTML = `
                <div style="font-weight:bold; color: #333;">${window.activeStyleDetail.name}</div>
            `;

            // Pre-fill manual prompt
            if (currentStyleType === 'character') {
                document.getElementById('manual-char-prompt').value = window.activeStyleDetail.prompt_block;
            } else {
                document.getElementById('manual-bg-prompt').value = window.activeStyleDetail.prompt_block;
            }

            closeStyleManager();
        }

        // --- Creation Form ---
        function showCreateStyleForm() {
            document.getElementById('style-detail-view').style.display = 'none';
            document.getElementById('style-form-view').style.display = 'block';

            // Initialize form (Reset)
            document.getElementById('style-form-id').value = ''; // New
            document.getElementById('style-form-title').innerText = 'ìƒˆ ìŠ¤íƒ€ì¼ ì¶”ê°€';
            document.getElementById('style-form-name').value = '';
            document.getElementById('style-form-prompt').value = '';
            document.getElementById('style-form-image').value = '';
            document.getElementById('style-form-locked-attrs').value = '[]';
            document.getElementById('style-form-visual-attrs').value = '{}';

            const helpText = document.getElementById('style-form-image-help');
            if (helpText) helpText.innerText = '';
        }

        function editStyle(id) {
            const style = stylesData[currentStyleType].find(s => s.id === id);
            if (!style) return;

            document.getElementById('style-detail-view').style.display = 'none';
            document.getElementById('style-form-view').style.display = 'block';

            // Pre-fill form
            document.getElementById('style-form-title').innerText = 'ìŠ¤íƒ€ì¼ ìˆ˜ì •';
            document.getElementById('style-form-id').value = style.id;
            document.getElementById('style-form-name').value = style.name;
            document.getElementById('style-form-prompt').value = style.prompt_block;
            document.getElementById('style-form-locked-attrs').value = JSON.stringify(style.locked_attributes || []);
            document.getElementById('style-form-visual-attrs').value = JSON.stringify(style.visual_attributes || {});

            // Show existing image count
            const imgCount = style.reference_images ? style.reference_images.length : 0;
            const helpText = document.getElementById('style-form-image-help');
            if (helpText) {
                helpText.innerText = `í˜„ì¬ ${imgCount}ì¥ì˜ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€í•˜ë ¤ë©´ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.`;
            }
        }

        async function deleteStyle(type, id) {
            if (!confirm('ì •ë§ ì´ ìŠ¤íƒ€ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const res = await fetch(`/api/styles/${type}/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadStyles(currentStyleType);
                    document.getElementById('style-detail-view').style.display = 'none';
                    window.activeStyleDetail = null;

                    // ì„ íƒëœ ìŠ¤íƒ€ì¼ì´ ì‚­ì œëœ ê²½ìš° UI ì´ˆê¸°í™”
                    if (selectedStyles[currentStyleType] && selectedStyles[currentStyleType].id === id) {
                        selectedStyles[currentStyleType] = null;
                        const uiId = currentStyleType === 'character' ? 'selected-char-style' : 'selected-bg-style';
                        document.getElementById(uiId).innerHTML = `<div style="color:var(--text-muted);">ì„ íƒ ì•ˆ ë¨</div>`;
                    }
                } else {
                    alert(data.detail || 'ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function cancelCreateStyle() {
            document.getElementById('style-form-view').style.display = 'none';
        }

        async function extractStyleFromImage() {
            const fileInput = document.getElementById('extract-upload');
            if (!fileInput.files[0]) {
                alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            document.getElementById('extract-loading').style.display = 'inline';

            try {
                const res = await fetch('/api/styles/extract', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success && data.result) {
                    const result = data.result;
                    // Auto-fill based on current type
                    if (currentStyleType === 'character' && result.character_style) {
                        document.getElementById('style-form-prompt').value = result.character_style.prompt_block;
                        document.getElementById('style-form-locked-attrs').value = JSON.stringify(result.character_style.locked_attributes || []);
                        document.getElementById('style-form-visual-attrs').value = JSON.stringify(result.character_style.visual_attributes || {});

                        if (!document.getElementById('style-form-name').value) {
                            document.getElementById('style-form-name').value = "Extracted Character Style";
                        }
                    } else if (currentStyleType === 'background' && result.background_style) {
                        document.getElementById('style-form-prompt').value = result.background_style.prompt_block;
                        document.getElementById('style-form-locked-attrs').value = JSON.stringify(result.background_style.locked_attributes || []);
                        document.getElementById('style-form-visual-attrs').value = JSON.stringify(result.background_style.visual_attributes || {});

                        if (!document.getElementById('style-form-name').value) {
                            document.getElementById('style-form-name').value = "Extracted Background Style";
                        }
                    }
                }
            } catch (e) {
                alert('Extraction failed: ' + e.message);
            } finally {
                document.getElementById('extract-loading').style.display = 'none';
            }
        }

        async function submitStyleForm() {
            const id = document.getElementById('style-form-id').value; // New
            const name = document.getElementById('style-form-name').value;
            const prompt = document.getElementById('style-form-prompt').value;
            const locked = document.getElementById('style-form-locked-attrs').value;
            const visual = document.getElementById('style-form-visual-attrs').value;
            const imageInput = document.getElementById('style-form-image');

            if (!name || !prompt) {
                alert('ì´ë¦„ê³¼ í”„ë¡¬í”„íŠ¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            const formData = new FormData();
            if (id) formData.append('id', id); // ìˆ˜ì • ì‹œ ID ì „ì†¡
            formData.append('name', name);
            formData.append('type', currentStyleType);
            formData.append('prompt_block', prompt);
            formData.append('locked_attributes', locked);
            formData.append('visual_attributes', visual);

            if (imageInput.files.length > 0) {
                for (let i = 0; i < imageInput.files.length; i++) {
                    formData.append('reference_images', imageInput.files[i]);
                }
            }

            try {
                const res = await fetch('/api/styles/save', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadStyles(currentStyleType);
                    document.getElementById('style-form-view').style.display = 'none';
                    // ìƒì„¸ ë·°ë¡œ ëŒì•„ê°€ê±°ë‚˜ ë‹«ê¸°
                    if (id) {
                        viewStyleDetail(id); // ìˆ˜ì •ëœ ë‚´ìš© ë°”ë¡œ í™•ì¸
                    }
                } else {
                    alert('Save failed: ' + (data.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Save failed: ' + e.message);
            }
        }

        // --- Preview & Generation ---

        async function generatePreview() {
            const btnManual = document.getElementById('btn-manual-apply');
            const manualResultContainer = document.getElementById('manual-preview-result');

            // Progress Timer Logic
            let seconds = 0;
            if (btnManual) { btnManual.disabled = true; btnManual.innerText = 'ìƒì„± ì¤‘...'; }

            if (manualResultContainer) {
                manualResultContainer.style.display = 'flex';
                manualResultContainer.style.minHeight = '300px'; // Ensure enough space
            }

            // Initial loading state in preview container
            const updateLoadingState = (sec) => {
                const html = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); padding: 1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem; animation: pulse 1.5s infinite;">ğŸ¨</div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">AIê°€ ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ìˆì–´ìš”</div>
                        <div style="font-family: monospace; font-size: 1.4rem; color: var(--primary);">${sec.toFixed(1)}s</div>
                    </div>
                `;
                if (manualResultContainer) manualResultContainer.innerHTML = html;
            };

            updateLoadingState(0);

            const timerInterval = setInterval(() => {
                seconds += 0.1;
                updateLoadingState(seconds);
            }, 100);

            // 60ì´ˆ ë„˜ì–´ê°€ë©´ ì•ˆë‚´ ë¬¸êµ¬
            let longWaitShown = false;
            const longWaitInterval = setInterval(() => {
                if (seconds >= 60 && !longWaitShown && manualResultContainer) {
                    longWaitShown = true;
                    const wrap = manualResultContainer.querySelector('div');
                    if (wrap) {
                        const hint = document.createElement('div');
                        hint.style.cssText = 'margin-top:0.75rem; font-size:0.85rem; color:var(--warning);';
                        hint.textContent = 'ìš”ì²­ì´ ì˜¤ë˜ ê±¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. API/ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ë³´ì„¸ìš”. 120ì´ˆ ì´ˆê³¼ ì‹œ ìë™ìœ¼ë¡œ ì¤‘ë‹¨ë©ë‹ˆë‹¤.';
                        wrap.appendChild(hint);
                    }
                }
            }, 1000);

            // Cleanup helper
            const stopTimer = () => {
                clearInterval(timerInterval);
                clearInterval(longWaitInterval);
                if (btnManual) { btnManual.disabled = false; btnManual.innerText = 'ì ìš©í•˜ì—¬ ë‹¤ì‹œ ë¯¸ë¦¬ë³´ê¸°'; }
            };

            // Build overrides (Style System 2.0)
            const stylePromptEl = document.getElementById('style-prompt-textarea');
            const stylePrompt = stylePromptEl ? stylePromptEl.value : '';

            const additionalEl = document.getElementById('manual-additional');
            const additionalPrompt = additionalEl ? additionalEl.value : '';

            // ë°°ê²½ ìŠ¤íƒ€ì¼ â†’ background_style_prompt ë¡œ ì²˜ë¦¬ (í”„ë¦¬ë·°)
            let previewBgPrompt = "";
            let previewBgId = null;
            if (selectedStyles.background && selectedStyles.background.id) {
                const bgId = selectedStyles.background.id;
                if (bgId === 'bg_remove') {
                    previewBgPrompt = "Pure white (#FFFFFF) background only. No background elements, no objects, no scenery, no environment. Show only the character on a completely blank white background.";
                } else if (bgId === 'bg_solid') {
                    previewBgPrompt = `Solid flat single color background (${bgSolidColor}). No background elements, no objects, no patterns, no gradients. Plain flat ${bgSolidColor} color fill only.`;
                }
            }

            const overrides = {
                character_style_prompt: "",
                background_style_prompt: previewBgPrompt,
                style_prompt: stylePrompt,
                additional_instructions: additionalPrompt
            };

            // Auto-create session if missing (for Preview-only usage)
            if (!sessionId) {
                try {
                    console.log("No session found, creating temporary session for preview...");
                    const startRes = await fetch('/api/workflow/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'manual', keyword: 'Preview Session' })
                    });
                    const startData = await startRes.json();
                    if (startData.session_id) {
                        sessionId = startData.session_id;
                        localStorage.setItem('lastSessionId', sessionId); // Save for persistency
                        console.log("Temporary session created:", sessionId);
                    } else {
                        throw new Error("Failed to create temporary session");
                    }
                } catch (e) {
                    alert('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ìë™ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìœ„í•´ ì„¸ì…˜ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ' + e.message);
                    btn.innerText = 'ìƒ˜í”Œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±';
                    btn.disabled = false;
                    previewContainer.innerHTML = '<div style="color:red; padding:1rem;">Session Error</div>';
                    return;
                }
            }

            try {
                // 130ì´ˆ íƒ€ì„ì•„ì›ƒ (ë°±ì—”ë“œ 120ì´ˆë³´ë‹¤ ì•½ê°„ ê¸¸ê²Œ)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 130000);
                const res = await fetch('/api/workflow/generate-preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        character_style_id: selectedStyles.character ? selectedStyles.character.id : null,
                        background_style_id: previewBgId,
                        sub_style: "",
                        manual_overrides: overrides,
                        model: document.getElementById('image-model').value
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (res.status === 404) {
                    console.warn("Session expired or not found (404). Creating new session and retrying...");
                    sessionId = null;
                    localStorage.removeItem('lastSessionId');
                    // Retry once
                    if (!window.isRetryingPreview) {
                        window.isRetryingPreview = true;
                        await generatePreview();
                        window.isRetryingPreview = false;
                        return;
                    } else {
                        throw new Error("Session creation failed even after retry.");
                    }
                }

                if (res.status === 200) {
                    const data = await res.json();
                    stopTimer();

                    if (data.success) {
                        let imgSrc = '';
                        if (data.image_b64) {
                            // MIME ìë™ ê°ì§€ (WebP/JPEG/PNG)
                            let mime = 'image/png';
                            if (data.image_b64.startsWith('UklGR')) mime = 'image/webp';
                            else if (data.image_b64.startsWith('/9j/')) mime = 'image/jpeg';
                            imgSrc = `data:${mime};base64,${data.image_b64}`;
                        } else if (data.image_url) {
                            imgSrc = data.image_url;
                        }
                        const imgHtml = `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:contain; border-radius:8px;">`;
                        if (manualResultContainer) manualResultContainer.innerHTML = imgHtml;
                        console.log("Preview generated with prompt:", data.prompt_used);
                    } else {
                        const errHtml = '<div style="color:red; padding:1rem;">ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                        alert('Preview generation failed: ' + (data.error || 'Unknown error'));
                        if (manualResultContainer) manualResultContainer.innerHTML = errHtml;
                    }
                } else if (res.status === 504) {
                    stopTimer();
                    const err = await res.json().catch(() => ({}));
                    const errMsg = err.detail || 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    alert('ë¯¸ë¦¬ë³´ê¸° ì‹œê°„ ì´ˆê³¼: ' + errMsg);
                    if (manualResultContainer) manualResultContainer.innerHTML = `<div style="color:var(--warning); padding:1rem; font-size:0.85rem;">${errMsg}</div>`;
                } else {
                    stopTimer();
                    const err = await res.json().catch(() => ({}));
                    const errMsg = (typeof err.detail === 'object' ? JSON.stringify(err.detail) : (err.detail || 'Unknown error'));
                    alert('Preview error: ' + errMsg);
                    if (manualResultContainer) manualResultContainer.innerHTML = `<div style="color:red; padding:1rem; font-size:0.8rem;">${errMsg}</div>`;
                }
            } catch (e) {
                stopTimer();
                console.error(e);
                let msg = e.message || String(e);
                if (e.name === 'AbortError' || msg.includes('abort')) {
                    msg = "ìš”ì²­ì´ 130ì´ˆ ì•ˆì— ì™„ë£Œë˜ì§€ ì•Šì•„ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. APIê°€ ëŠë¦¬ê±°ë‚˜ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                } else if (msg.includes('Failed to fetch')) {
                    msg = "ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                }
                alert('ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ' + msg);
                if (manualResultContainer) manualResultContainer.innerHTML = '<div style="color:red; padding:1rem;">' + msg + '</div>';
            }
        }

        function applyManualOverrides() {
            generatePreview();
        }

        // ============================================
        // í•™ìŠµ ìºë¦­í„° (LoRA Training) ê´€ë ¨ í•¨ìˆ˜
        // ============================================
        let trainedCharacters = [];
        let selectedTrainedChar = null;

        async function loadTrainedCharacters() {
            try {
                const resp = await fetch('/api/training/characters');
                const data = await resp.json();
                trainedCharacters = data.characters || [];
                renderTrainedCharGrid();
            } catch (e) {
                console.error('í•™ìŠµ ìºë¦­í„° ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        function renderTrainedCharGrid() {
            const grid = document.getElementById('trained-char-grid');
            if (!grid) return;

            if (trainedCharacters.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem; grid-column: 1/-1;">
                        í•™ìŠµëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                        <span style="font-size: 0.85rem;">ìœ„ ë²„íŠ¼ìœ¼ë¡œ ìºë¦­í„°ë¥¼ í•™ìŠµí•´ë³´ì„¸ìš”.</span>
                    </div>`;
                return;
            }

            grid.innerHTML = trainedCharacters.map(c => {
                const isSelected = selectedTrainedChar === c.id;
                const statusClass = c.status || 'pending';
                const imgCount = c.training_count || 0;
                const statusText = {
                    'completed': 'í•™ìŠµì™„ë£Œ',
                    'training': 'í•™ìŠµì¤‘...',
                    'pending': 'ëŒ€ê¸°ì¤‘',
                    'uploading': 'ì—…ë¡œë“œì¤‘',
                    'failed': 'ì‹¤íŒ¨'
                }[statusClass] || statusClass;

                const previewImg = c.preview_image
                    ? `<img src="/${c.preview_image}" style="width:100%; height:80px; object-fit:cover; border-radius:6px; margin-bottom:8px;" onerror="this.parentElement.querySelector('.no-thumb-fallback').style.display='flex'; this.style.display='none'">
                       <div class="no-thumb-fallback" style="display:none; width:100%;height:80px;align-items:center;justify-content:center;background:var(--bg-input);border-radius:6px;margin-bottom:8px;font-size:2rem;">ğŸ“</div>`
                    : `<div style="width:100%;height:80px;display:flex;align-items:center;justify-content:center;background:var(--bg-input);border-radius:6px;margin-bottom:8px;font-size:2rem;">ğŸ“</div>`;

                // â”€â”€ ìƒíƒœë³„ ë²„íŠ¼ êµ¬ì„± â”€â”€
                let actionButtons = '';

                if (statusClass === 'pending' || statusClass === 'failed') {
                    // ëŒ€ê¸°/ì‹¤íŒ¨: ì´ë¯¸ì§€ ì—…ë¡œë“œ + ì´ë¯¸ì§€ ë³´ê¸° + í•™ìŠµ ì‹œì‘
                    actionButtons = `
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); uploadTrainingImages('${c.id}')" style="flex:1; font-size:0.7rem;">ğŸ“ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                        ${imgCount > 0 ? `<button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewTrainingImages('${c.id}')" style="font-size:0.7rem;">ğŸ‘ ë³´ê¸°</button>` : ''}
                    `;
                    // 5ì¥ ì´ìƒì´ë©´ í•™ìŠµ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                    if (imgCount >= 5) {
                        actionButtons += `
                        <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); startTraining('${c.id}')" style="flex:1; font-size:0.7rem; border-color:#10b981; color:#10b981;">ğŸš€ í•™ìŠµ ì‹œì‘</button>`;
                    }
                } else if (statusClass === 'training' || statusClass === 'uploading') {
                    // í•™ìŠµì¤‘: ìƒíƒœë§Œ í‘œì‹œ
                    actionButtons = `
                        <button class="btn btn-sm btn-outline" disabled style="flex:1; font-size:0.7rem; opacity:0.6;">â³ í•™ìŠµ ì§„í–‰ ì¤‘...</button>`;
                } else if (statusClass === 'completed') {
                    // ì™„ë£Œ: ì¶”ê°€í•™ìŠµ + ì´ë¯¸ì§€ ë³´ê¸°
                    actionButtons = `
                        <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); addMoreTrainingImages('${c.id}')" style="flex:1; font-size:0.7rem;">+ ì¶”ê°€í•™ìŠµ</button>
                        <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); viewTrainingImages('${c.id}')" style="font-size:0.7rem;">ğŸ‘ ë³´ê¸°</button>`;
                }

                return `
                    <div class="trained-char-card ${isSelected ? 'selected' : ''}" onclick="selectTrainedChar('${c.id}')">
                        ${previewImg}
                        <div style="font-weight:700; font-size:0.9rem; margin-bottom:4px;">
                            ${c.name}
                            <span class="trained-badge">í•™ìŠµìºë¦­í„°</span>
                        </div>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:4px;">
                            íŠ¸ë¦¬ê±°: <code>${c.trigger_word || '-'}</code>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                            <span class="training-status-badge ${statusClass}">${statusText}</span>
                            <span style="font-size:0.7rem; color:var(--text-muted);">${imgCount}ì¥ ${imgCount < 5 ? '<span style="color:#ef4444;">(ìµœì†Œ 5ì¥)</span>' : ''}</span>
                        </div>
                        ${statusClass === 'training' ? `
                            <div class="training-progress-bar">
                                <div class="training-progress-bar-fill" style="width: 50%;"></div>
                            </div>` : ''}
                        <div style="display:flex; gap:4px; margin-top:8px; width:100%; flex-wrap:wrap;">
                            ${actionButtons}
                            <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); deleteTrainedChar('${c.id}')" style="font-size:0.7rem; color:var(--danger); border-color:var(--danger);">ì‚­ì œ</button>
                        </div>
                    </div>`;
            }).join('');
        }

        function selectTrainedChar(charId) {
            const char = trainedCharacters.find(c => c.id === charId);
            if (!char || char.status !== 'completed') {
                alert('í•™ìŠµì´ ì™„ë£Œëœ ìºë¦­í„°ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            selectedTrainedChar = charId;

            // Flux LoRA ëª¨ë¸ ìë™ ì„ íƒ
            const modelSelect = document.getElementById('image-model');
            if (modelSelect) modelSelect.value = 'flux-lora';

            renderTrainedCharGrid();

            // ì„ íƒ ë¼ë²¨ ì—…ë°ì´íŠ¸
            const label = document.getElementById('selected-style-label');
            if (label) {
                label.style.display = 'block';
                label.innerHTML = `ì„ íƒ: ğŸ“ <b>${char.name}</b> <span class="trained-badge">í•™ìŠµìºë¦­í„°</span> â€” íŠ¸ë¦¬ê±°: <code>${char.trigger_word}</code>`;
            }
        }

        function openCreateTrainedCharModal() {
            const name = prompt('í•™ìŠµí•  ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!name) return;

            const trigger = prompt('íŠ¸ë¦¬ê±° ì›Œë“œ (ë¹ˆì¹¸ì´ë©´ ìë™ ìƒì„±):', '');
            const description = prompt('ìºë¦­í„° ì„¤ëª… (ì„ íƒ):', '');

            createTrainedCharacter(name, trigger || '', description || '');
        }

        async function createTrainedCharacter(name, triggerWord, description) {
            try {
                const resp = await fetch('/api/training/characters/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        trigger_word: triggerWord,
                        description,
                        style_tags: []
                    })
                });
                const data = await resp.json();
                if (data.success) {
                    alert(`ìºë¦­í„° "${name}" ìƒì„± ì™„ë£Œ! ì´ì œ í•™ìŠµ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.`);
                    // ì´ë¯¸ì§€ ì—…ë¡œë“œ í”„ë¡¬í”„íŠ¸
                    uploadTrainingImages(data.character.id);
                }
            } catch (e) {
                alert('ìºë¦­í„° ìƒì„± ì‹¤íŒ¨: ' + e.message);
            }
        }

        function uploadTrainingImages(charId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const files = e.target.files;
                if (!files.length) return;

                const formData = new FormData();
                for (const f of files) {
                    formData.append('files', f);
                }

                try {
                    const resp = await fetch(`/api/training/characters/${charId}/upload-images`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();
                    if (data.success) {
                        alert(`${data.uploaded_count}ì¥ ì—…ë¡œë“œ ì™„ë£Œ! (ì´ ${data.total_images}ì¥)\n\nìµœì†Œ 5ì¥ ì´ìƒ ì—…ë¡œë“œ í›„ í•™ìŠµì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);

                        // 5ì¥ ì´ìƒì´ë©´ í•™ìŠµ ì‹œì‘ ì—¬ë¶€ í™•ì¸
                        if (data.total_images >= 5) {
                            if (confirm(`ì´ë¯¸ì§€ ${data.total_images}ì¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìŠµì„ ì‹œì‘í• ê¹Œìš”?\n(ì•½ 15~30ë¶„ ì†Œìš”)`)) {
                                startTraining(charId);
                            }
                        }
                        loadTrainedCharacters();
                    }
                } catch (e) {
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
                }
            };
            input.click();
        }

        async function startTraining(charId) {
            try {
                const resp = await fetch('/api/training/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        character_id: charId,
                        steps: 1000
                    })
                });
                const data = await resp.json();
                if (data.success) {
                    alert(`í•™ìŠµ ì‹œì‘! (íŠ¸ë¦¬ê±°: ${data.trigger_word}, ì´ë¯¸ì§€: ${data.image_count}ì¥)\n\ní•™ìŠµì€ ì•½ 15~30ë¶„ ì†Œìš”ë©ë‹ˆë‹¤. ìƒíƒœë¥¼ ìë™ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.`);
                    pollTrainingStatus(charId);
                    loadTrainedCharacters();
                } else {
                    alert('í•™ìŠµ ì‹œì‘ ì‹¤íŒ¨: ' + (data.detail || ''));
                }
            } catch (e) {
                alert('í•™ìŠµ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function pollTrainingStatus(charId) {
            const poll = async () => {
                try {
                    const resp = await fetch('/api/training/status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ character_id: charId })
                    });
                    const data = await resp.json();

                    if (data.status === 'completed') {
                        alert(`í•™ìŠµ ì™„ë£Œ! ğŸ‰\nì´ì œ ì´ ìºë¦­í„°ë¥¼ ì„ íƒí•˜ê³  ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                        loadTrainedCharacters();
                        return;
                    } else if (data.status === 'failed') {
                        alert(`í•™ìŠµ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                        loadTrainedCharacters();
                        return;
                    }

                    // ì•„ì§ ì§„í–‰ ì¤‘ â€” 30ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸
                    loadTrainedCharacters();
                    setTimeout(poll, 30000);
                } catch (e) {
                    console.error('í•™ìŠµ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', e);
                    setTimeout(poll, 30000);
                }
            };
            setTimeout(poll, 10000); // 10ì´ˆ í›„ ì²« í™•ì¸
        }

        function addMoreTrainingImages(charId) {
            uploadTrainingImages(charId);
        }

        async function viewTrainingImages(charId) {
            // ìºë¦­í„° ìƒì„¸ ì •ë³´ì—ì„œ ì´ë¯¸ì§€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            try {
                const resp = await fetch(`/api/training/characters/${charId}`);
                const char = await resp.json();
                const images = char.training_images || [];

                if (images.length === 0) {
                    alert('ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê°„ë‹¨í•œ ëª¨ë‹¬ë¡œ ì´ë¯¸ì§€ í‘œì‹œ
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

                const modal = document.createElement('div');
                modal.style.cssText = 'background:var(--bg-card,#1e1e2e);border-radius:12px;padding:1.5rem;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;';

                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                        <h3 style="margin:0;color:var(--text,#fff);">ğŸ“· í•™ìŠµ ì´ë¯¸ì§€ (${images.length}ì¥) â€” ${char.name}</h3>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;color:var(--text-muted,#888);font-size:1.5rem;cursor:pointer;">&times;</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;">
                `;

                images.forEach((imgPath, i) => {
                    html += `
                        <div style="position:relative;border-radius:8px;overflow:hidden;border:1px solid var(--border,#333);">
                            <img src="/${imgPath}" style="width:100%;height:120px;object-fit:cover;display:block;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%2250%25%22 x=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 font-size=%2240%22>ğŸ–¼</text></svg>'">
                            <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.6);color:#fff;font-size:0.65rem;padding:2px 6px;text-align:center;">${i + 1}ë²ˆ</div>
                        </div>`;
                });

                html += `</div>
                    <div style="display:flex;gap:0.5rem;margin-top:1rem;justify-content:flex-end;">
                        <button class="btn btn-sm btn-primary" onclick="this.closest('div[style*=fixed]').remove(); uploadTrainingImages('${charId}')">+ ì´ë¯¸ì§€ ì¶”ê°€</button>
                        <button class="btn btn-sm btn-outline" onclick="this.closest('div[style*=fixed]').remove(); clearTrainingImages('${charId}')">ğŸ—‘ ì „ì²´ ì‚­ì œ</button>
                        <button class="btn btn-sm btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">ë‹«ê¸°</button>
                    </div>`;

                modal.innerHTML = html;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

            } catch (e) {
                alert('ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function clearTrainingImages(charId) {
            if (!confirm('ì´ ìºë¦­í„°ì˜ í•™ìŠµ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
            try {
                await fetch(`/api/training/characters/${charId}/images`, { method: 'DELETE' });
                alert('ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadTrainedCharacters();
            } catch (e) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function deleteTrainedChar(charId) {
            if (!confirm('ì´ í•™ìŠµ ìºë¦­í„°ë¥¼ ì‚­ì œí• ê¹Œìš”? í•™ìŠµ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;
            try {
                await fetch(`/api/training/characters/${charId}`, { method: 'DELETE' });
                if (selectedTrainedChar === charId) selectedTrainedChar = null;
                loadTrainedCharacters();
            } catch (e) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        // ì´ë¯¸ì§€ ìƒì„± ì‹œ í•™ìŠµ ìºë¦­í„° ì •ë³´ë¥¼ ì „ë‹¬í•˜ë„ë¡ ê¸°ì¡´ startImageGeneration í™•ì¥
        // (workflow.pyì˜ generate-images ì—”ë“œí¬ì¸íŠ¸ì— lora ì •ë³´ ì „ë‹¬)
        const _origGetImageModel = () => document.getElementById('image-model')?.value || 'flux-kontext-dev';

    </script>

    <!-- Style Manager Modal -->
    <div id="style-manager-modal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content modal-content-dark"
            style="padding: 0; border-radius: 8px; width: 800px; max-width: 95%; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header modal-header-dark"
                style="padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;" id="style-modal-title">ìŠ¤íƒ€ì¼ ê´€ë¦¬</h3>
                <button class="btn btn-sm btn-secondary" onclick="closeStyleManager()">ë‹«ê¸°</button>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex;">
                <!-- Left: List -->
                <div class="style-list-dark"
                    style="width: 300px; padding-right: 1rem; display: flex; flex-direction: column;">
                    <button class="btn btn-primary" style="margin-bottom: 1rem;" onclick="showCreateStyleForm()">+ ìƒˆ ìŠ¤íƒ€ì¼
                        ì¶”ê°€</button>
                    <div id="style-list" style="flex: 1; overflow-y: auto;">
                        <div style="padding: 1rem; text-align: center; color: var(--text-muted);">Loading...</div>
                    </div>
                </div>

                <!-- Right: Details / Form -->
                <div style="flex: 1; padding-left: 1rem;">
                    <!-- View Details Mode -->
                    <div id="style-detail-view" style="display: none;">
                        <h4 id="detail-name" style="margin-top: 0;">Style Name</h4>
                        <div id="detail-preview"
                            style="width: 100%; height: 200px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                            No Image
                        </div>
                        <p id="detail-prompt"
                            style="background: var(--bg-input); color: var(--text); padding: 1rem; border-radius: 4px; font-size: 0.9rem; max-height: 150px; overflow-y: auto; border: 1px solid var(--border);">
                        </p>
                        <div style="margin-top: 2rem; text-align: right;">
                            <button id="btn-select-style" class="btn btn-primary"
                                style="width:100%; padding:12px; font-size:1rem;" onclick="selectCurrentStyle()">ì´ ìŠ¤íƒ€ì¼
                                ì„ íƒ</button>
                        </div>
                        <div id="style-btn-container"></div>
                    </div>

                    <!-- Create/Edit Form Mode -->
                    <div id="style-form-view" style="display: none;">
                        <h3 id="style-form-title" style="margin-top:0;">ìƒˆ ìŠ¤íƒ€ì¼ ì¶”ê°€</h3>
                        <input type="hidden" id="style-form-id">

                        <!-- Extraction Option -->
                        <div
                            style="background: var(--bg-input); border: 1px solid var(--border); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h5 style="margin: 0 0 0.5rem 0;">ğŸ“¸ ì´ë¯¸ì§€ì—ì„œ ìŠ¤íƒ€ì¼ ì¶”ì¶œ (Vision AI)</h5>
                            <input type="file" id="extract-upload" accept="image/*" style="margin-bottom: 0.5rem;">
                            <button class="btn btn-sm btn-outline" onclick="extractStyleFromImage()">ë¶„ì„ ë° ìë™ ì…ë ¥</button>
                            <span id="extract-loading"
                                style="display: none; margin-left: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">ë¶„ì„
                                ì¤‘...</span>
                        </div>

                        <div class="form-group">
                            <label>ìŠ¤íƒ€ì¼ ì´ë¦„</label>
                            <input type="text" id="style-form-name" placeholder="ì˜ˆ: ë”°ëœ»í•œ ê°ì„± ì›¹íˆ°">
                        </div>
                        <div class="form-group">
                            <label>í”„ë¡¬í”„íŠ¸ (Prompt Block)</label>
                            <textarea id="style-form-prompt" rows="5" placeholder="ìŠ¤íƒ€ì¼ì„ ë¬˜ì‚¬í•˜ëŠ” í”„ë¡¬í”„íŠ¸..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>ëŒ€í‘œ ì´ë¯¸ì§€ ë“±ë¡ (ì„ íƒ, ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
                            <input type="file" id="style-form-image" accept="image/*" multiple>
                            <div id="style-form-image-help"
                                style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
                        </div>

                        <!-- Hidden Fields for JSON data -->
                        <input type="hidden" id="style-form-locked-attrs" value="[]">
                        <input type="hidden" id="style-form-visual-attrs" value="{}">

                        <div style="text-align: right; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="cancelCreateStyle()">ì·¨ì†Œ</button>
                            <button class="btn btn-primary" onclick="submitStyleForm()">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>